<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vienna Tourist Guide</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    h1{text-align:center;color:#764ba2;margin-bottom:30px;font-size:2.3em;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .map-container{height:500px;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2);margin-bottom:30px;position:relative}
    #map{height:100%;width:100%}
    .row{display:grid;grid-template-columns:2fr 1fr;gap:20px}
    @media(max-width:1000px){.row{grid-template-columns:1fr}}
    .section{background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 18px rgba(0,0,0,.08)}
    .section h3{margin-bottom:10px;color:#444}
    .categories{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:20px}
    .category-btn{padding:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:15px;font-weight:600;transition:.25s;box-shadow:0 5px 15px rgba(0,0,0,.15)}
    .category-btn:hover{transform:translateY(-2px)}
    .category-btn.active{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
    .places-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px;margin-top:10px}
    .place-card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,.1);transition:.25s}
    .place-card:hover{transform:translateY(-4px)}
    .place-image{width:100%;height:190px;object-fit:cover}
    .place-info{padding:16px}
    .place-name{font-size:1.15em;font-weight:700;color:#333;margin-bottom:8px}
    .place-description{color:#666;line-height:1.55;margin-bottom:12px;font-size:.95em}
    .detail{display:flex;align-items:center;gap:8px;color:#555;font-size:.9em;margin:6px 0}
    .distance-badge{display:inline-block;padding:4px 9px;background:#4CAF50;color:#fff;border-radius:12px;font-size:.8em;font-weight:700}
    .price-badge{display:inline-block;padding:4px 9px;background:#ff9800;color:#fff;border-radius:12px;font-size:.8em;font-weight:700}
    .free-badge{background:#4CAF50}
    .navigate-btn{width:100%;padding:10px;margin-top:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:.25s}
    .navigate-btn:hover{filter:brightness(1.05)}
    .hotel-info{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;padding:16px;border-radius:14px;margin-bottom:20px;box-shadow:0 10px 25px rgba(0,0,0,.18)}
    .search-bar{width:100%;padding:13px;border:2px solid #ddd;border-radius:10px;font-size:15px;margin-bottom:14px}
    .filter-options{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
    .chip{padding:7px 12px;background:#f0f0f0;border-radius:20px;cursor:pointer;border:2px solid transparent}
    .chip.active{background:#667eea;color:#fff;border-color:#764ba2}
    .sort-options{display:flex;gap:10px;margin-bottom:14px;align-items:center}
    .sort-btn{padding:7px 12px;background:#fff;border:2px solid #667eea;border-radius:20px;cursor:pointer;font-size:14px}
    .sort-btn.active{background:#667eea;color:#fff}
    .location-btn{position:absolute;top:10px;right:10px;z-index:1000;background:#fff;border:2px solid #667eea;border-radius:50%;width:40px;height:40px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .location-status{padding:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:10px;margin:12px 0;display:none;align-items:center;gap:10px}
    .location-status.active{display:flex}
    .modal{display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.7)}
    .modal-content{background:#fff;margin:5% auto;padding:24px;border-radius:18px;width:90%;max-width:600px;position:relative}
    .close{position:absolute;right:16px;top:10px;font-size:28px;cursor:pointer;color:#999}
    .tip{font-size:.9em;color:#666}
    .airtag-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.airtag-grid{grid-template-columns:1fr}}
    .btn{padding:10px 12px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
    .btn-primary{background:#0b73ff;color:#fff}
    .btn-outline{background:#fff;border:2px solid #0b73ff;color:#0b73ff}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(102,126,234,.7)}70%{box-shadow:0 0 0 10px rgba(102,126,234,0)}100%{box-shadow:0 0 0 0 rgba(102,126,234,0)}}
  </style>
</head>
<body>
  <div class="container">
    <h1>üèõÔ∏è Vienna Tourist Guide üá¶üáπ</h1>

    <div class="hotel-info">
      <h2>üìç Il Tuo Hotel</h2>
      <p><strong>Boutique Hotel Das Tigra</strong></p>
      <p>Tiefer Graben 14-20, 1010 Wien</p>
      <p>‚≠ê‚≠ê‚≠ê‚≠ê Hotel boutique nel centro storico di Vienna</p>
    </div>

    <div class="map-container">
      <div id="map"></div>
      <button class="location-btn" id="locationBtn" title="La mia posizione">üìç</button>
    </div>

    <div class="row">
      <!-- Colonna sinistra -->
      <div class="section">
        <div class="location-status" id="locationStatus">
          <span>üì° Geolocalizzazione attiva ‚Äî posizione aggiornata in tempo reale</span>
        </div>

        <input type="text" class="search-bar" placeholder="üîç Cerca monumenti, ristoranti, attrazioni..." id="searchBar">

        <div class="sort-options">
          <span style="font-weight:bold;">Ordina per:</span>
          <button class="sort-btn active" data-sort="default">Default</button>
          <button class="sort-btn" data-sort="distance">Distanza da me</button>
          <button class="sort-btn" data-sort="name">Nome A-Z</button>
        </div>

        <div class="filter-options">
          <div class="chip" data-filter="free">Gratuito</div>
          <div class="chip" data-filter="paid">A pagamento</div>
          <div class="chip" data-filter="walking">&lt; 500m a piedi</div>
          <div class="chip" data-filter="transport">&gt; 500m trasporti</div>
        </div>

        <div class="categories" id="categoriesBar">
          <button class="category-btn active" data-category="monuments">üèõÔ∏è Monumenti</button>
          <button class="category-btn" data-category="museums">üé® Musei</button>
          <button class="category-btn" data-category="restaurants">üçΩÔ∏è Ristoranti</button>
          <button class="category-btn" data-category="fastfood">üçî Fast Food</button>
          <button class="category-btn" data-category="parks">üå≥ Parchi</button>
          <button class="category-btn" data-category="shopping">üõçÔ∏è Shopping</button>
          <button class="category-btn" data-category="attractions" id="btnAttractions">‚ú® Attrazioni (OSM)</button>
          <button class="category-btn" id="btnLoadAttractions">‚§µÔ∏è Carica altre attrazioni</button>
        </div>

        <div class="places-grid" id="placesGrid"></div>
      </div>

      <!-- Colonna destra: AirTag -->
      <div class="section">
        <h3>üéØ Pannello AirTag / Oggetto</h3>
        <p class="tip">
          Gli AirTag non espongono API web: questo pannello permette di <b>aprire Dov‚Äô√®</b> su iOS
          e di <b>navigare</b> verso coordinate note dell‚Äôoggetto (se le conosci).
        </p>

        <div style="display:flex;gap:10px;margin:10px 0;">
          <button class="btn btn-primary" id="btnOpenFindMy">Apri Dov‚Äô√® (iOS)</button>
          <button class="btn btn-outline" id="btnFindMyHelp">Cos‚Äô√® questo?</button>
        </div>

        <hr style="margin:12px 0;">

        <h4>üìå Coordinate note dell‚Äôoggetto (facoltative)</h4>
        <div class="airtag-grid" style="margin-top:8px;">
          <input id="tagName" class="search-bar" placeholder="Nome oggetto (es. Zaino, Valigia)">
          <input id="tagLat"  class="search-bar" placeholder="Latitudine (es. 48.20849)">
          <input id="tagLng"  class="search-bar" placeholder="Longitudine (es. 16.37312)">
          <div style="display:flex;gap:10px;">
            <button class="btn btn-primary" id="btnSaveTag">Salva</button>
            <button class="btn" id="btnUseMyPos">Usa mia posizione</button>
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px;">
          <button class="btn" id="btnOpenAppleMaps">Apri in Apple Maps</button>
          <button class="btn" id="btnOpenGoogleMaps">Apri in Google Maps</button>
        </div>

        <p id="tagSavedInfo" class="tip" style="margin-top:8px;"></p>
      </div>
    </div>
  </div>

  <!-- Modal navigazione -->
  <div id="navigationModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalTitle">Navigazione</h2>
      <div id="modalBody"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ====== Config geolocalizzazione / follow ======
    let autoFollow = true;   // la mappa segue sempre la tua posizione
    let userCircle = null;   // cerchio di accuratezza GPS

    // ====== Dati hotel ======
    const hotelLocation = {
      lat: 48.216837,
      lng: 16.345621,
      name: "Boutique Hotel Das Tigra",
      address: "Tiefer Graben 14-20, 1010 Wien"
    };

    // ====== Database + categoria dinamica ======
    const places = {
      monuments: [
        { name:"Palazzo di Sch√∂nbrunn", description:"Residenza imperiale barocca con 1.441 stanze, patrimonio UNESCO. Giardini magnifici e zoo.", image:"https://images.unsplash.com/photo-1516550893923-42d28e5677af?w=400", lat:48.184517, lng:16.312148, price:"‚Ç¨16", hours:"8:30-17:30", distance:0 },
        { name:"Cattedrale di Santo Stefano", description:"Simbolo di Vienna, cattedrale gotica del XII secolo con torre alta 136 metri.", image:"https://images.unsplash.com/photo-1609856878074-cf31e21ccb6b?w=400", lat:48.208492, lng:16.373119, price:"Gratuito (Torre ‚Ç¨6)", hours:"6:00-22:00", distance:0 },
        { name:"Hofburg", description:"Complesso imperiale con musei, biblioteca nazionale e scuola di equitazione spagnola.", image:"https://images.unsplash.com/photo-1559128010-7c1ad6e1b6a5?w=400", lat:48.206507, lng:16.365262, price:"‚Ç¨15", hours:"9:00-17:30", distance:0 },
        { name:"Belvedere", description:"Complesso barocco con due palazzi e giardini. Ospita 'Il Bacio' di Klimt.", image:"https://images.unsplash.com/photo-1583225173839-59b4e437f4d4?w=400", lat:48.191567, lng:16.380995, price:"‚Ç¨16", hours:"10:00-18:00", distance:0 },
        { name:"Prater e Ruota Panoramica", description:"Parco divertimenti storico con l'iconica ruota panoramica del 1897.", image:"https://images.unsplash.com/photo-1570168007204-dfb528c6958f?w=400", lat:48.216571, lng:16.395776, price:"‚Ç¨13.50", hours:"10:00-22:00", distance:0 },
        { name:"Opera di Stato di Vienna", description:"Uno dei teatri d'opera pi√π importanti al mondo, inaugurato nel 1869.", image:"https://images.unsplash.com/photo-1544320824-8db57da2fa97?w=400", lat:48.203001, lng:16.369002, price:"Tour ‚Ç¨13", hours:"Tour: 10:00-15:00", distance:0 },
        { name:"Palazzo del Parlamento", description:"Edificio neoclassico sede del Parlamento austriaco con statue greche.", image:"https://images.unsplash.com/photo-1548802673-5abd0ff47c09?w=400", lat:48.207788, lng:16.357613, price:"Tour gratuito", hours:"Lun-Sab con prenotazione", distance:0 },
        { name:"Rathaus (Municipio)", description:"Imponente municipio neogotico con torre di 98 metri e piazza per eventi.", image:"https://images.unsplash.com/photo-1580836507615-96f7f7950e3b?w=400", lat:48.210577, lng:16.357420, price:"Gratuito", hours:"Tour Lun, Mer, Ven 13:00", distance:0 }
      ],
      museums: [
        { name:"Kunsthistorisches Museum", description:"Uno dei musei d'arte pi√π importanti al mondo con opere di Raffaello, Vermeer, Vel√°zquez.", image:"https://images.unsplash.com/photo-1566127444979-b3d2b654e3d7?w=400", lat:48.203551, lng:16.361587, price:"‚Ç¨21", hours:"10:00-18:00 (Gio fino 21:00)", distance:0 },
        { name:"Albertina", description:"Collezione grafica pi√π grande al mondo con opere di Monet, Picasso, Klimt.", image:"https://images.unsplash.com/photo-1583037189850-1921ae7c6c22?w=400", lat:48.204731, lng:16.368438, price:"‚Ç¨18.90", hours:"10:00-18:00 (Mer, Ven fino 21:00)", distance:0 },
        { name:"Museo di Storia Naturale", description:"30 milioni di oggetti esposti inclusi dinosauri e la Venere di Willendorf.", image:"https://images.unsplash.com/photo-1613414969929-491c9c779910?w=400", lat:48.205268, lng:16.359989, price:"‚Ç¨16", hours:"9:00-18:00 (Mer fino 20:00)", distance:0 },
        { name:"MAK - Museo Arti Applicate", description:"Design, architettura e arte contemporanea. Collezione unica di Wiener Werkst√§tte.", image:"https://images.unsplash.com/photo-1541367777708-c1ccbfb0e6d5?w=400", lat:48.207395, lng:16.381705, price:"‚Ç¨15", hours:"10:00-18:00 (Mar fino 21:00)", distance:0 }
      ],
      restaurants: [
        { name:"Figlm√ºller", description:"Famoso per la schnitzel pi√π grande di Vienna, tradizione dal 1905.", image:"https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400", lat:48.208765, lng:16.374526, price:"‚Ç¨‚Ç¨‚Ç¨", hours:"11:00-22:30", distance:0 },
        { name:"Caf√© Central", description:"Storico caff√® viennese frequentato da Freud e Trotsky. Torte imperiali.", image:"https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=400", lat:48.210372, lng:16.365063, price:"‚Ç¨‚Ç¨", hours:"7:30-22:00", distance:0 },
        { name:"Plachutta Wollzeile", description:"Specialit√†: Tafelspitz (bollito di manzo), cucina tradizionale austriaca.", image:"https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400", lat:48.208492, lng:16.376798, price:"‚Ç¨‚Ç¨‚Ç¨", hours:"11:30-23:00", distance:0 },
        { name:"Zum Schwarzen Kameel", description:"Dal 1618, ristorante Art Nouveau con specialit√† austriache e wine bar.", image:"https://images.unsplash.com/photo-1550966871-3ed3cdb5ed0c?w=400", lat:48.210833, lng:16.367778, price:"‚Ç¨‚Ç¨‚Ç¨‚Ç¨", hours:"8:00-24:00", distance:0 },
        { name:"Caf√© Sacher", description:"Casa della torta Sachertorte originale, elegante caff√® dal 1876.", image:"https://images.unsplash.com/photo-1550916478-59a58fe5e873?w=400", lat:48.203889, lng:16.369444, price:"‚Ç¨‚Ç¨‚Ç¨", hours:"8:00-24:00", distance:0 }
      ],
      fastfood: [
        { name:"McDonald's Stephansplatz", description:"McDonald's nel cuore di Vienna, vicino alla cattedrale.", image:"https://images.unsplash.com/photo-1552895638-f7fe08d2f7d5?w=400", lat:48.208556, lng:16.373139, price:"‚Ç¨", hours:"6:00-1:00 (Ven-Sab fino 3:00)", distance:0 },
        { name:"McDonald's Hauptbahnhof", description:"Grande McDonald's nella stazione centrale.", image:"https://images.unsplash.com/photo-1552895638-f7fe08d2f7d5?w=400", lat:48.185252, lng:16.377482, price:"‚Ç¨", hours:"24 ore", distance:0 },
        { name:"McDonald's Praterstern", description:"Vicino al Prater e alla ruota panoramica.", image:"https://images.unsplash.com/photo-1552895638-f7fe08d2f7d5?w=400", lat:48.218765, lng:16.391944, price:"‚Ç¨", hours:"24 ore", distance:0 },
        { name:"Burger King Mariahilferstra√üe", description:"Via principale dello shopping.", image:"https://images.unsplash.com/photo-1571091718767-18b5b1457add?w=400", lat:48.196389, lng:16.340556, price:"‚Ç¨", hours:"8:00-24:00", distance:0 },
        { name:"Burger King Wien Mitte", description:"Nel mall Wien Mitte.", image:"https://images.unsplash.com/photo-1571091718767-18b5b1457add?w=400", lat:48.205833, lng:16.384167, price:"‚Ç¨", hours:"9:00-23:00", distance:0 }
      ],
      parks: [
        { name:"Stadtpark", description:"Parco con statua dorata di Johann Strauss.", image:"https://images.unsplash.com/photo-1590682244746-d7b27e6a5c9b?w=400", lat:48.204722, lng:16.378611, price:"Gratuito", hours:"Sempre aperto", distance:0 },
        { name:"Volksgarten", description:"Giardino delle rose con oltre 3000 rosai.", image:"https://images.unsplash.com/photo-1559128019-7c1dd7c9eefd?w=400", lat:48.207778, lng:16.361111, price:"Gratuito", hours:"Sempre aperto", distance:0 },
        { name:"Augarten", description:"Parco barocco con torre antiaerea.", image:"https://images.unsplash.com/photo-1589207821092-9ce3f6132eb9?w=400", lat:48.226111, lng:16.380278, price:"Gratuito", hours:"Sempre aperto", distance:0 }
      ],
      shopping: [
        { name:"Graben & Kohlmarkt", description:"Shopping di lusso.", image:"https://images.unsplash.com/photo-1520176501380-c1d889d43cd5?w=400", lat:48.208889, lng:16.369444, price:"N/D", hours:"10:00-19:00", distance:0 },
        { name:"Mariahilfer Stra√üe", description:"Via commerciale pi√π lunga (1.8 km).", image:"https://images.unsplash.com/photo-1472851294608-062f824d29cc?w=400", lat:48.196944, lng:16.340278, price:"N/D", hours:"10:00-20:00", distance:0 }
      ],
      attractions: [] // caricamento dinamico OSM
    };

    // ====== Stato & mappa ======
    let map, markers = [], currentCategory = 'monuments';
    let userMarker = null, userLocation = null, watchId = null, currentSort = 'default';

    function initMap(){
      map = L.map('map').setView([hotelLocation.lat, hotelLocation.lng], 14);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'¬© OpenStreetMap contributors'
      }).addTo(map);

      const hotelIcon = L.divIcon({
        html:'<div style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;padding:8px;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 3px 10px rgba(0,0,0,.3);">üè®</div>',
        iconSize:[40,40], iconAnchor:[20,20]
      });

      L.marker([hotelLocation.lat, hotelLocation.lng], {icon:hotelIcon})
        .addTo(map)
        .bindPopup(`<strong>${hotelLocation.name}</strong><br>${hotelLocation.address}`)
        .openPopup();

      initGeolocation();
    }

    function initGeolocation(){
      if("geolocation" in navigator){
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy); startLocationTracking(); },
          (err)=>{ console.log("Geo negata/non disponibile:", err); },
          { enableHighAccuracy:true }
        );
      }
    }

    function startLocationTracking(){
      if("geolocation" in navigator){
        watchId = navigator.geolocation.watchPosition(
          (pos)=>updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy),
          (err)=>console.error("Errore tracking:", err),
          { enableHighAccuracy:true, timeout:5000, maximumAge:0 }
        );
        document.getElementById('locationStatus').classList.add('active');
        document.getElementById('locationBtn').classList.add('active');
      }
    }

    // >>> AGGIORNATA: sempre visibile/centrata + cerchio di accuratezza
    function updateUserLocation(lat, lng, accuracy){
      userLocation = { lat, lng };

      // Marker utente
      if (userMarker) map.removeLayer(userMarker);
      const userIcon = L.divIcon({
        html:`<div style="position:relative;">
                <div style="background:#2196F3;border:3px solid #fff;border-radius:50%;width:20px;height:20px;box-shadow:0 2px 5px rgba(0,0,0,.3);"></div>
                <div style="position:absolute;top:-5px;left:-5px;width:30px;height:30px;border:2px solid #2196F3;border-radius:50%;opacity:.3;animation:pulse 2s infinite;"></div>
              </div>`,
        iconSize:[30,30], iconAnchor:[15,15]
      });
      userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(map).bindPopup("<strong>La tua posizione</strong>");
      if (userMarker && userMarker._icon) userMarker._icon.style.zIndex = 10000;

      // Cerchio di accuratezza
      if (userCircle) map.removeLayer(userCircle);
      if (Number.isFinite(accuracy)) {
        userCircle = L.circle([lat, lng], {
          radius: Math.max(accuracy, 15),
          color: '#2196F3',
          fillColor: '#2196F3',
          fillOpacity: 0.15,
          weight: 1
        }).addTo(map);
      }

      // Segui sempre la posizione
      if (autoFollow) {
        const targetZoom = Math.max(map.getZoom(), 15);
        map.setView([lat, lng], targetZoom, { animate: false });
      }

      // Distanze/lista
      updateDistancesFromUser();
      if (currentSort === 'distance') {
        renderPlaces(currentCategory, document.getElementById('searchBar').value);
      }
    }

    function centerOnUser(){
      if(userLocation){
        map.setView([userLocation.lat, userLocation.lng], Math.max(map.getZoom(), 15));
        if(userMarker) userMarker.openPopup();
      } else if("geolocation" in navigator){
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy); map.setView([pos.coords.latitude, pos.coords.longitude], 16); startLocationTracking(); },
          ()=>alert("Abilita la geolocalizzazione nel browser")
        );
      }
    }

    function calculateDistance(lat1,lon1,lat2,lon2){
      const R = 6371e3;
      const œÜ1 = lat1*Math.PI/180, œÜ2 = lat2*Math.PI/180;
      const ŒîœÜ = (lat2-lat1)*Math.PI/180, ŒîŒª = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }

    function updateDistances(){
      Object.keys(places).forEach(cat=>{
        places[cat].forEach(p=>{
          p.distance = Math.round(calculateDistance(hotelLocation.lat, hotelLocation.lng, p.lat, p.lng));
        });
      });
    }

    function updateDistancesFromUser(){
      if(!userLocation) return;
      Object.keys(places).forEach(cat=>{
        places[cat].forEach(p=>{
          p.distanceFromUser = Math.round(calculateDistance(userLocation.lat, userLocation.lng, p.lat, p.lng));
        });
      });
    }

    function showPlacesOnMap(category){
      markers.forEach(m=>map.removeLayer(m));
      markers = [];
      const categoryEmojis = { monuments:'üèõÔ∏è', museums:'üé®', restaurants:'üçΩÔ∏è', fastfood:'üçî', parks:'üå≥', shopping:'üõçÔ∏è', attractions:'‚ú®' };

      (places[category]||[]).forEach(place=>{
        let emoji = categoryEmojis[category];
        let bg = 'linear-gradient(135deg,#667eea 0%,#764ba2 100%)';
        if(category==='fastfood'){
          if(place.name.toLowerCase().includes('mcdonald')){ emoji='M'; bg='linear-gradient(135deg,#FFC600 0%,#FF0000 100%)'; }
          else if(place.name.toLowerCase().includes('burger king')){ emoji='BK'; bg='linear-gradient(135deg,#FF6900 0%,#8B4513 100%)'; }
        }
        const icon = L.divIcon({
          html:`<div style="background:${bg};color:#fff;padding:5px;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:${emoji.length>1?'10px':'16px'};font-weight:bold;box-shadow:0 2px 6px rgba(0,0,0,.3);">${emoji}</div>`,
          iconSize:[30,30], iconAnchor:[15,15]
        });

        const marker = L.marker([place.lat, place.lng], {icon})
          .addTo(map)
          .bindPopup(`
            <strong>${place.name}</strong><br>
            ${place.description ? place.description.substring(0,100) : ''}...<br>
            <strong>Distanza:</strong> ${place.distance ?? '-'} m<br>
            <strong>Prezzo:</strong> ${place.price ?? '-'}<br>
            <strong>Orari:</strong> ${place.hours ?? '-'}
          `);
        markers.push(marker);
      });
    }

    function renderPlaces(category, searchTerm='', filters=[]){
      const grid = document.getElementById('placesGrid');
      let list = places[category] || [];

      if(searchTerm){
        const s = searchTerm.toLowerCase();
        list = list.filter(p => (p.name||'').toLowerCase().includes(s) || (p.description||'').toLowerCase().includes(s));
      }

      if(filters.length){
        list = list.filter(p=>{
          let pass = true;
          filters.forEach(f=>{
            if(f==='free' && !(p.price||'').toLowerCase().includes('gratuito')) pass=false;
            if(f==='paid' && (p.price||'').toLowerCase().includes('gratuito')) pass=false;
            if(f==='walking' && (p.distance ?? 999999) > 500) pass=false;
            if(f==='transport' && (p.distance ?? 0) <= 500) pass=false;
          });
          return pass;
        });
      }

      if(currentSort==='distance' && userLocation){
        list.sort((a,b)=> (a.distanceFromUser??999999)-(b.distanceFromUser??999999));
      }else if(currentSort==='name'){
        list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      }

      grid.innerHTML = list.map(place=>{
        const useUserLocation = !!userLocation && currentSort==='distance';
        const currentDistance = useUserLocation ? (place.distanceFromUser ?? place.distance) : place.distance;
        const transportType = (currentDistance<=500) ? 'üö∂ A piedi' : 'üöá Mezzi pubblici';
        const transportColor = (currentDistance<=500) ? '#4CAF50' : '#2196F3';
        const priceClass = (place.price||'').toLowerCase().includes('gratuito') ? 'free-badge' : '';

        let distanceInfo = (place.distance!=null) ? `${place.distance}m dall'hotel` : '-';
        if(userLocation && place.distanceFromUser!==undefined){
          distanceInfo += ` <span class="distance-badge" style="background:#2196F3;">üìç ${place.distanceFromUser}m da te</span>`;
        }

        return `
          <div class="place-card">
            <img src="${place.image||'https://images.unsplash.com/photo-1528909514045-2fa4ac7a08ba?w=400'}" alt="${place.name}" class="place-image">
            <div class="place-info">
              <div class="place-name">${place.name}</div>
              <div class="place-description">${place.description||''}</div>
              <div class="detail">üìç <span>${distanceInfo}</span></div>
              <div class="detail"><span class="distance-badge" style="background:${transportColor};">${transportType}</span></div>
              <div class="detail">üí∞ <span class="price-badge ${priceClass}">${place.price||'‚Äî'}</span></div>
              <div class="detail">üïê <span>${place.hours||'‚Äî'}</span></div>
              <button class="navigate-btn"
                onclick="showNavigationModal('${(place.name||'').replace(/'/g, "\\'")}', ${place.lat}, ${place.lng}, ${currentDistance||999999}, ${useUserLocation})">
                üìç Indicazioni Stradali
              </button>
            </div>
          </div>
        `;
      }).join('');

      if(!list.length){
        grid.innerHTML = '<div class="tip">Nessun risultato con i filtri attuali.</div>';
      }
    }

    // ====== Modal navigazione ======
    window.showNavigationModal = function(placeName, lat, lng, distance, fromUserLocation=false){
      const modal = document.getElementById('navigationModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      const startLat = (fromUserLocation && userLocation) ? userLocation.lat : hotelLocation.lat;
      const startLng = (fromUserLocation && userLocation) ? userLocation.lng : hotelLocation.lng;
      const startName = (fromUserLocation && userLocation) ? "la tua posizione" : hotelLocation.name;

      modalTitle.textContent = `Navigazione verso ${placeName}`;

      let html = '';
      if(distance <= 500){
        html = `
          <div class="navigation-options">
            <h3>üö∂ Percorso a piedi (${distance}m - ~${Math.round(distance/80)} min)</h3>
            <p class="tip">Partenza da: <strong>${startName}</strong></p>
            <div class="nav-option" onclick="openGoogleMaps(${lat}, ${lng}, 'walking', ${startLat}, ${startLng})"><h4>Google Maps - A piedi</h4></div>
            <div class="nav-option" onclick="openAppleMaps(${lat}, ${lng}, 'walking', ${startLat}, ${startLng})"><h4>Apple Maps - A piedi</h4></div>
          </div>`;
      } else {
        const walkingTime = Math.round(distance/80);
        const transitTime  = Math.round(distance/250);
        html = `
          <div class="navigation-options">
            <h3>üöá Mezzi pubblici consigliati (~${transitTime} min)</h3>
            <p class="tip">Partenza da: <strong>${startName}</strong></p>
            <div class="nav-option" onclick="openGoogleMaps(${lat}, ${lng}, 'transit', ${startLat}, ${startLng})"><h4>Google Maps - Mezzi pubblici</h4></div>
            <div class="nav-option" onclick="openWienerLinien(${lat}, ${lng}, ${startLat}, ${startLng})"><h4>Wiener Linien - Planner</h4></div>
            <div class="nav-option" onclick="openUber(${lat}, ${lng}, ${startLat}, ${startLng})"><h4>Uber / Taxi</h4></div>
            <hr style="margin:14px 0;border:1px solid #eee;">
            <h3>üö∂ Alternativa a piedi (~${walkingTime} min)</h3>
            <div class="nav-option" onclick="openGoogleMaps(${lat}, ${lng}, 'walking', ${startLat}, ${startLng})"><h4>Google Maps - A piedi</h4></div>
          </div>`;
      }

      modalBody.innerHTML = html;
      modal.style.display = 'block';
    };

    // ====== Apertura navigazione ======
    window.openGoogleMaps = function(lat, lng, mode, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const travelMode = (mode === 'walking') ? '2' : '3';
      const url = `https://www.google.com/maps/dir/${sLat},${sLng}/${lat},${lng}/@${lat},${lng},15z/data=!4m2!4m1!3e${travelMode}`;
      window.open(url, '_blank');
    };
    window.openAppleMaps = function(lat, lng, mode, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const dirflg = (mode === 'walking') ? 'w' : 'r';
      const url = `https://maps.apple.com/?saddr=${sLat},${sLng}&daddr=${lat},${lng}&dirflg=${dirflg}`;
      window.open(url, '_blank');
    };
    window.openWienerLinien = function(lat, lng, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const url = `https://www.wienerlinien.at/web/wl-en/journey-planner?from=${sLat},${sLng}&to=${lat},${lng}`;
      window.open(url, '_blank');
    };
    window.openUber = function(lat, lng, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const url = `https://m.uber.com/ul/?action=setPickup&pickup[latitude]=${sLat}&pickup[longitude]=${sLng}&dropoff[latitude]=${lat}&dropoff[longitude]=${lng}`;
      window.open(url, '_blank');
    };

    // ====== ATTRAZIONI DINAMICHE (Overpass/OSM) ======
    async function loadAttractionsFromOverpass(centerLat, centerLng, radiusMeters = 5000) {
      const endpoint = 'https://overpass-api.de/api/interpreter';
      const query = `
        [out:json][timeout:25];
        (
          node(around:${radiusMeters},${centerLat},${centerLng})["tourism"~"attraction|museum|gallery|viewpoint|theme_park"];
          way(around:${radiusMeters},${centerLat},${centerLng})["tourism"~"attraction|museum|gallery|viewpoint|theme_park"];
          relation(around:${radiusMeters},${centerLat},${centerLng})["tourism"~"attraction|museum|gallery|viewpoint|theme_park"];
        );
        out center tags 100;
      `;
      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'},
          body: 'data=' + encodeURIComponent(query)
        });
        const json = await res.json();
        const results = (json.elements||[]).map(el=>{
          const tags = el.tags||{};
          const name = tags.name || 'Attrazione';
          const lat = el.lat || (el.center && el.center.lat);
          const lng = el.lon || (el.center && el.center.lon);
          if (!lat || !lng) return null;

          const descParts = [];
          if (tags['tourism']) descParts.push(`#${tags['tourism']}`);
          if (tags['wikidata']) descParts.push(`Wikidata: ${tags['wikidata']}`);
          if (tags['wikipedia']) descParts.push(`Wikipedia: ${tags['wikipedia']}`);
          const description = tags.description || descParts.join(' ‚Ä¢ ') || 'Attrazione turistica';

          const hours = tags.opening_hours || "Orari non disponibili";
          const price = "‚Äî";
          const image = "https://images.unsplash.com/photo-1528909514045-2fa4ac7a08ba?w=400";

          return {
            name, description, image, lat, lng, price, hours,
            distance: Math.round(calculateDistance(hotelLocation.lat, hotelLocation.lng, lat, lng))
          };
        }).filter(Boolean);

        const key = p => `${(p.name||'').toLowerCase()}@${p.lat.toFixed(5)},${p.lng.toFixed(5)}`;
        const existing = new Set((places.attractions||[]).map(key));
        const fresh = results.filter(p => !existing.has(key(p)));

        places.attractions = [...(places.attractions||[]), ...fresh];

        if (currentCategory === 'attractions') {
          if (userLocation) updateDistancesFromUser();
          renderPlaces('attractions', document.getElementById('searchBar').value);
          showPlacesOnMap('attractions');
        }
        alert(`Caricate ${fresh.length} nuove attrazioni OSM.`);
      } catch (e) {
        console.error('Overpass error:', e);
        alert('Impossibile caricare attrazioni ora. Riprova pi√π tardi.');
      }
    }

    // ====== Eventi ======
    document.addEventListener('DOMContentLoaded', ()=>{
      initMap();
      updateDistances();
      renderPlaces('monuments');
      showPlacesOnMap('monuments');

      document.getElementById('locationBtn').addEventListener('click', centerOnUser);

      document.querySelectorAll('.category-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const cat = this.dataset.category;
          if(!cat) return;
          document.querySelectorAll('.category-btn').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          currentCategory = cat;
          renderPlaces(cat, document.getElementById('searchBar').value);
          showPlacesOnMap(cat);
        });
      });

      document.querySelectorAll('.sort-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          document.querySelectorAll('.sort-btn').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          currentSort = this.dataset.sort;
          if(currentSort==='distance' && !userLocation){ centerOnUser(); }
          renderPlaces(currentCategory, document.getElementById('searchBar').value);
        });
      });

      const activeFilters = [];
      document.getElementById('searchBar').addEventListener('input', e=>{
        renderPlaces(currentCategory, e.target.value, activeFilters);
      });
      document.querySelectorAll('.chip').forEach(chip=>{
        chip.addEventListener('click', function(){
          const f = this.dataset.filter;
          if(this.classList.contains('active')){
            this.classList.remove('active');
            const i = activeFilters.indexOf(f);
            if(i>-1) activeFilters.splice(i,1);
          }else{
            this.classList.add('active');
            activeFilters.push(f);
          }
          renderPlaces(currentCategory, document.getElementById('searchBar').value, activeFilters);
        });
      });

      document.getElementById('btnLoadAttractions').addEventListener('click', ()=>{
        const base = userLocation || hotelLocation;
        currentCategory = 'attractions';
        document.querySelectorAll('.category-btn').forEach(b=>{
          if(b.dataset.category) b.classList.toggle('active', b.dataset.category==='attractions');
        });
        loadAttractionsFromOverpass(base.lat, base.lng, 5000);
      });

      // Caricamento automatico iniziale (4km dall'hotel)
      loadAttractionsFromOverpass(hotelLocation.lat, hotelLocation.lng, 4000);

      // Modal chiudi
      document.querySelector('.close').addEventListener('click', ()=> {
        document.getElementById('navigationModal').style.display = 'none';
      });
      window.addEventListener('click', (e)=>{
        const modal = document.getElementById('navigationModal');
        if(e.target === modal){ modal.style.display = 'none'; }
      });

      // ====== PANNELLO AIRTAG ======
      const btnOpenFindMy = document.getElementById('btnOpenFindMy');
      const btnFindMyHelp = document.getElementById('btnFindMyHelp');
      const btnSaveTag = document.getElementById('btnSaveTag');
      const btnUseMyPos = document.getElementById('btnUseMyPos');
      const btnApple = document.getElementById('btnOpenAppleMaps');
      const btnGoogle = document.getElementById('btnOpenGoogleMaps');
      const tagName = document.getElementById('tagName');
      const tagLat  = document.getElementById('tagLat');
      const tagLng  = document.getElementById('tagLng');
      const tagInfo = document.getElementById('tagSavedInfo');

      const saved = JSON.parse(localStorage.getItem('savedTag') || 'null');
      if(saved){
        tagName.value = saved.name || '';
        tagLat.value  = saved.lat  ?? '';
        tagLng.value  = saved.lng  ?? '';
        tagInfo.textContent = `Salvato: ${saved.name||'-'} (${saved.lat}, ${saved.lng})`;
      }

      btnOpenFindMy.addEventListener('click', ()=>{
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if(isIOS){
          window.location.href = 'findmy://';
          setTimeout(()=>alert('Se Dov‚Äô√® non si √® aperta, aprila manualmente: Apple non offre link/API diretti per un AirTag specifico.'), 800);
        } else {
          alert('Il collegamento ‚ÄúDov‚Äô√®‚Äù √® disponibile solo su iOS. Usa l‚ÄôiPhone/iPad per aprire l‚Äôapp.');
        }
      });

      btnFindMyHelp.addEventListener('click', ()=>{
        alert('Gli AirTag non hanno API web: questo bottone prova solo ad aprire l‚Äôapp Dov‚Äô√® su iOS. Puoi salvare coordinate note e navigare l√¨.');
      });

      btnSaveTag.addEventListener('click', ()=>{
        const n = tagName.value.trim() || 'Oggetto';
        const la = parseFloat(tagLat.value);
        const ln = parseFloat(tagLng.value);
        if(Number.isFinite(la) && Number.isFinite(ln)){
          localStorage.setItem('savedTag', JSON.stringify({name:n, lat:la, lng:ln}));
          tagInfo.textContent = `Salvato: ${n} (${la}, ${ln})`;
          alert('Coordinate salvate.');
        } else {
          alert('Inserisci coordinate valide (lat/lng).');
        }
      });

      btnUseMyPos.addEventListener('click', ()=>{
        if(userLocation){
          tagLat.value = userLocation.lat.toFixed(6);
          tagLng.value = userLocation.lng.toFixed(6);
        } else {
          centerOnUser();
          alert('Posizione in acquisizione: riprova tra un attimo.');
        }
      });

      btnApple.addEventListener('click', ()=>{
        const la = parseFloat(tagLat.value), ln = parseFloat(tagLng.value);
        if(Number.isFinite(la) && Number.isFinite(ln)){
          const url = `https://maps.apple.com/?daddr=${la},${ln}&dirflg=d`;
          window.open(url, '_blank');
        } else alert('Inserisci coordinate valide.');
      });

      btnGoogle.addEventListener('click', ()=>{
        const la = parseFloat(tagLat.value), ln = parseFloat(tagLng.value);
        if(Number.isFinite(la) && Number.isFinite(ln)){
          const url = `https://www.google.com/maps/dir//${la},${ln}`;
          window.open(url, '_blank');
        } else alert('Inserisci coordinate valide.');
      });
    });

    window.addEventListener('resize', ()=>{ if(map) map.invalidateSize(); });
    window.addEventListener('beforeunload', ()=>{ if(watchId){ navigator.geolocation.clearWatch(watchId); }});
  </script>
</body>
</html>
