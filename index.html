<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vienna Tourist Guide ‚Äì Das Tigra</title>

<!-- Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Routing (per tracciare percorsi) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<!-- Stile -->
<style>
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);margin:0}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .card{background:#fff;border-radius:18px;box-shadow:0 14px 40px rgba(0,0,0,.18);overflow:hidden}
  header{padding:16px 20px;border-bottom:1px solid #eee;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  header h1{font-size:1.35rem;margin:0;color:#5b3fa5}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
  button,.btn{border:0;background:#6d5bd0;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
  button.secondary{background:#f0f0f5;color:#3d3a62}
  button:disabled{opacity:.55;cursor:not-allowed}
  .layout{display:grid;grid-template-columns:1.8fr 1fr;gap:14px;padding:14px}
  #map{height:70vh;min-height:420px;border-radius:14px}
  .sidebar{display:flex;flex-direction:column;gap:12px}
  .panel{background:#faf9ff;border:1px solid #ece9ff;border-radius:14px;padding:12px}
  .panel h2{font-size:1.05rem;margin:.2rem 0 .4rem;color:#5b3fa5}
  .poi-list{display:grid;gap:10px;max-height:42vh;overflow:auto;padding-right:6px}
  .poi{display:grid;grid-template-columns:64px 1fr;gap:10px;background:#fff;border:1px solid #eee;border-radius:12px;padding:8px}
  .poi img{width:64px;height:64px;object-fit:cover;border-radius:10px}
  .poi .name{font-weight:600}
  .small{font-size:.9rem;color:#5b5b6a}
  .tts{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tts select{padding:8px;border-radius:10px;border:1px solid #ddd}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#eee;color:#555;font-size:.75rem;margin-left:6px}
  .footer{padding:12px 16px;border-top:1px solid #eee;color:#666;font-size:.9rem}
  @media (max-width: 980px){ .layout{grid-template-columns:1fr; } #map{height:58vh} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>Vienna Tourist Guide ‚Ä¢ Boutique Hotel Das Tigra</h1>
      <div class="controls">
        <button id="locateBtn" class="secondary" title="Usa la mia posizione">üìç La mia posizione</button>
        <button id="toHotelBtn" title="Naviga verso l‚Äôhotel">üè® Torna all‚Äôhotel</button>
      </div>
    </header>

    <div class="layout">
      <div id="map"></div>

      <aside class="sidebar">
        <div class="panel">
          <h2>Guida vocale</h2>
          <div class="tts">
            <button id="playBtn">‚ñ∂Ô∏è Play</button>
            <button id="pauseBtn" class="secondary">‚è∏Ô∏è Pausa</button>
            <button id="resumeBtn" class="secondary">‚èØÔ∏è Riprendi</button>
            <button id="stopBtn" class="secondary">‚èπÔ∏è Stop</button>
            <select id="voiceSelect" title="Scegli voce"></select>
          </div>
          <div class="small">Suggerimento: scegli una voce <b>it-IT</b> o una voce neural/‚Äúenhanced‚Äù se disponibile sul tuo dispositivo per un suono pi√π naturale.</div>
        </div>

        <div class="panel">
          <h2>Punti d‚Äôinteresse <span class="badge">tocca per dettagli</span></h2>
          <div id="poiList" class="poi-list"></div>
        </div>

        <div class="panel">
          <h2>Navigazione rapida</h2>
          <div class="small">Seleziona un luogo sulla mappa o dalla lista e scegli ‚ÄúA piedi‚Äù (‚â§ 500 m) oppure ‚ÄúMezzi/Auto‚Äù (&gt; 500 m). Il tracciato appare sulla mappa; in alternativa apri Google Maps.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="routeFromMe" class="secondary">Da me ‚Üí luogo</button>
            <button id="routeFromHotel" class="secondary">Da hotel ‚Üí luogo</button>
            <a id="gmapsLink" class="btn" target="_blank" rel="noopener">Apri in Google Maps</a>
          </div>
        </div>
      </aside>
    </div>

    <div class="footer">
      Dati descrittivi: fonti Wikipedia/Belvedere (vedi link nella descrizione dei POI).
    </div>
  </div>
</div>

<script>
/* === CONFIG DI BASE ====================================================== */
const hotel = {
  name: "Boutique Hotel Das Tigra",
  lat: 48.21142,
  lng: 16.37058
};

// POI principali (coordinate, immagini, descrizione breve con fonte)
const POI = [
  {
    name: "Stephansdom (Cattedrale di Santo Stefano)",
    lat: 48.20849, lng: 16.37312,
    img: "https://upload.wikimedia.org/wikipedia/commons/thumb/7/79/Wien_-_Stephansdom_%281%29.JPG/320px-Wien_-_Stephansdom_%281%29.JPG",
    url: "https://en.wikipedia.org/wiki/St._Stephen%27s_Cathedral,_Vienna",
    desc: "Simbolo di Vienna, capolavoro romanico-gotico con tetto a tegole colorate; guglia sud ~136,7 m. Origini nel XII sec.; forma attuale completata nel XVI sec.",
    ticket: "Ingresso gratuito in navata; torri/tesoriere a pagamento."
  },
  {
    name: "Sch√∂nbrunn (Palazzo e Giardini)",
    lat: 48.18452, lng: 16.31218,
    img: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Schloss_Sch%C3%B6nbrunn_Wien_2014_%282%29.jpg/320px-Schloss_Sch%C3%B6nbrunn_Wien_2014_%282%29.jpg",
    url: "https://en.wikipedia.org/wiki/Sch%C3%B6nbrunn_Palace",
    desc: "Residenza estiva asburgica (1.441 stanze), sito UNESCO dal 1996; parterre, Gloriette, Tiergarten e Orangerie storica.",
    ticket: "Museo a pagamento; parco in gran parte libero."
  },
  {
    name: "Hofburg (Palazzo Imperiale)",
    lat: 48.20655, lng: 16.36400,
    img: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/Hofburg_-_Michaelertrakt.JPG/320px-Hofburg_-_Michaelertrakt.JPG",
    url: "https://en.wikipedia.org/wiki/Hofburg",
    desc: "Dal XIII sec. sede degli Asburgo; oggi include Appartamenti Imperiali, Museo di Sisi e Biblioteca Nazionale; sede del Presidente federale.",
    ticket: "Musei a pagamento; corti esterne libere."
  },
  {
    name: "Belvedere (Il Bacio di Klimt)",
    lat: 48.19136, lng: 16.38087,
    img: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Schloss_Belvedere%2C_Wien.jpg/320px-Schloss_Belvedere%2C_Wien.jpg",
    url: "https://en.wikipedia.org/wiki/The_Kiss_(Klimt)",
    desc: "Il capolavoro ‚ÄòIl Bacio‚Äô (1907‚Äì08) √® esposto all‚Äô√ñsterreichische Galerie Belvedere (Belvedere Superiore).",
    ticket: "Museo a pagamento; giardini in parte liberi."
  },
  {
    name: "MuseumsQuartier",
    lat: 48.20343, lng: 16.35986,
    img: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/MuseumsQuartier_Leopold_Museum.jpg/320px-MuseumsQuartier_Leopold_Museum.jpg",
    url: "https://www.mqw.at/en",
    desc: "Grande polo culturale con Leopold Museum, mumok e spazi creativi.",
    ticket: "Musei a pagamento; corti libere."
  },
  {
    name: "Prater & Ruota panoramica",
    lat: 48.21667, lng: 16.39750,
    img: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3b/Wiener_Riesenrad_2005.jpg/320px-Wiener_Riesenrad_2005.jpg",
    url: "https://en.wikipedia.org/wiki/Wiener_Riesenrad",
    desc: "Parco storico con la Riesenrad (1897) icona della citt√†.",
    ticket: "Ingresso al parco libero; attrazioni a pagamento."
  },
  {
    name: "Hundertwasserhaus",
    lat: 48.20704, lng: 16.39454,
    img: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Hundertwasserhaus_Vienna.jpg/320px-Hundertwasserhaus_Vienna.jpg",
    url: "https://en.wikipedia.org/wiki/Hundertwasserhaus",
    desc: "Residenza variopinta di Friedensreich Hundertwasser, facciate ondulate e tetti verdi.",
    ticket: "Esterni liberi; Village e museo vicini a pagamento."
  },
  // Fast food/quick bite (indicativi, utili come categorie)
  {
    name: "McDonald‚Äôs Stephansplatz (fast food)",
    lat: 48.20802, lng: 16.37209,
    img: "https://upload.wikimedia.org/wikipedia/commons/thumb/7/70/McDonald%27s_Golden_Arches.svg/240px-McDonald%27s_Golden_Arches.svg.png",
    url: "https://www.mcdonalds.at/",
    desc: "Opzione veloce vicino alla cattedrale.",
    ticket: "‚Äî"
  },
  {
    name: "Burger King K√§rntner Stra√üe (fast food)",
    lat: 48.20485, lng: 16.37062,
    img: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/cc/Burger_King_2020.svg/240px-Burger_King_2020.svg.png",
    url: "https://www.burgerking.at/",
    desc: "Burger e snack in centro storico.",
    ticket: "‚Äî"
  }
];

let map, userMarker, routingControl = null;
let selectedPOI = null;

/* === MAPPA =============================================================== */
function initMap(){
  map = L.map('map').setView([hotel.lat, hotel.lng], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // Hotel marker
  const hotelIcon = L.icon({
    iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Map_marker_icon_%E2%80%93_Nicolas_Mollet_%E2%80%93_Hotel_%E2%80%93_Tourism_%E2%80%93_Dark.png/48px-Map_marker_icon_%E2%80%93_Nicolas_Mollet_%E2%80%93_Hotel_%E2%80%93_Tourism_%E2%80%93_Dark.png',
    iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -24]
  });

  const hotelMarker = L.marker([hotel.lat, hotel.lng], {icon: hotelIcon})
    .addTo(map)
    .bindPopup(`<b>${hotel.name}</b><br>Base della tua visita.`);

  // POI markers
  POI.forEach((p, idx)=>{
    const m = L.marker([p.lat, p.lng]).addTo(map);
    m.bindPopup(`
      <div style="display:grid;grid-template-columns:72px 1fr;gap:8px;min-width:260px">
        <img src="${p.img}" alt="${p.name}" style="width:72px;height:72px;object-fit:cover;border-radius:10px">
        <div>
          <b>${p.name}</b><br>
          <small>${p.desc}</small><br>
          <a href="${p.url}" target="_blank" rel="noopener">Fonte/Info</a>
          <div style="margin-top:6px">
            <button onclick="navigateTo(${idx}, true)">Da me</button>
            <button onclick="navigateTo(${idx}, false)">Da hotel</button>
          </div>
        </div>
      </div>
    `);
    m.on('click', ()=> selectPOI(idx, true));
  });

  // Selezione iniziale: hotel
  map.once('load', ()=>{}); // placeholder
}
initMap();

/* === LISTA LATERALE ====================================================== */
const poiListEl = document.getElementById('poiList');
function renderPOIList(){
  poiListEl.innerHTML = '';
  POI.forEach((p, idx)=>{
    const el = document.createElement('div');
    el.className = 'poi';
    el.innerHTML = `
      <img src="${p.img}" alt="${p.name}">
      <div>
        <div class="name">${p.name}</div>
        <div class="small">${p.desc}</div>
        <div class="small"><a href="${p.url}" target="_blank" rel="noopener">Fonte/Info</a> ¬∑ ${p.ticket}</div>
      </div>
    `;
    el.addEventListener('click', ()=> selectPOI(idx, true));
    poiListEl.appendChild(el);
  });
}
renderPOIList();

function selectPOI(index, pan){
  selectedPOI = POI[index];
  if(pan){ map.setView([selectedPOI.lat, selectedPOI.lng], 16); }
  // Aggiorna link Google Maps
  updateGmapsLink();
  // Aggiorna testo guida vocale corrente
  buildTTSTextFor(selectedPOI);
}

/* === GEOLOCALIZZAZIONE =================================================== */
let userPos = null;
document.getElementById('locateBtn').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert("Geolocalizzazione non disponibile."); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    userPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    if(userMarker) userMarker.remove();
    userMarker = L.marker([userPos.lat, userPos.lng], {title:"La mia posizione"}).addTo(map);
    map.setView([userPos.lat, userPos.lng], 15);
  }, (err)=> alert("Impossibile ottenere la posizione: " + err.message), {enableHighAccuracy:true,timeout:10000});
});

document.getElementById('toHotelBtn').addEventListener('click', ()=>{
  if(!userPos){ alert("Prima attiva la tua posizione con ‚ÄúLa mia posizione‚Äù."); return; }
  routeBetween(userPos, {lat: hotel.lat, lng: hotel.lng});
});

/* === NAVIGAZIONE & ROUTING ============================================== */
function routeBetween(start, end){
  if(routingControl){ map.removeControl(routingControl); routingControl = null; }
  routingControl = L.Routing.control({
    waypoints: [ L.latLng(start.lat, start.lng), L.latLng(end.lat, end.lng) ],
    lineOptions: {addWaypoints:false},
    router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
    show:false
  }).addTo(map);
}

function distanceMeters(a,b){
  const R=6371000, toRad = d=> d*Math.PI/180;
  const dLat = toRad(b.lat-a.lat), dLng = toRad(b.lng-a.lng);
  const s1 = Math.sin(dLat/2)**2;
  const s2 = Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s1+s2));
}

function navigateTo(poiIndex, fromUser){
  const p = POI[poiIndex];
  if(fromUser){
    if(!userPos){ alert("Attiva prima la tua posizione (üìç)."); return; }
    const d = distanceMeters(userPos, {lat:p.lat,lng:p.lng});
    routeBetween(userPos, {lat:p.lat,lng:p.lng});
    if(d <= 500){
      speakImmediately(`Il percorso per ${p.name} √® breve: circa ${Math.round(d)} metri. Ti consiglio di andare a piedi.`);
    }else{
      speakImmediately(`Per raggiungere ${p.name} sono circa ${Math.round(d/1000)} chilometri. Ti consiglio mezzi pubblici o taxi.`);
    }
  }else{
    const d = distanceMeters({lat:hotel.lat,lng:hotel.lng},{lat:p.lat,lng:p.lng});
    routeBetween({lat:hotel.lat,lng:hotel.lng}, {lat:p.lat,lng:p.lng});
    if(d <= 500){
      speakImmediately(`Dal tuo hotel a ${p.name} sono circa ${Math.round(d)} metri. Passeggiata consigliata.`);
    }else{
      speakImmediately(`Dal tuo hotel a ${p.name} sono circa ${Math.round(d/1000)} chilometri. Valuta i mezzi pubblici.`);
    }
  }
  selectedPOI = p;
  updateGmapsLink(fromUser);
}

function updateGmapsLink(fromUser = true){
  const p = selectedPOI;
  if(!p){ document.getElementById('gmapsLink').href = "#"; return; }
  let sLat, sLng;
  if(fromUser && userPos){ sLat=userPos.lat; sLng=userPos.lng; }
  else { sLat=hotel.lat; sLng=hotel.lng; }
  const url = `https://www.google.com/maps/dir/?api=1&origin=${sLat},${sLng}&destination=${p.lat},${p.lng}&travelmode=walking`;
  document.getElementById('gmapsLink').href = url;
}

document.getElementById('routeFromMe').addEventListener('click', ()=>{
  if(!selectedPOI){ alert("Seleziona prima un luogo."); return; }
  navigateTo(POI.indexOf(selectedPOI), true);
});
document.getElementById('routeFromHotel').addEventListener('click', ()=>{
  if(!selectedPOI){ alert("Seleziona prima un luogo."); return; }
  navigateTo(POI.indexOf(selectedPOI), false);
});

/* === GUIDA VOCALE (Web Speech API) ====================================== */
let synth = window.speechSynthesis;
let voices = [];
let currentUtterance = null;

function populateVoices(){
  voices = synth.getVoices().sort((a,b)=> a.lang.localeCompare(b.lang));
  const sel = document.getElementById('voiceSelect');
  sel.innerHTML = "";
  // priorit√† voci italiane / neurali
  const preferred = (v)=> /it-IT/i.test(v.lang) || /Italian/i.test(v.name) || /Neural|Premium|Natural/i.test(v.name);
  const sorted = [...voices].sort((a,b)=> (preferred(b)-preferred(a)));
  sorted.forEach((v,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `${v.name} (${v.lang})`;
    sel.appendChild(opt);
  });
}
populateVoices();
if (typeof speechSynthesis !== "undefined") {
  speechSynthesis.onvoiceschanged = populateVoices;
}

function buildTTSTextFor(p){
  const base = p ? `${p.name}. ${p.desc}.` : 
`Benvenuto a Vienna! Dalla base al ${hotel.name}, esplora i luoghi principali: Cattedrale di Santo Stefano, Hofburg, Belvedere con ‚ÄúIl Bacio‚Äù di Klimt, Sch√∂nbrunn e il Prater. Seleziona un punto per la descrizione e la navigazione.`;
  currentText = base + " Tocca un punto sulla mappa o nella lista per maggiori dettagli.";
  return currentText;
}
let currentText = buildTTSTextFor(null);

function speak(text){
  stopTTS(false);
  currentUtterance = new SpeechSynthesisUtterance(text);
  const sel = document.getElementById('voiceSelect');
  const chosen = voices[sel.value] || voices.find(v=>/it-IT/i.test(v.lang)) || voices[0];
  if(chosen){ currentUtterance.voice = chosen; }
  currentUtterance.rate = 0.95;  // pi√π naturale
  currentUtterance.pitch = 1.0;
  currentUtterance.onend = ()=>{};
  synth.speak(currentUtterance);
}

function speakImmediately(text){
  stopTTS(false);
  speak(text);
}

function pauseTTS(){ if(synth.speaking && !synth.paused) synth.pause(); }
function resumeTTS(){ if(synth.paused) synth.resume(); }
function stopTTS(cancelAll=true){
  if(cancelAll){ synth.cancel(); } else if(synth.speaking){ synth.cancel(); }
  currentUtterance = null;
}

document.getElementById('playBtn').addEventListener('click', ()=> speak(currentText));
document.getElementById('pauseBtn').addEventListener('click', pauseTTS);
document.getElementById('resumeBtn').addEventListener('click', resumeTTS);
document.getElementById('stopBtn').addEventListener('click', ()=> stopTTS(true));

</script>
</body>
</html>
