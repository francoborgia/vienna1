<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vienna Tourist Guide</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    h1{text-align:center;color:#764ba2;margin-bottom:30px;font-size:2.3em;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .map-container{height:500px;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2);margin-bottom:14px;position:relative}
    #map{height:100%;width:100%}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-bottom:16px}
    .row{display:grid;grid-template-columns:2fr 1fr;gap:20px}
    @media(max-width:1000px){.row{grid-template-columns:1fr}}
    .section{background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 18px rgba(0,0,0,.08)}
    .section h3{margin-bottom:10px;color:#444}
    .categories{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:20px}
    .category-btn{padding:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:15px;font-weight:600;transition:.25s;box-shadow:0 5px 15px rgba(0,0,0,.15)}
    .category-btn:hover{transform:translateY(-2px)}
    .category-btn.active{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
    .places-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px;margin-top:10px}
    .place-card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,.1);transition:.25s}
    .place-card:hover{transform:translateY(-4px)}
    .place-image{width:100%;height:190px;object-fit:cover;background:#f3f3f3}
    .place-info{padding:16px}
    .place-name{font-size:1.15em;font-weight:700;color:#333;margin-bottom:8px}
    .place-description{color:#555;line-height:1.55;margin:8px 0 12px;font-size:.95em}
    .detail{display:flex;align-items:center;gap:8px;color:#555;font-size:.9em;margin:6px 0}
    .distance-badge{display:inline-block;padding:4px 9px;background:#4CAF50;color:#fff;border-radius:12px;font-size:.8em;font-weight:700}
    .price-badge{display:inline-block;padding:4px 9px;background:#ff9800;color:#fff;border-radius:12px;font-size:.8em;font-weight:700}
    .free-badge{background:#4CAF50}
    .navigate-btn{width:100%;padding:10px;margin-top:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:.25s}
    .navigate-btn:hover{filter:brightness(1.05)}
    .hotel-info{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;padding:16px;border-radius:14px;margin-bottom:20px;box-shadow:0 10px 25px rgba(0,0,0,.18)}
    .search-bar{width:100%;padding:13px;border:2px solid #ddd;border-radius:10px;font-size:15px;margin-bottom:14px}
    .filter-options{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
    .chip{padding:7px 12px;background:#f0f0f0;border-radius:20px;cursor:pointer;border:2px solid transparent}
    .chip.active{background:#667eea;color:#fff;border-color:#764ba2}
    .sort-options{display:flex;gap:10px;margin-bottom:14px;align-items:center}
    .sort-btn{padding:7px 12px;background:#fff;border:2px solid #667eea;border-radius:20px;cursor:pointer;font-size:14px}
    .sort-btn.active{background:#667eea;color:#fff}
    .location-btn{position:absolute;top:10px;right:10px;z-index:1000;background:#fff;border:2px solid #667eea;border-radius:50%;width:40px;height:40px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .location-status{padding:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:10px;margin:12px 0;display:none;align-items:center;gap:10px}
    .location-status.active{display:flex}
    .modal{display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.7)}
    .modal-content{background:#fff;margin:5% auto;padding:24px;border-radius:18px;width:90%;max-width:600px;position:relative}
    .close{position:absolute;right:16px;top:10px;font-size:28px;cursor:pointer;color:#999}
    .tip{font-size:.9em;color:#666}
    .airtag-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.airtag-grid{grid-template-columns:1fr}}
    .btn{padding:10px 12px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
    .btn-primary{background:#0b73ff;color:#fff}
    .btn-outline{background:#fff;border:2px solid #0b73ff;color:#0b73ff}
    .top-btn{padding:10px 14px;border:none;border-radius:12px;background:#fff;border:2px solid #667eea;color:#333;font-weight:700;cursor:pointer}
    .top-btn:hover{background:#f8f9ff}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(102,126,234,.7)}70%{box-shadow:0 0 0 10px rgba(102,126,234,0)}100%{box-shadow:0 0 0 0 rgba(102,126,234,0)}}
    /* Guida Live audio controls */
    .audio-controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn-audio{padding:8px 10px;border-radius:8px;border:2px solid #667eea;background:#fff;cursor:pointer;font-weight:700}
    .btn-audio.active{background:#667eea;color:#fff}
  </style>
</head>
<body>
  <div class="container">
    <h1>üèõÔ∏è Vienna Tourist Guide üá¶üáπ</h1>

    <div class="hotel-info">
      <h2>üìç Il Tuo Hotel</h2>
      <p><strong>Boutique Hotel Das Tigra</strong></p>
      <p>Tiefer Graben 14-20, 1010 Wien</p>
      <p>‚≠ê‚≠ê‚≠ê‚≠ê Hotel boutique nel centro storico di Vienna</p>
    </div>

    <div class="map-container">
      <div id="map"></div>
      <button class="location-btn" id="locationBtn" title="La mia posizione">üìç</button>
    </div>

    <div class="top-actions">
      <button class="top-btn" id="btnBackToHotel">üè® Torna in Hotel</button>
      <button class="top-btn" id="btnAppleBack">Ô£ø Maps ‚Üí Hotel</button>
    </div>

    <div class="row">
      <!-- Colonna sinistra -->
      <div class="section">
        <div class="location-status" id="locationStatus">
          <span>üì° Geolocalizzazione attiva ‚Äî posizione aggiornata in tempo reale</span>
        </div>

        <input type="text" class="search-bar" placeholder="üîç Cerca monumenti, ristoranti, attrazioni..." id="searchBar">

        <div class="sort-options">
          <span style="font-weight:bold;">Ordina per:</span>
          <button class="sort-btn active" data-sort="default">Default</button>
          <button class="sort-btn" data-sort="distance">Distanza da me</button>
          <button class="sort-btn" data-sort="name">Nome A-Z</button>
        </div>

        <div class="filter-options">
          <div class="chip" data-filter="free">Gratuito</div>
          <div class="chip" data-filter="paid">A pagamento</div>
          <div class="chip" data-filter="walking">&lt; 500m a piedi</div>
          <div class="chip" data-filter="transport">&gt; 500m trasporti</div>
        </div>

        <div class="categories" id="categoriesBar">
          <button class="category-btn active" data-category="monuments">üèõÔ∏è Monumenti</button>
          <button class="category-btn" data-category="museums">üé® Musei</button>
          <button class="category-btn" data-category="restaurants">üçΩÔ∏è Ristoranti</button>
          <button class="category-btn" data-category="fastfood">üçî Fast Food</button>
          <button class="category-btn" data-category="parks">üå≥ Parchi</button>
          <button class="category-btn" data-category="shopping">üõçÔ∏è Shopping</button>
          <button class="category-btn" data-category="attractions" id="btnAttractions">‚ú® Attrazioni (OSM)</button>
          <button class="category-btn" id="btnLoadAttractions">‚§µÔ∏è Carica altre attrazioni</button>
        </div>

        <div class="places-grid" id="placesGrid"></div>
      </div>

      <!-- Colonna destra: AirTag + Guida Live -->
      <div class="section">
        <h3>üéØ Pannello AirTag / Oggetto</h3>
        <p class="tip">
          Gli AirTag non espongono API web: questo pannello permette di <b>aprire Dov‚Äô√®</b> su iOS
          e di <b>navigare</b> verso coordinate note dell‚Äôoggetto (se le conosci).
        </p>

        <div style="display:flex;gap:10px;margin:10px 0;">
          <button class="btn btn-primary" id="btnOpenFindMy">Apri Dov‚Äô√® (iOS)</button>
          <button class="btn btn-outline" id="btnFindMyHelp">Cos‚Äô√® questo?</button>
        </div>

        <hr style="margin:12px 0;">

        <h4>üìå Coordinate note dell‚Äôoggetto (facoltative)</h4>
        <div class="airtag-grid" style="margin-top:8px;">
          <input id="tagName" class="search-bar" placeholder="Nome oggetto (es. Zaino, Valigia)">
          <input id="tagLat"  class="search-bar" placeholder="Latitudine (es. 48.20849)">
          <input id="tagLng"  class="search-bar" placeholder="Longitudine (es. 16.37312)">
          <div style="display:flex;gap:10px;">
            <button class="btn btn-primary" id="btnSaveTag">Salva</button>
            <button class="btn" id="btnUseMyPos">Usa mia posizione</button>
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px;">
          <button class="btn" id="btnOpenAppleMaps">Apri in Apple Maps</button>
          <button class="btn" id="btnOpenGoogleMaps">Apri in Google Maps</button>
        </div>

        <p id="tagSavedInfo" class="tip" style="margin-top:8px;"></p>
      </div>

      <div class="section" id="liveGuidePanel">
        <h3>üó∫Ô∏è Guida Live</h3>
        <p class="tip">Spunta la casella per avviare la guida interattiva. Recuperiamo descrizioni e immagini da Wikipedia/Wikidata.</p>
        <div style="display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap;">
          <label><input type="checkbox" id="guideEnable"> Attiva guida live</label>
          <label><input type="checkbox" id="guideVoice" checked> Audio (voce)</label>
        </div>

        <div id="guideNow" style="display:none;">
          <div style="display:flex;gap:12px;align-items:flex-start;">
            <img id="guideImg" src="" alt="" style="width:120px;height:90px;object-fit:cover;border-radius:8px;background:#f3f3f3;">
            <div>
              <div style="font-weight:700;" id="guideTitle"></div>
              <div id="guideBlurb" style="color:#555;margin-top:6px;"></div>
              <div id="guideDistance" class="tip" style="margin-top:6px;"></div>
            </div>
          </div>

          <div id="guideSections" style="margin-top:10px;"></div>

          <div class="audio-controls">
            <button class="btn-audio" id="guidePlay">‚ñ∂Ô∏è Play</button>
            <button class="btn-audio" id="guidePause">‚è∏Ô∏è Pausa</button>
            <button class="btn-audio" id="guideResume">‚èØÔ∏è Riprendi</button>
            <button class="btn-audio" id="guideStop">‚èπÔ∏è Stop</button>
            <button class="btn-audio" id="guideRepeat">üîä Riascolta</button>
            <button class="btn-audio" id="guideNavigate">üìç Vai qui</button>
          </div>

          <div style="margin-top:12px;">
            <div style="height:8px;background:#eee;border-radius:6px;position:relative;">
              <div id="arrowFov" style="position:absolute;top:-6px;left:50%;transform:translateX(-50%) rotate(0deg);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:14px solid #667eea;"></div>
            </div>
            <div class="tip">Freccia = direzione del POI rispetto a dove punti</div>
          </div>
        </div>

        <div id="guideNone" class="tip">Nessun POI davanti a te al momento.</div>
      </div>
    </div>
  </div>

  <!-- Modal navigazione -->
  <div id="navigationModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalTitle">Navigazione</h2>
      <div id="modalBody"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* =======================
       Geolocalizzazione / follow
    ======================= */
    let autoFollow = true;   // mappa segue sempre la tua posizione
    let userCircle = null;   // cerchio di accuratezza GPS

    /* =======================
       Dati hotel
    ======================= */
    const hotelLocation = {
      lat: 48.216837,
      lng: 16.345621,
      name: "Boutique Hotel Das Tigra",
      address: "Tiefer Graben 14-20, 1010 Wien"
    };

    /* =======================
       POI base + dinamico
    ======================= */
    const places = {
      monuments: [
        { name:"Cattedrale di Santo Stefano", description:"", image:"", lat:48.208492, lng:16.373119, price:"Gratuito (Torre ‚Ç¨6)", hours:"6:00-22:00", distance:0, wikipedia:"it:Duomo_di_Santo_Stefano_(Vienna)" },
        { name:"Hofburg", description:"", image:"", lat:48.206507, lng:16.365262, price:"‚Ç¨15", hours:"9:00-17:30", distance:0, wikipedia:"it:Hofburg" },
        { name:"Belvedere", description:"", image:"", lat:48.191567, lng:16.380995, price:"‚Ç¨16", hours:"10:00-18:00", distance:0, wikipedia:"it:Belvedere_(Vienna)" },
        { name:"Prater e Ruota Panoramica", description:"", image:"", lat:48.216571, lng:16.395776, price:"‚Ç¨13.50", hours:"10:00-22:00", distance:0, wikipedia:"it:Ruota_panoramica_di_Vienna" },
        { name:"Opera di Stato di Vienna", description:"", image:"", lat:48.203001, lng:16.369002, price:"Tour ‚Ç¨13", hours:"Tour: 10:00-15:00", distance:0, wikipedia:"it:Opera_di_Stato_di_Vienna" },
        { name:"Palazzo del Parlamento", description:"", image:"", lat:48.207788, lng:16.357613, price:"Tour gratuito", hours:"Lun-Sab con prenotazione", distance:0, wikipedia:"it:Parlamento_austriaco" },
        { name:"Rathaus (Municipio)", description:"", image:"", lat:48.210577, lng:16.357420, price:"Gratuito", hours:"Tour Lun, Mer, Ven 13:00", distance:0, wikipedia:"it:Municipio_di_Vienna" }
      ],
      museums: [
        { name:"Kunsthistorisches Museum", description:"", image:"", lat:48.203551, lng:16.361587, price:"‚Ç¨21", hours:"10:00-18:00 (Gio fino 21:00)", distance:0, wikipedia:"it:Kunsthistorisches_Museum" },
        { name:"Albertina", description:"", image:"", lat:48.204731, lng:16.368438, price:"‚Ç¨18.90", hours:"10:00-18:00 (Mer, Ven fino 21:00)", distance:0, wikipedia:"it:Albertina_(Vienna)" },
        { name:"Museo di Storia Naturale", description:"", image:"", lat:48.205268, lng:16.359989, price:"‚Ç¨16", hours:"9:00-18:00 (Mer fino 20:00)", distance:0, wikipedia:"it:Museo_di_storia_naturale_(Vienna)" },
        { name:"MAK - Museo Arti Applicate", description:"", image:"", lat:48.207395, lng:16.381705, price:"‚Ç¨15", hours:"10:00-18:00 (Mar fino 21:00)", distance:0, wikipedia:"it:Museo_di_arti_applicate_(Vienna)" }
      ],
      restaurants: [
        { name:"Figlm√ºller", description:"", image:"", lat:48.208765, lng:16.374526, price:"‚Ç¨‚Ç¨‚Ç¨", hours:"11:00-22:30", distance:0 },
        { name:"Caf√© Central", description:"", image:"", lat:48.210372, lng:16.365063, price:"‚Ç¨‚Ç¨", hours:"7:30-22:00", distance:0 },
        { name:"Plachutta Wollzeile", description:"", image:"", lat:48.208492, lng:16.376798, price:"‚Ç¨‚Ç¨‚Ç¨", hours:"11:30-23:00", distance:0 },
        { name:"Zum Schwarzen Kameel", description:"", image:"", lat:48.210833, lng:16.367778, price:"‚Ç¨‚Ç¨‚Ç¨‚Ç¨", hours:"8:00-24:00", distance:0 },
        { name:"Caf√© Sacher", description:"", image:"", lat:48.203889, lng:16.369444, price:"‚Ç¨‚Ç¨‚Ç¨", hours:"8:00-24:00", distance:0 }
      ],
      parks: [
        { name:"Stadtpark", description:"", image:"", lat:48.204722, lng:16.378611, price:"Gratuito", hours:"Sempre aperto", distance:0, wikipedia:"it:Stadtpark" },
        { name:"Volksgarten", description:"", image:"", lat:48.207778, lng:16.361111, price:"Gratuito", hours:"Sempre aperto", distance:0, wikipedia:"it:Volksgarten_(Vienna)" },
        { name:"Augarten", description:"", image:"", lat:48.226111, lng:16.380278, price:"Gratuito", hours:"Sempre aperto", distance:0, wikipedia:"it:Augarten" }
      ],
      shopping: [
        { name:"Graben & Kohlmarkt", description:"", image:"", lat:48.208889, lng:16.369444, price:"N/D", hours:"10:00-19:00", distance:0, wikipedia:"it:Kohlmarkt_(Vienna)" },
        { name:"Mariahilfer Stra√üe", description:"", image:"", lat:48.196944, lng:16.340278, price:"N/D", hours:"10:00-20:00", distance:0, wikipedia:"it:Mariahilfer_Stra√üe" }
      ],
      attractions: [] // dinamico da OSM
    };

    /* =======================
       Guida Live - dataset di base (se vuoi forzare alcuni POI)
    ======================= */
    const liveGuides = [
      { id: 'stephansdom', name: 'Cattedrale di Santo Stefano', lat: 48.208492, lng: 16.373119, radius: 120, fov: 80, wikipedia: "it:Duomo_di_Santo_Stefano_(Vienna)" },
      { id: 'hofburg',     name: 'Hofburg',                       lat: 48.206507, lng: 16.365262, radius: 140, fov: 80, wikipedia: "it:Hofburg" }
    ];

    /* =======================
       Stato & mappa
    ======================= */
    let map, markers = [], currentCategory = 'monuments';
    let userMarker = null, userLocation = null, watchId = null, currentSort = 'default';
    function initMap(){
      map = L.map('map').setView([hotelLocation.lat, hotelLocation.lng], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap contributors' }).addTo(map);

      const hotelIcon = L.divIcon({
        html:'<div style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;padding:8px;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 3px 10px rgba(0,0,0,.3);">üè®</div>',
        iconSize:[40,40], iconAnchor:[20,20]
      });
      L.marker([hotelLocation.lat, hotelLocation.lng], {icon:hotelIcon})
        .addTo(map)
        .bindPopup(`<strong>${hotelLocation.name}</strong><br>${hotelLocation.address}`)
        .openPopup();

      initGeolocation();
    }
    function initGeolocation(){
      if("geolocation" in navigator){
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy); startLocationTracking(); },
          (err)=>{ console.log("Geo negata/non disponibile:", err); },
          { enableHighAccuracy:true }
        );
      }
    }
    function startLocationTracking(){
      if("geolocation" in navigator){
        watchId = navigator.geolocation.watchPosition(
          (pos)=>updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy),
          (err)=>console.error("Errore tracking:", err),
          { enableHighAccuracy:true, timeout:5000, maximumAge:0 }
        );
        document.getElementById('locationStatus').classList.add('active');
        document.getElementById('locationBtn').classList.add('active');
      }
    }
    function updateUserLocation(lat, lng, accuracy){
      userLocation = { lat, lng };
      if (userMarker) map.removeLayer(userMarker);
      const userIcon = L.divIcon({
        html:`<div style="position:relative;">
                <div style="background:#2196F3;border:3px solid #fff;border-radius:50%;width:20px;height:20px;box-shadow:0 2px 5px rgba(0,0,0,.3);"></div>
                <div style="position:absolute;top:-5px;left:-5px;width:30px;height:30px;border:2px solid #2196F3;border-radius:50%;opacity:.3;animation:pulse 2s infinite;"></div>
              </div>`,
        iconSize:[30,30], iconAnchor:[15,15]
      });
      userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(map).bindPopup("<strong>La tua posizione</strong>");
      if (userMarker && userMarker._icon) userMarker._icon.style.zIndex = 10000;

      if (userCircle) map.removeLayer(userCircle);
      if (Number.isFinite(accuracy)) {
        userCircle = L.circle([lat, lng], { radius: Math.max(accuracy, 15), color: '#2196F3', fillColor: '#2196F3', fillOpacity: 0.15, weight: 1 }).addTo(map);
      }
      if (autoFollow) {
        const targetZoom = Math.max(map.getZoom(), 15);
        map.setView([lat, lng], targetZoom, { animate: false });
      }
      updateDistancesFromUser();
      if (currentSort === 'distance') renderPlaces(currentCategory, document.getElementById('searchBar').value);
      liveGuideTick(); // guida
    }
    function centerOnUser(){
      if(userLocation){
        map.setView([userLocation.lat, userLocation.lng], Math.max(map.getZoom(), 15));
        if(userMarker) userMarker.openPopup();
      } else if("geolocation" in navigator){
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy); map.setView([pos.coords.latitude, pos.coords.longitude], 16); startLocationTracking(); },
          ()=>alert("Abilita la geolocalizzazione nel browser")
        );
      }
    }
    function calculateDistance(lat1,lon1,lat2,lon2){
      const R = 6371e3;
      const œÜ1 = lat1*Math.PI/180, œÜ2 = lat2*Math.PI/180;
      const ŒîœÜ = (lat2-lat1)*Math.PI/180, ŒîŒª = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }
    function updateDistances(){
      Object.keys(places).forEach(cat=>{
        places[cat].forEach(p=>{
          p.distance = Math.round(calculateDistance(hotelLocation.lat, hotelLocation.lng, p.lat, p.lng));
        });
      });
    }
    function updateDistancesFromUser(){
      if(!userLocation) return;
      Object.keys(places).forEach(cat=>{
        places[cat].forEach(p=>{
          p.distanceFromUser = Math.round(calculateDistance(userLocation.lat, userLocation.lng, p.lat, p.lng));
        });
      });
    }

    function showPlacesOnMap(category){
      markers.forEach(m=>map.removeLayer(m));
      markers = [];
      const categoryEmojis = { monuments:'üèõÔ∏è', museums:'üé®', restaurants:'üçΩÔ∏è', parks:'üå≥', shopping:'üõçÔ∏è', attractions:'‚ú®' };
      (places[category]||[]).forEach(place=>{
        const icon = L.divIcon({
          html:`<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:5px;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;box-shadow:0 2px 6px rgba(0,0,0,.3);">${categoryEmojis[category]||'üìç'}</div>`,
          iconSize:[30,30], iconAnchor:[15,15]
        });
        const marker = L.marker([place.lat, place.lng], {icon})
          .addTo(map)
          .bindPopup(`<strong>${place.name}</strong><br>${place.description ? place.description.substring(0,120) : ''}`);
        markers.push(marker);
      });
    }

    function renderPlaces(category, searchTerm='', filters=[]){
      const grid = document.getElementById('placesGrid');
      let list = places[category] || [];

      if(searchTerm){
        const s = searchTerm.toLowerCase();
        list = list.filter(p => (p.name||'').toLowerCase().includes(s) || (p.description||'').toLowerCase().includes(s));
      }
      if(filters.length){
        list = list.filter(p=>{
          let pass = true;
          filters.forEach(f=>{
            if(f==='free' && !(p.price||'').toLowerCase().includes('gratuito')) pass=false;
            if(f==='paid' && (p.price||'').toLowerCase().includes('gratuito')) pass=false;
            if(f==='walking' && (p.distance ?? 999999) > 500) pass=false;
            if(f==='transport' && (p.distance ?? 0) <= 500) pass=false;
          });
          return pass;
        });
      }
      if(currentSort==='distance' && userLocation){
        list.sort((a,b)=> (a.distanceFromUser??999999)-(b.distanceFromUser??999999));
      }else if(currentSort==='name'){
        list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      }

      grid.innerHTML = list.map((place, idx)=>{
        const useUserLocation = !!userLocation && currentSort==='distance';
        const currentDistance = useUserLocation ? (place.distanceFromUser ?? place.distance) : place.distance;
        const transportType = (currentDistance<=500) ? 'üö∂ A piedi' : 'üöá Mezzi pubblici';
        const transportColor = (currentDistance<=500) ? '#4CAF50' : '#2196F3';
        const priceClass = (place.price||'').toLowerCase().includes('gratuito') ? 'free-badge' : '';
        const cardId = `card-${category}-${idx}`;
        // immagine placeholder: verr√† sostituita da Wikipedia se disponibile
        const imgSrc = place.image || 'https://upload.wikimedia.org/wikipedia/commons/6/65/Wikimedia-logo.png';

        return `
          <div class="place-card" id="${cardId}">
            <img src="${imgSrc}" alt="${place.name}" class="place-image" id="${cardId}-img">
            <div class="place-info">
              <div class="place-name">${place.name}</div>
              <div class="place-description" id="${cardId}-desc">${place.description || ''}</div>
              <div class="detail">üìç <span>${(place.distance!=null)? place.distance+'m dall\\'hotel' : '-'}</span></div>
              <div class="detail"><span class="distance-badge" style="background:${transportColor};">${transportType}</span></div>
              <div class="detail">üí∞ <span class="price-badge ${priceClass}">${place.price||'‚Äî'}</span></div>
              <div class="detail">üïê <span>${place.hours||'‚Äî'}</span></div>
              <button class="navigate-btn"
                onclick="showNavigationModal('${(place.name||'').replace(/'/g, "\\'")}', ${place.lat}, ${place.lng}, ${currentDistance||999999}, ${useUserLocation})">
                üìç Indicazioni Stradali
              </button>
            </div>
          </div>
        `;
      }).join('');

      // Enrich con Wikipedia (testo + thumbnail)
      list.forEach((place, idx)=>{
        enrichPlaceWithWikipedia(place).then(data=>{
          if(!data) return;
          const cardId = `card-${category}-${idx}`;
          const descEl = document.getElementById(`${cardId}-desc`);
          const imgEl  = document.getElementById(`${cardId}-img`);
          if(descEl && data.extract) descEl.textContent = data.extract;
          if(imgEl && data.thumbnail) imgEl.src = data.thumbnail;
        }).catch(()=>{});
      });
    }

    /* =======================
       Modal navigazione
    ======================= */
    window.showNavigationModal = function(placeName, lat, lng, distance, fromUserLocation=false){
      const modal = document.getElementById('navigationModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      const startLat = (fromUserLocation && userLocation) ? userLocation.lat : hotelLocation.lat;
      const startLng = (fromUserLocation && userLocation) ? userLocation.lng : hotelLocation.lng;
      const startName = (fromUserLocation && userLocation) ? "la tua posizione" : hotelLocation.name;

      modalTitle.textContent = `Navigazione verso ${placeName}`;

      let html = '';
      if(distance <= 500){
        html = `
          <div class="navigation-options">
            <h3>üö∂ Percorso a piedi (${distance}m - ~${Math.round(distance/80)} min)</h3>
            <p class="tip">Partenza da: <strong>${startName}</strong></p>
            <div class="nav-option" onclick="openGoogleMaps(${lat}, ${lng}, 'walking', ${startLat}, ${startLng})"><h4>Google Maps - A piedi</h4></div>
            <div class="nav-option" onclick="openAppleMaps(${lat}, ${lng}, 'walking', ${startLat}, ${startLng})"><h4>Apple Maps - A piedi</h4></div>
          </div>`;
      } else {
        const walkingTime = Math.round(distance/80);
        const transitTime  = Math.round(distance/250);
        html = `
          <div class="navigation-options">
            <h3>üöá Mezzi pubblici consigliati (~${transitTime} min)</h3>
            <p class="tip">Partenza da: <strong>${startName}</strong></p>
            <div class="nav-option" onclick="openGoogleMaps(${lat}, ${lng}, 'transit', ${startLat}, ${startLng})"><h4>Google Maps - Mezzi pubblici</h4></div>
            <div class="nav-option" onclick="openWienerLinien(${lat}, ${lng}, ${startLat}, ${startLng})"><h4>Wiener Linien - Planner</h4></div>
            <div class="nav-option" onclick="openUber(${lat}, ${lng}, ${startLat}, ${startLng})"><h4>Uber / Taxi</h4></div>
            <hr style="margin:14px 0;border:1px solid #eee;">
            <h3>üö∂ Alternativa a piedi (~${walkingTime} min)</h3>
            <div class="nav-option" onclick="openGoogleMaps(${lat}, ${lng}, 'walking', ${startLat}, ${startLng})"><h4>Google Maps - A piedi</h4></div>
          </div>`;
      }
      modalBody.innerHTML = html;
      modal.style.display = 'block';
    };
    window.openGoogleMaps = function(lat, lng, mode, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const travelMode = (mode === 'walking') ? '2' : '3';
      const url = `https://www.google.com/maps/dir/${sLat},${sLng}/${lat},${lng}/@${lat},${lng},15z/data=!4m2!4m1!3e${travelMode}`;
      window.open(url, '_blank');
    };
    window.openAppleMaps = function(lat, lng, mode, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const dirflg = (mode === 'walking') ? 'w' : 'r';
      const url = `https://maps.apple.com/?saddr=${sLat},${sLng}&daddr=${lat},${lng}&dirflg=${dirflg}`;
      window.open(url, '_blank');
    };
    window.openWienerLinien = function(lat, lng, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const url = `https://www.wienerlinien.at/web/wl-en/journey-planner?from=${sLat},${sLng}&to=${lat},${lng}`;
      window.open(url, '_blank');
    };
    window.openUber = function(lat, lng, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const url = `https://m.uber.com/ul/?action=setPickup&pickup[latitude]=${sLat}&pickup[longitude]=${sLng}&dropoff[latitude]=${lat}&dropoff[longitude]=${lng}`;
      window.open(url, '_blank');
    };

    // Bottoni ‚ÄúTorna in Hotel‚Äù
    document.addEventListener('click', (e)=>{
      if(e.target.id === 'btnBackToHotel'){
        if(!userLocation){ centerOnUser(); return; }
        openGoogleMaps(hotelLocation.lat, hotelLocation.lng, 'walking', userLocation.lat, userLocation.lng);
      }
      if(e.target.id === 'btnAppleBack'){
        if(!userLocation){ centerOnUser(); return; }
        openAppleMaps(hotelLocation.lat, hotelLocation.lng, 'walking', userLocation.lat, userLocation.lng);
      }
    });

    /* =======================
       ATTRAZIONI DINAMICHE (Overpass/OSM) + ampliamento categorie
    ======================= */
    async function loadAttractionsFromOverpass(centerLat, centerLng, radiusMeters = 5000) {
      const endpoint = 'https://overpass-api.de/api/interpreter';
      const query = `
        [out:json][timeout:25];
        (
          node(around:${radiusMeters},${centerLat},${centerLng})["tourism"~"attraction|museum|gallery|viewpoint|theme_park"];
          way(around:${radiusMeters},${centerLat},${centerLng})["tourism"~"attraction|museum|gallery|viewpoint|theme_park"];
          relation(around:${radiusMeters},${centerLat},${centerLng})["tourism"~"attraction|museum|gallery|viewpoint|theme_park"];

          node(around:${radiusMeters},${centerLat},${centerLng})["amenity"="place_of_worship"];
          way(around:${radiusMeters},${centerLat},${centerLng})["amenity"="place_of_worship"];
          relation(around:${radiusMeters},${centerLat},${centerLng})["amenity"="place_of_worship"];

          node(around:${radiusMeters},${centerLat},${centerLng})["historic"];
          way(around:${radiusMeters},${centerLat},${centerLng})["historic"];
          relation(around:${radiusMeters},${centerLat},${centerLng})["historic"];

          node(around:${radiusMeters},${centerLat},${centerLng})["artwork_type"];
          way(around:${radiusMeters},${centerLat},${centerLng})["artwork_type"];
          relation(around:${radiusMeters},${centerLat},${centerLng})["artwork_type"];

          node(around:${radiusMeters},${centerLat},${centerLng})["memorial"];
          way(around:${radiusMeters},${centerLat},${centerLng})["memorial"];
          relation(around:${radiusMeters},${centerLat},${centerLng})["memorial"];

          node(around:${radiusMeters},${centerLat},${centerLng})["monument"];
          way(around:${radiusMeters},${centerLat},${centerLng})["monument"];
          relation(around:${radiusMeters},${centerLat},${centerLng})["monument"];
        );
        out center tags 200;
      `;
      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'},
          body: 'data=' + encodeURIComponent(query)
        });
        const json = await res.json();
        const results = (json.elements||[]).map(el=>{
          const tags = el.tags||{};
          const name = tags.name || 'Attrazione';
          const lat = el.lat || (el.center && el.center.lat);
          const lng = el.lon || (el.center && el.center.lon);
          if (!lat || !lng) return null;

          const description = tags.description || '';
          const hours = tags.opening_hours || "Orari non disponibili";
          const price = "‚Äî";
          const image = ''; // lo riempiremo via Wikipedia
          const wikipedia = tags.wikipedia || null; // es. "it:Hofburg"
          const wikidata  = tags.wikidata  || null; // es. "Q12345"

          return {
            name, description, image, lat, lng, price, hours, wikipedia, wikidata,
            distance: Math.round(calculateDistance(hotelLocation.lat, hotelLocation.lng, lat, lng))
          };
        }).filter(Boolean);

        const key = p => `${(p.name||'').toLowerCase()}@${p.lat.toFixed(5)},${p.lng.toFixed(5)}`;
        const existing = new Set((places.attractions||[]).map(key));
        const fresh = results.filter(p => !existing.has(key(p)));

        places.attractions = [...(places.attractions||[]), ...fresh];

        if (currentCategory === 'attractions') {
          if (userLocation) updateDistancesFromUser();
          renderPlaces('attractions', document.getElementById('searchBar').value);
          showPlacesOnMap('attractions');
        }
        alert(`Caricate ${fresh.length} nuove attrazioni OSM.`);
      } catch (e) {
        console.error('Overpass error:', e);
        alert('Impossibile caricare attrazioni ora. Riprova pi√π tardi.');
      }
    }

    /* =======================
       Wikipedia / Wikidata Enrichment
    ======================= */
    async function enrichPlaceWithWikipedia(place){
      try {
        // 1) Se ho gi√† wikipedia tag (es. "it:Hofburg"), uso quello
        let title = null, lang = 'it';
        if (place.wikipedia && typeof place.wikipedia === 'string') {
          const parts = place.wikipedia.split(':');
          if (parts.length >= 2) { lang = parts[0]; title = parts.slice(1).join(':'); }
        }

        // 2) Altrimenti, se ho Wikidata (Qxxx) ‚Üí cerco sitelink itwiki
        if (!title && place.wikidata){
          const q = place.wikidata.replace('Q','Q'); // safe
          const wd = await fetch(`https://www.wikidata.org/wiki/Special:EntityData/${q}.json`).then(r=>r.json());
          const ent = wd.entities && wd.entities[q];
          const sitelinks = ent && ent.sitelinks;
          if (sitelinks && sitelinks.itwiki) {
            lang = 'it';
            title = sitelinks.itwiki.title;
          } else if (sitelinks && sitelinks.enwiki) {
            lang = 'en';
            title = sitelinks.enwiki.title;
          }
          // immagine P18 (se c‚Äô√®)
          const claims = ent && ent.claims;
          if (claims && claims.P18 && claims.P18[0] && claims.P18[0].mainsnak && claims.P18[0].mainsnak.datavalue) {
            const filename = claims.P18[0].mainsnak.datavalue.value; // es. "Stephansdom Wien.jpg"
            const commonsThumb = await commonsThumbFromFilename(filename, 640);
            if (commonsThumb && !place.image) place.image = commonsThumb;
          }
        }

        // 3) Altrimenti geosearch vicino al POI
        if (!title){
          const geo = await fetch(`https://${'it'}.wikipedia.org/w/api.php?action=query&list=geosearch&gscoord=${place.lat}%7C${place.lng}&gsradius=150&gslimit=10&format=json&origin=*`).then(r=>r.json());
          const hit = geo?.query?.geosearch?.[0];
          if (hit){ lang='it'; title = hit.title; }
        }

        if (!title) return null;

        // 4) Summary REST (thumbnail + extract breve)
        const summary = await fetch(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`, { headers: { 'Accept': 'application/json' } }).then(r=>r.json());
        const extract = (summary?.extract || '').split('\n').slice(0,2).join(' '); // prime frasi
        const thumb = summary?.thumbnail?.source || place.image || null;

        // 5) Se ancora niente thumb, prova pageimages (pi√π grande)
        let finalThumb = thumb;
        if (!finalThumb){
          const pi = await fetch(`https://${lang}.wikipedia.org/w/api.php?action=query&prop=pageimages&piprop=thumbnail&pithumbsize=640&titles=${encodeURIComponent(title)}&format=json&origin=*`).then(r=>r.json());
          const pages = pi?.query?.pages || {};
          const firstKey = Object.keys(pages)[0];
          if (firstKey && pages[firstKey]?.thumbnail?.source) finalThumb = pages[firstKey].thumbnail.source;
        }

        // aggiorna place (cos√¨ resta in cache locale)
        if (extract && !place.description) place.description = extract;
        if (finalThumb) place.image = finalThumb;

        return { extract: place.description, thumbnail: place.image, title, lang };
      } catch (e) {
        console.warn('Wiki enrich error', e);
        return null;
      }
    }

    // Costruisci URL thumbnail Commons da filename P18
    async function commonsThumbFromFilename(filename, width=640){
      // filename -> MD5 path secondo schema di Commons
      const title = filename.replace(/ /g, '_');
      const md5 = await md5Text(title);
      const url = `https://upload.wikimedia.org/wikipedia/commons/thumb/${md5.substring(0,1)}/${md5.substring(0,2)}/${encodeURIComponent(title)}/${width}px-${encodeURIComponent(title)}`;
      return url;
    }
    async function md5Text(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('MD5', enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    /* =======================
       Guida Live: bussola & logica + TTS controlli
    ======================= */
    let deviceHeading = null;    // 0..360 (Nord=0)
    let lastGuideId = null;
    let guideCooldown = 6000;    // ms
    let lastAnnounceTs = 0;

    const tts = {
      utterance: null,
      playing: false,
      paused: false,
      text: '',
      speak(text){
        if (!('speechSynthesis' in window)) return;
        this.stop();
        this.text = text;
        this.utterance = new SpeechSynthesisUtterance(text);
        this.utterance.lang = 'it-IT';
        this.utterance.rate = 1.0;
        this.utterance.pitch = 1.0;
        this.utterance.onend = ()=>{ this.playing=false; this.paused=false; };
        window.speechSynthesis.speak(this.utterance);
        this.playing = true;
      },
      pause(){ if (window.speechSynthesis.speaking && !window.speechSynthesis.paused){ window.speechSynthesis.pause(); this.paused=true; } },
      resume(){ if (window.speechSynthesis.paused){ window.speechSynthesis.resume(); this.paused=false; } },
      stop(){ window.speechSynthesis.cancel(); this.playing=false; this.paused=false; }
    };

    function degNormalize(a){ return (a % 360 + 360) % 360; }
    function degDiff(a, b){
      let d = Math.abs(degNormalize(a) - degNormalize(b));
      return d > 180 ? 360 - d : d;
    }
    function bearingTo(lat1, lon1, lat2, lon2){
      const œÜ1 = lat1 * Math.PI/180, œÜ2 = lat2 * Math.PI/180;
      const Œª1 = lon1 * Math.PI/180, Œª2 = lon2 * Math.PI/180;
      const y = Math.sin(Œª2-Œª1) * Math.cos(œÜ2);
      const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);
      const Œ∏ = Math.atan2(y, x) * 180/Math.PI;
      return degNormalize(Œ∏);
    }

    function enableCompass(){
      const iOS = typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function';
      const handler = (e)=>{
        if (typeof e.webkitCompassHeading === 'number') {
          deviceHeading = e.webkitCompassHeading;  // iOS
        } else if (typeof e.alpha === 'number') {
          deviceHeading = 360 - e.alpha;           // best-effort
        }
        liveGuideTick();
      };
      if (iOS) {
        const checkbox = document.getElementById('guideEnable');
        checkbox?.addEventListener('change', ()=>{
          if(checkbox.checked){
            DeviceOrientationEvent.requestPermission()
              .then(state=>{ if(state === 'granted'){ window.addEventListener('deviceorientation', handler, true); }})
              .catch(()=>{});
          } else {
            window.removeEventListener('deviceorientation', handler, true);
            deviceHeading = null;
          }
        });
      } else {
        window.addEventListener('deviceorientationabsolute', handler, true);
        window.addEventListener('deviceorientation', handler, true);
      }
    }

    function pickFrontPoi(){
      if(!userLocation) return null;
      // candidati: liveGuides statici + attrazioni OSM gi√† caricate + categoria musei/monumenti
      const all = [
        ...liveGuides,
        ...(places.attractions||[]),
        ...(places.monuments||[]),
        ...(places.museums||[])
      ].map(p=>{
        const dist = calculateDistance(userLocation.lat, userLocation.lng, p.lat, p.lng);
        const brg  = bearingTo(userLocation.lat, userLocation.lng, p.lat, p.lng);
        return {...p, _dist: dist, _brg: brg, radius: p.radius || 120, fov: p.fov || 80 };
      }).filter(p => p._dist <= p.radius);

      if(!all.length) return null;

      let front = all;
      if (deviceHeading != null) {
        front = all.filter(p => degDiff(deviceHeading, p._brg) <= (p.fov / 2));
        if(!front.length) front = all;
      }
      front.sort((a,b) => a._dist - b._dist);
      return front[0];
    }

    function updateLiveGuideUI(poi, wikiData){
      const onEl  = document.getElementById('guideNow');
      const offEl = document.getElementById('guideNone');
      const sectionsEl = document.getElementById('guideSections');

      if(!poi){
        onEl.style.display = 'none';
        offEl.style.display = 'block';
        sectionsEl.innerHTML = '';
        return;
      }
      onEl.style.display = 'block';
      offEl.style.display = 'none';

      const title = poi.name || wikiData?.title || 'Attrazione';
      const blurb = (wikiData?.extract || poi.description || '').trim();
      document.getElementById('guideTitle').textContent = title;
      document.getElementById('guideBlurb').textContent = blurb || '‚Äî';
      document.getElementById('guideDistance').textContent = `Distanza: ${Math.round(poi._dist)} m`;

      const imgEl = document.getElementById('guideImg');
      if (wikiData?.thumbnail) imgEl.src = wikiData.thumbnail;
      else if (poi.image) imgEl.src = poi.image;

      // sezioni (per ora breve; potremmo spezzare l‚Äôextract in paragrafi)
      sectionsEl.innerHTML = '';

      // freccia direzione
      const arrow = document.getElementById('arrowFov');
      if (deviceHeading != null) {
        const rel = degNormalize(poi._brg - deviceHeading);
        arrow.style.transform = `translateX(-50%) rotate(${rel}deg)`;
      } else {
        arrow.style.transform = `translateX(-50%) rotate(0deg)`;
      }

      // collega pulsante ‚ÄúVai qui‚Äù
      const btnNav = document.getElementById('guideNavigate');
      btnNav.onclick = ()=> openGoogleMaps(poi.lat, poi.lng, 'walking', userLocation?.lat ?? hotelLocation.lat, userLocation?.lng ?? hotelLocation.lng);

      // audio: prepara testo completo (se troppo lungo, resta comunque ok)
      const textToSpeak = `${title}. ${blurb}`;
      document.getElementById('guidePlay').onclick   = ()=> tts.speak(textToSpeak);
      document.getElementById('guidePause').onclick  = ()=> tts.pause();
      document.getElementById('guideResume').onclick = ()=> tts.resume();
      document.getElementById('guideStop').onclick   = ()=> tts.stop();
      document.getElementById('guideRepeat').onclick = ()=> tts.speak(textToSpeak);
    }

    async function liveGuideTick(){
      const enabled = document.getElementById('guideEnable')?.checked;
      if(!enabled){
        document.getElementById('guideNow').style.display = 'none';
        document.getElementById('guideNone').style.display = 'block';
        return;
      }
      const poi = pickFrontPoi();
      if(!poi){ updateLiveGuideUI(null); return; }

      // arricchisci da Wikipedia/Wikidata
      const wiki = await enrichPlaceWithWikipedia(poi).catch(()=>null);
      updateLiveGuideUI(poi, wiki);

      // auto-play con cooldown (se audio attivo)
      const voiceOn = document.getElementById('guideVoice')?.checked;
      const now = Date.now();
      if (voiceOn && poi.id !== lastGuideId && now - lastAnnounceTs > guideCooldown) {
        const text = `${poi.name}. ${(wiki?.extract || poi.description || '')}`;
        tts.speak(text);
        lastGuideId = poi.id || (poi.name + '@' + poi.lat + ',' + poi.lng);
        lastAnnounceTs = now;
      }
    }

    /* =======================
       Eventi UI
    ======================= */
    document.addEventListener('DOMContentLoaded', ()=>{
      initMap();
      updateDistances();
      renderPlaces('monuments');
      showPlacesOnMap('monuments');

      document.getElementById('locationBtn').addEventListener('click', centerOnUser);

      document.querySelectorAll('.category-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const cat = this.dataset.category;
          if(!cat) return;
          document.querySelectorAll('.category-btn').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          currentCategory = cat;
          renderPlaces(cat, document.getElementById('searchBar').value);
          showPlacesOnMap(cat);
        });
      });

      document.querySelectorAll('.sort-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          document.querySelectorAll('.sort-btn').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          currentSort = this.dataset.sort;
          if(currentSort==='distance' && !userLocation){ centerOnUser(); }
          renderPlaces(currentCategory, document.getElementById('searchBar').value);
        });
      });

      const activeFilters = [];
      document.getElementById('searchBar').addEventListener('input', e=>{
        renderPlaces(currentCategory, e.target.value, activeFilters);
      });
      document.querySelectorAll('.chip').forEach(chip=>{
        chip.addEventListener('click', function(){
          const f = this.dataset.filter;
          if(this.classList.contains('active')){
            this.classList.remove('active');
            const i = activeFilters.indexOf(f);
            if(i>-1) activeFilters.splice(i,1);
          }else{
            this.classList.add('active');
            activeFilters.push(f);
          }
          renderPlaces(currentCategory, document.getElementById('searchBar').value, activeFilters);
        });
      });

      document.getElementById('btnLoadAttractions').addEventListener('click', ()=>{
        const base = userLocation || hotelLocation;
        currentCategory = 'attractions';
        document.querySelectorAll('.category-btn').forEach(b=>{
          if(b.dataset.category) b.classList.toggle('active', b.dataset.category==='attractions');
        });
        loadAttractionsFromOverpass(base.lat, base.lng, 6000);
      });

      // Caricamento automatico iniziale (4km dall'hotel)
      loadAttractionsFromOverpass(hotelLocation.lat, hotelLocation.lng, 4000);

      // Modal chiudi
      document.querySelector('.close').addEventListener('click', ()=> { document.getElementById('navigationModal').style.display = 'none'; });
      window.addEventListener('click', (e)=>{ const modal = document.getElementById('navigationModal'); if(e.target === modal){ modal.style.display = 'none'; } });

      // PANNELLO AIRTAG
      const btnOpenFindMy = document.getElementById('btnOpenFindMy');
      const btnFindMyHelp = document.getElementById('btnFindMyHelp');
      const btnSaveTag = document.getElementById('btnSaveTag');
      const btnUseMyPos = document.getElementById('btnUseMyPos');
      const btnApple = document.getElementById('btnOpenAppleMaps');
      const btnGoogle = document.getElementById('btnOpenGoogleMaps');
      const tagName = document.getElementById('tagName');
      const tagLat  = document.getElementById('tagLat');
      const tagLng  = document.getElementById('tagLng');
      const tagInfo = document.getElementById('tagSavedInfo');

      const saved = JSON.parse(localStorage.getItem('savedTag') || 'null');
      if(saved){
        tagName.value = saved.name || '';
        tagLat.value  = saved.lat  ?? '';
        tagLng.value  = saved.lng  ?? '';
        tagInfo.textContent = `Salvato: ${saved.name||'-'} (${saved.lat}, ${saved.lng})`;
      }

      btnOpenFindMy.addEventListener('click', ()=>{
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if(isIOS){
          window.location.href = 'findmy://';
          setTimeout(()=>alert('Se Dov‚Äô√® non si √® aperta, aprila manualmente: Apple non offre link/API diretti per un AirTag specifico.'), 800);
        } else {
          alert('Il collegamento ‚ÄúDov‚Äô√®‚Äù √® disponibile solo su iOS. Usa l‚ÄôiPhone/iPad per aprire l‚Äôapp.');
        }
      });

      btnFindMyHelp.addEventListener('click', ()=>{ alert('Gli AirTag non hanno API web: questo bottone prova ad aprire l‚Äôapp Dov‚Äô√® su iOS. Puoi salvare coordinate e navigarci.'); });

      btnSaveTag.addEventListener('click', ()=>{
        const n = tagName.value.trim() || 'Oggetto';
        const la = parseFloat(tagLat.value);
        const ln = parseFloat(tagLng.value);
        if(Number.isFinite(la) && Number.isFinite(ln)){
          localStorage.setItem('savedTag', JSON.stringify({name:n, lat:la, lng:ln}));
          tagInfo.textContent = `Salvato: ${n} (${la}, ${ln})`;
          alert('Coordinate salvate.');
        } else { alert('Inserisci coordinate valide (lat/lng).'); }
      });

      btnUseMyPos.addEventListener('click', ()=>{
        if(userLocation){
          tagLat.value = userLocation.lat.toFixed(6);
          tagLng.value = userLocation.lng.toFixed(6);
        } else {
          centerOnUser();
          alert('Posizione in acquisizione: riprova tra un attimo.');
