<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vienna Tour Guide - Guida Interattiva</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #fff;
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
        }

        .app-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* Map Container */
        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Location Info Panel - Overlay */
        .location-panel {
            position: absolute;
            bottom: -100%;
            left: 0;
            right: 0;
            background: white;
            padding: 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            z-index: 999;
            max-height: 70vh;
            overflow: hidden;
            transition: bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            display: flex;
            flex-direction: column;
        }

        .location-panel.active {
            bottom: 0;
        }

        /* Drag Handle */
        .drag-handle {
            width: 50px;
            height: 4px;
            background: #ccc;
            border-radius: 2px;
            margin: 10px auto;
            cursor: grab;
        }

        .close-panel {
            position: absolute;
            right: 20px;
            top: 15px;
            background: rgba(0,0,0,0.1);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 11;
            font-size: 1.2rem;
            color: #666;
        }

        .close-panel:hover {
            background: rgba(0,0,0,0.2);
        }

        .location-panel-content {
            overflow-y: auto;
            flex: 1;
            padding: 0 20px 20px 20px;
            -webkit-overflow-scrolling: touch;
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding-top: 10px;
        }

        .location-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
            padding-right: 40px;
        }

        .location-type {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .location-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .location-description {
            color: #444;
            line-height: 1.8;
            margin-bottom: 20px;
            font-size: 1rem;
            text-align: justify;
        }

        .location-description h3 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .location-description p {
            margin-bottom: 15px;
        }

        .location-description ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .location-description li {
            margin-bottom: 8px;
        }

        /* Audio Controls */
        .audio-controls {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .audio-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .audio-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .audio-btn.pause {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
        }

        .audio-progress {
            flex: 1;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }

        .audio-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .audio-time {
            font-size: 0.9rem;
            color: #666;
            min-width: 80px;
            text-align: center;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-btn.hotel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        /* Floating Action Button */
        .fab {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 998;
            transition: all 0.3s;
        }

        .fab:hover {
            transform: scale(1.1) rotate(15deg);
        }

        /* POI List */
        .poi-list {
            position: absolute;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 997;
            transition: left 0.3s;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .poi-list.active {
            left: 0;
        }

        .poi-list-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .poi-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .poi-item:hover {
            background: #f8f8f8;
        }

        .poi-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .poi-info {
            flex: 1;
        }

        .poi-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .poi-distance {
            font-size: 0.9rem;
            color: #999;
        }

        /* Custom Marker Styles */
        .custom-marker {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50% 50% 50% 0;
            border: 2px solid white;
            width: 30px;
            height: 30px;
            position: relative;
            transform: rotate(-45deg);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .marker-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            color: white;
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.2rem;
            }
            
            .location-panel {
                max-height: 80vh;
            }
            
            .poi-list {
                width: 100%;
                left: -100%;
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideDown 0.3s ease;
            max-width: 80%;
            text-align: center;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-map-marked-alt"></i>
                Vienna Tour Guide
            </h1>
            <div class="header-controls">
                <button class="header-btn" onclick="togglePOIList()">
                    <i class="fas fa-list"></i>
                </button>
                <button class="header-btn" onclick="centerOnUser()">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Map -->
            <div id="map"></div>

            <!-- POI List -->
            <div class="poi-list" id="poiList">
                <div class="poi-list-header">
                    <i class="fas fa-star"></i> Luoghi da Visitare
                </div>
                <div id="poiListContent"></div>
            </div>

            <!-- Location Panel -->
            <div class="location-panel" id="locationPanel">
                <div class="drag-handle"></div>
                <button class="close-panel" onclick="closeLocationPanel()">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="location-panel-content">
                    <div class="location-header">
                        <h2 class="location-title" id="locationTitle">Seleziona un luogo</h2>
                        <span class="location-type" id="locationType">Info</span>
                    </div>
                    
                    <img class="location-image" id="locationImage" src="" alt="Location" style="display: none;">
                    
                    <div class="location-description" id="locationDescription">
                        Esplora i meravigliosi luoghi di Vienna con la nostra guida interattiva.
                    </div>

                    <div class="audio-controls">
                        <button class="audio-btn" id="playBtn" onclick="toggleAudio()">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="audio-progress">
                            <div class="audio-progress-bar" id="progressBar"></div>
                        </div>
                        <div class="audio-time" id="audioTime">0:00 / 0:00</div>
                    </div>

                    <div class="nav-buttons">
                        <button class="nav-btn" id="navigateBtn" onclick="navigateToLocation()">
                            <i class="fas fa-route"></i>
                            Naviga qui
                        </button>
                        <button class="nav-btn hotel" onclick="navigateToHotel()">
                            <i class="fas fa-hotel"></i>
                            Il mio Hotel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Floating Action Button -->
            <button class="fab" onclick="showNearbyPOIs()">
                <i class="fas fa-map-pin"></i>
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
        // App State
        let map;
        let userMarker;
        let currentLocation = null;
        let selectedPOI = null;
        let isPlaying = false;
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;

        // Hotel Information
        const HOTEL = {
            name: "Boutique Hotel Das Tigra",
            address: "Tiefer Graben 14-20, 1010 Wien",
            lat: 48.2115,
            lng: 16.3680,
            description: "Il tuo elegante hotel boutique nel cuore di Vienna"
        };

        // Points of Interest
        const POIs = [
            {
                id: 1,
                name: "Schönbrunn Palace",
                type: "Palazzo",
                lat: 48.1845,
                lng: 16.3122,
                image: "https://images.unsplash.com/photo-1519677100203-a0e668c92439?w=800",
                description: `<h3>Il Palazzo Imperiale di Schönbrunn</h3>
                    <p>Il Palazzo di Schönbrunn è uno dei più importanti monumenti culturali dell'Austria. Con le sue 1.441 stanze, è uno dei più grandi complessi barocchi d'Europa.</p>
                    <h3>Storia</h3>
                    <p>Costruito nel XVII secolo come residenza estiva imperiale degli Asburgo. Maria Teresa d'Austria lo trasformò nel palazzo che vediamo oggi.</p>`,
                audioText: "Benvenuti al magnifico Palazzo di Schönbrunn. Questo maestoso palazzo barocco fu la residenza estiva della famiglia imperiale austriaca. Con i suoi splendidi giardini e le sale riccamente decorate, rappresenta uno dei più importanti monumenti culturali dell'Austria."
            },
            {
                id: 2,
                name: "Cattedrale di Santo Stefano",
                type: "Chiesa",
                lat: 48.2084,
                lng: 16.3731,
                image: "https://images.unsplash.com/photo-1609856878074-cf31e21ccf-0?w=800",
                description: `<h3>Stephansdom - Il Cuore di Vienna</h3>
                    <p>La Cattedrale di Santo Stefano è il simbolo di Vienna. La guglia sud alta 136 metri domina il centro storico.</p>`,
                audioText: "La maestosa Cattedrale di Santo Stefano si erge nel cuore di Vienna da oltre 800 anni. Il suo tetto colorato e la guglia gotica sono diventati il simbolo della città."
            },
            {
                id: 3,
                name: "Hofburg",
                type: "Palazzo",
                lat: 48.2069,
                lng: 16.3658,
                image: "https://images.unsplash.com/photo-1559564484-e48b3e040ff4?w=800",
                description: `<h3>Il Palazzo Imperiale Hofburg</h3>
                    <p>Per oltre 600 anni centro del potere austriaco, oggi sede del Presidente e numerosi musei.</p>`,
                audioText: "L'Hofburg è stato il centro del potere imperiale per sei secoli. Questo enorme complesso ospita oggi musei, la Biblioteca Nazionale e la Scuola di Equitazione Spagnola."
            },
            {
                id: 4,
                name: "Belvedere",
                type: "Museo",
                lat: 48.1915,
                lng: 16.3807,
                image: "https://images.unsplash.com/photo-1587302164675-820fe61bbd55?w=800",
                description: `<h3>Palazzo Belvedere</h3>
                    <p>Capolavoro barocco che ospita la più grande collezione di Klimt al mondo, incluso il famoso "Bacio".</p>`,
                audioText: "Il Belvedere è un magnifico palazzo barocco circondato da splendidi giardini. Qui potrete ammirare il celebre Bacio di Gustav Klimt."
            },
            {
                id: 5,
                name: "Prater",
                type: "Parco",
                lat: 48.2168,
                lng: 16.3958,
                image: "https://images.unsplash.com/photo-1569163139394-de4798aa62b6?w=800",
                description: `<h3>Il Prater</h3>
                    <p>Grande parco pubblico famoso per la ruota panoramica Riesenrad, simbolo di Vienna.</p>`,
                audioText: "Il Prater vi accoglie con la sua iconica ruota panoramica. Questo grande parco offre divertimento e relax nel verde."
            },
            {
                id: 6,
                name: "Kunsthistorisches Museum",
                type: "Museo",
                lat: 48.2036,
                lng: 16.3615,
                image: "https://images.unsplash.com/photo-1581683705068-ca8f49fc7f45?w=800",
                description: `<h3>Museo di Storia dell'Arte</h3>
                    <p>Uno dei musei più importanti al mondo con capolavori di Bruegel, Raffaello, Vermeer e Rubens.</p>`,
                audioText: "Il Kunsthistorisches Museum custodisce le collezioni imperiali degli Asburgo. Un tesoro di capolavori dell'arte europea."
            },
            {
                id: 7,
                name: "Naschmarkt",
                type: "Mercato",
                lat: 48.1987,
                lng: 16.3628,
                image: "https://images.unsplash.com/photo-1555992643-a97955e6e6fb?w=800",
                description: `<h3>Il Mercato Naschmarkt</h3>
                    <p>Il mercato più famoso di Vienna con oltre 120 bancarelle di prodotti freschi e specialità internazionali.</p>`,
                audioText: "Il Naschmarkt è il ventre di Vienna. Questo vivace mercato offre sapori da tutto il mondo in un'atmosfera unica."
            },
            {
                id: 8,
                name: "Opera di Stato",
                type: "Teatro",
                lat: 48.2029,
                lng: 16.3690,
                image: "https://images.unsplash.com/photo-1580809878711-492e1e8f6b00?w=800",
                description: `<h3>La Wiener Staatsoper</h3>
                    <p>Uno dei teatri d'opera più prestigiosi al mondo. L'edificio neo-rinascimentale ospita circa 350 spettacoli all'anno.</p>`,
                audioText: "La Staatsoper è il tempio della musica classica. Qui si sono esibiti i più grandi artisti della storia dell'opera."
            }
        ];

        // Initialize Map
        function initMap() {
            // Vienna city center coordinates
            map = L.map('map').setView([48.2082, 16.3738], 13);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Add POI markers
            POIs.forEach(poi => {
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div class="custom-marker"><div class="marker-icon"><i class="fas fa-star"></i></div></div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                });

                const marker = L.marker([poi.lat, poi.lng], { icon })
                    .addTo(map)
                    .on('click', () => selectPOI(poi));

                marker.bindTooltip(poi.name, {
                    permanent: false,
                    direction: 'top'
                });
            });

            // Add Hotel marker
            const hotelIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div class="custom-marker" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><div class="marker-icon"><i class="fas fa-hotel"></i></div></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });

            L.marker([HOTEL.lat, HOTEL.lng], { icon: hotelIcon })
                .addTo(map)
                .bindPopup(`<strong>${HOTEL.name}</strong><br>${HOTEL.address}`);

            // Get user location
            getUserLocation();
            
            // Update POI list
            updatePOIList();
        }

        // Get User Location
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    position => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        if (userMarker) {
                            userMarker.setLatLng([currentLocation.lat, currentLocation.lng]);
                        } else {
                            const userIcon = L.divIcon({
                                className: 'current-location-marker',
                                html: `<div style="width: 20px; height: 20px; background: #4285F4; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>`,
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            });

                            userMarker = L.marker([currentLocation.lat, currentLocation.lng], { icon: userIcon })
                                .addTo(map)
                                .bindPopup("La tua posizione");
                        }

                        updateDistances();
                    },
                    error => {
                        console.error("Errore geolocalizzazione:", error);
                        currentLocation = { lat: 48.2082, lng: 16.3738 };
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 5000
                    }
                );
            }
        }

        // Calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance < 1 ? `${Math.round(distance * 1000)}m` : `${distance.toFixed(1)}km`;
        }

        // Update distances
        function updateDistances() {
            if (!currentLocation) return;

            const listContent = document.getElementById('poiListContent');
            listContent.innerHTML = '';

            POIs.forEach(poi => {
                const distance = calculateDistance(
                    currentLocation.lat, currentLocation.lng,
                    poi.lat, poi.lng
                );

                const poiItem = document.createElement('div');
                poiItem.className = 'poi-item';
                poiItem.onclick = () => {
                    selectPOI(poi);
                    togglePOIList();
                };

                poiItem.innerHTML = `
                    <div class="poi-icon">
                        <i class="fas fa-${getIconForType(poi.type)}"></i>
                    </div>
                    <div class="poi-info">
                        <div class="poi-name">${poi.name}</div>
                        <div class="poi-distance">${distance} da te</div>
                    </div>
                `;

                listContent.appendChild(poiItem);
            });
        }

        // Get icon for POI type
        function getIconForType(type) {
            const icons = {
                'Palazzo': 'crown',
                'Chiesa': 'church',
                'Museo': 'palette',
                'Parco': 'tree',
                'Mercato': 'shopping-basket',
                'Teatro': 'theater-masks'
            };
            return icons[type] || 'star';
        }

        // Select POI
        function selectPOI(poi) {
            selectedPOI = poi;
            
            document.getElementById('locationTitle').textContent = poi.name;
            document.getElementById('locationType').textContent = poi.type;
            document.getElementById('locationDescription').innerHTML = poi.description;
            
            const img = document.getElementById('locationImage');
            img.src = poi.image;
            img.style.display = 'block';

            document.getElementById('locationPanel').classList.add('active');
