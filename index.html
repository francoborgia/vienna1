<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vienna Tourist Guide ‚Äì Das Tigra (Audioguida + Galleria + Navigazione)</title>

<!-- Leaflet core -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Routing (OSRM pubblico: profilo driving) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<style>
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);margin:0}
  .wrap{max-width:1300px;margin:0 auto;padding:16px}
  .card{background:#fff;border-radius:18px;box-shadow:0 14px 40px rgba(0,0,0,.18);overflow:hidden}
  header{padding:16px 20px;border-bottom:1px solid #eee;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  header h1{font-size:1.2rem;margin:0;color:#5b3fa5}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
  button,.btn{border:0;background:#6d5bd0;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
  button.secondary{background:#f0f0f5;color:#3d3a62}
  button.ghost{background:#fff;color:#5b3fa5;border:1px solid #dcd5ff}
  button:disabled{opacity:.55;cursor:not-allowed}
  a.btn{text-decoration:none;display:inline-block}
  .layout{display:grid;grid-template-columns:1.8fr 1fr;gap:14px;padding:14px}
  #map{height:70vh;min-height:420px;border-radius:14px}
  .sidebar{display:flex;flex-direction:column;gap:12px}
  .panel{background:#faf9ff;border:1px solid #ece9ff;border-radius:14px;padding:12px}
  .panel h2{font-size:1.05rem;margin:.2rem 0 .4rem;color:#5b3fa5}
  .poi-list{display:grid;gap:10px;max-height:34vh;overflow:auto;padding-right:6px}
  .poi{display:grid;grid-template-columns:64px 1fr;gap:10px;background:#fff;border:1px solid #eee;border-radius:12px;padding:8px}
  .poi img{width:64px;height:64px;object-fit:cover;border-radius:10px}
  .poi .name{font-weight:600}
  .small{font-size:.9rem;color:#5b5b6a}
  .tts{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tts select{padding:8px;border-radius:10px;border:1px solid #ddd;max-width:100%}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#eee;color:#555;font-size:.75rem;margin-left:6px}
  .footer{padding:12px 16px;border-top:1px solid #eee;color:#666;font-size:.9rem}

  /* Galleria */
  .gallery{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
  .gallery-main{position:relative;border-radius:12px;overflow:hidden;border:1px solid #e9e6ff}
  .gallery-main img{width:100%;height:220px;object-fit:cover;display:block;background:#f1efff}
  .gallery-controls{display:flex;gap:8px}
  .chapter{display:inline-block;padding:2px 8px;border-radius:999px;background:#efeaff;color:#5b3fa5;font-size:.75rem;margin-right:6px}
  .current-chapter{font-weight:600}

  .top-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  @media (max-width: 980px){ .layout{grid-template-columns:1fr;} #map{height:58vh} .poi-list{max-height:28vh} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>Vienna Tourist Guide ‚Ä¢ Boutique Hotel Das Tigra</h1>
      <div class="controls">
        <button id="locateBtn" class="secondary" title="Usa la mia posizione">üìç La mia posizione</button>
        <button id="toHotelBtn" title="Naviga verso l‚Äôhotel">üè® Torna all‚Äôhotel</button>
        <button id="toAirportBtn" title="Vai all‚Äôaeroporto">‚úàÔ∏è Vai all‚Äôaeroporto</button>
      </div>
    </header>

    <div class="layout">
      <div id="map"></div>

      <aside class="sidebar">
        <div class="panel" id="voicePanel">
          <h2>Guida vocale a capitoli</h2>
          <div style="margin-bottom:6px">
            <span class="chapter" id="chIntro">Intro</span>
            <span class="chapter" id="chStoria">Storia</span>
            <span class="chapter" id="chCuriosita">Curiosit√†</span>
            <span class="chapter" id="chOrari">Orari/Costi</span>
          </div>
          <div class="tts">
            <button id="playBtn">‚ñ∂Ô∏è Play</button>
            <button id="nextBtn" class="ghost">‚è≠Ô∏è Capitolo successivo</button>
            <button id="pauseBtn" class="secondary">‚è∏Ô∏è Pausa</button>
            <button id="resumeBtn" class="secondary">‚èØÔ∏è Riprendi</button>
            <button id="stopBtn" class="secondary">‚èπÔ∏è Stop</button>
            <select id="voiceSelect" title="Scegli voce"></select>
          </div>
          <div class="small">Scegli una voce <b>it-IT</b> o ‚Äúnatural/neural‚Äù. L‚Äôaudio parte solo dopo il tuo tocco su <b>Play</b>.</div>

          <!-- Galleria foto -->
          <div class="gallery" id="galleryBox" style="display:none">
            <div class="gallery-main">
              <img id="galleryImage" alt="Foto monumento" loading="lazy" />
            </div>
            <div class="gallery-controls">
              <button id="prevImg" class="ghost">‚¨ÖÔ∏è</button>
              <button id="nextImg" class="ghost">‚û°Ô∏è</button>
              <span id="imgCounter" class="small" style="margin-left:8px"></span>
            </div>
          </div>
        </div>

        <div class="panel">
          <h2>Punti d‚Äôinteresse <span class="badge">tocca per dettagli</span></h2>
          <div id="poiList" class="poi-list"></div>
        </div>

        <div class="panel" id="detailsPanel">
          <h2>Dettagli luogo</h2>
          <div class="small">Seleziona un luogo dalla lista o dalla mappa per vedere foto, capitoli e navigazione.</div>
        </div>

        <div class="panel">
          <h2>Navigazione rapida</h2>
          <div class="small">Scegli un luogo e avvia il percorso: su mappa (auto) o apri Google Maps per piedi/auto/mezzi.</div>
          <div class="top-actions">
            <button id="routeFromMeCar" class="secondary">üöó Da me</button>
            <button id="routeFromHotelCar" class="secondary">üöó Da hotel</button>
            <a id="gmapsWalk" class="btn" target="_blank" rel="noopener">üó∫Ô∏è Google Maps a piedi</a>
            <a id="gmapsDrive" class="btn" target="_blank" rel="noopener">üó∫Ô∏è Google Maps in auto</a>
            <a id="gmapsTransit" class="btn" target="_blank" rel="noopener">üöá Mezzi pubblici</a>
          </div>
        </div>
      </aside>
    </div>

    <div class="footer">
      Testi sintetici ‚Äústile enciclopedico‚Äù incorporati; orari/costi possono variare. Immagini da Wikimedia/ufficiali (con fallback).
    </div>
  </div>
</div>

<script>
/* === CONFIG DI BASE ====================================================== */
const hotel = { name: "Boutique Hotel Das Tigra", lat: 48.21142, lng: 16.37058 };
const airport = { name: "Vienna International Airport (VIE)", lat: 48.1103, lng: 16.5697 };

const FALLBACK_IMG = "data:image/svg+xml;utf8," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='640' height='360'><rect width='100%' height='100%' fill='#eee'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='18' fill='#666'>Foto</text></svg>`);

/* Utility immagine con referrer policy + fallback */
function imgHTML(src, alt, extra=""){
  const safe = src || FALLBACK_IMG;
  return `<img loading="lazy" referrerpolicy="no-referrer" src="${safe}"
           alt="${alt}" onerror="this.onerror=null;this.src='${FALLBACK_IMG}'" ${extra}>`;
}

/* POI con capitoli e galleria (lista ampliata per professionalit√†) */
const POI = [
  // Centro storico
  {
    name: "Stephansdom (Cattedrale di Santo Stefano)",
    lat: 48.20849, lng: 16.37312,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/7/79/Wien_-_Stephansdom_%281%29.JPG",
      "https://upload.wikimedia.org/wikipedia/commons/9/9e/St._Stephen%27s_Cathedral_%28roof%29%2C_Vienna%2C_Austria.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/2/2a/St._Stephen%27s_Cathedral_interior_September_2017.jpg"
    ],
    url: "https://it.wikipedia.org/wiki/Cattedrale_di_Santo_Stefano_(Vienna)",
    intro: "La Cattedrale di Santo Stefano √® il simbolo religioso di Vienna, famosa per il tetto di tegole policrome e la guglia sud.",
    storia: "Le origini risalgono al XII secolo; ampliamenti gotici e restauri moderni ne hanno definito l‚Äôaspetto attuale.",
    curiosita: "La guglia sud supera i 136 metri; dalla torre si domina il centro storico.",
    orari: "Navata gratuita; torri, catacombe e tesoro a pagamento."
  },
  {
    name: "Hofburg (Palazzo Imperiale)",
    lat: 48.20655, lng: 16.36400,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/9/9a/Hofburg_-_Michaelertrakt.JPG",
      "https://upload.wikimedia.org/wikipedia/commons/2/2a/Nationalbibliothek_Reading_Room.jpg"
    ],
    url: "https://it.wikipedia.org/wiki/Hofburg",
    intro: "L‚ÄôHofburg √® l‚Äôantica residenza imperiale nel cuore di Vienna.",
    storia: "Dal XIII secolo si √® espansa fino alla Neue Burg; oggi ospita musei e istituzioni statali.",
    curiosita: "Include gli Appartamenti Imperiali, il Museo di Sisi e la Biblioteca Nazionale.",
    orari: "Musei a pagamento; corti esterne libere."
  },
  {
    name: "Albertina",
    lat: 48.20395, lng: 16.36837,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/b/bf/Albertina_Museum%2C_Vienna.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/8/8b/Albertina_entrance_Vienna.jpg"
    ],
    url: "https://it.wikipedia.org/wiki/Albertina",
    intro: "L‚ÄôAlbertina custodisce una delle pi√π grandi raccolte di grafica al mondo.",
    storia: "Fondata nel 1776 dall‚Äôarciduca Alberto di Sassonia-Teschen, ampliata nei secoli.",
    curiosita: "Celebre per i fogli di D√ºrer e gli impressionisti.",
    orari: "Museo a pagamento; orari variabili."
  },
  {
    name: "Staatsoper (Opera di Stato)",
    lat: 48.20276, lng: 16.36947,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/9/99/Vienna_State_Opera_2019.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/1/1c/Staatsoper_interior_Vienna.jpg"
    ],
    url: "https://it.wikipedia.org/wiki/Opera_di_Stato_di_Vienna",
    intro: "La Staatsoper √® tra i teatri d‚Äôopera pi√π prestigiosi.",
    storia: "Inaugurata nel 1869; ricostruita dopo la guerra e riaperta nel 1955.",
    curiosita: "Famoso il ballo dell‚Äôopera; stagione con cast di livello mondiale.",
    orari: "Visite guidate a pagamento quando non ci sono spettacoli."
  },
  {
    name: "Karlskirche (Chiesa di San Carlo)",
    lat: 48.19881, lng: 16.37245,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/8/8b/Karlskirche_Wien_abends.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/4/49/Karlskirche_Interior_Vienna.jpg"
    ],
    url: "https://it.wikipedia.org/wiki/Chiesa_di_San_Carlo_Borromeo_(Vienna)",
    intro: "Capolavoro barocco con grande cupola verde e colonne ispirate a Traiano.",
    storia: "Costruita nel XVIII secolo per voto dell‚Äôimperatore Carlo VI.",
    curiosita: "Ascensore interno per avvicinarsi agli affreschi della cupola.",
    orari: "Ingresso a pagamento; orari variabili."
  },
  {
    name: "Secessione di Vienna",
    lat: 48.20084, lng: 16.36364,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/f/f8/Secession_Building_Vienna.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/4/44/Beethovenfries_klimt.jpg"
    ],
    url: "https://it.wikipedia.org/wiki/Secessione_di_Vienna_(edificio)",
    intro: "Edificio simbolo dell‚ÄôArt Nouveau viennese, noto per la cupola dorata.",
    storia: "Sede dell‚Äôomonimo movimento artistico fondato nel 1897.",
    curiosita: "Conserva il celebre Fregio di Beethoven di Gustav Klimt.",
    orari: "Mostre a pagamento; orari espositivi."
  },
  {
    name: "Rathaus (Municipio)",
    lat: 48.21008, lng: 16.35723,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/3/33/Wiener_Rathaus_abends.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/5/59/Rathausplatz_Wien_Sommer.jpg"
    ],
    url: "https://it.wikipedia.org/wiki/Municipio_di_Vienna",
    intro: "Municipio neogotico affacciato su Rathausplatz, teatro di eventi e mercatini.",
    storia: "Costruito tra 1872 e 1883 su progetto di Friedrich von Schmidt.",
    curiosita: "La torre centrale √® sormontata dal Rathausmann.",
    orari: "Visite e eventi con orari variabili."
  },
  {
    name: "Parlamento Austriaco",
    lat: 48.20825, lng: 16.36162,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/0/0b/Parlament_Wien_2016.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/0/0e/Pallas_Athene_fountain_Vienna.jpg"
    ],
    url: "https://it.wikipedia.org/wiki/Parlamento_austriaco",
    intro: "Imponente edificio neoclassico con la fontana di Pallade Atena.",
    storia: "Progettato da Theophil Hansen e inaugurato nel 1883.",
    curiosita: "Interni con aule moderne dopo recente restauro.",
    orari: "Visite guidate a pagamento; verifica calendario."
  },
  // Musei/arte
  {
    name: "Belvedere (Il Bacio di Klimt)",
    lat: 48.19136, lng: 16.38087,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/2/2f/Schloss_Belvedere%2C_Wien.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/7/73/Gustav_Klimt_016.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/2/2a/Belvedere_Gardens_Vienna.jpg"
    ],
    url: "https://www.belvedere.at/it",
    intro: "Complesso barocco con collezioni d‚Äôarte austriaca e ‚ÄòIl Bacio‚Äô di Klimt.",
    storia: "Residenza del Principe Eugenio, composto da Superiore e Inferiore.",
    curiosita: "Il dipinto aureo di Klimt √® icona del museo.",
    orari: "Museo a pagamento; giardini in parte liberi."
  },
  {
    name: "MuseumsQuartier",
    lat: 48.20343, lng: 16.35986,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/0/0f/MuseumsQuartier_Leopold_Museum.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/8/8d/Mumok_Museum%2C_Vienna_%282815456824%29.jpg"
    ],
    url: "https://www.mqw.at/",
    intro: "Grande distretto culturale con Leopold Museum e mumok.",
    storia: "Nato dalla riqualificazione delle ex scuderie imperiali.",
    curiosita: "Corti animate con eventi e installazioni.",
    orari: "Musei a pagamento; spazi esterni liberi."
  },
  {
    name: "Haus der Musik (Casa della Musica)",
    lat: 48.20308, lng: 16.37245,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/5/50/Haus_der_Musik_Wien_1.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/5/5d/Haus_der_Musik_Vienna_Exhibit.jpg"
    ],
    url: "https://www.hausdermusik.com/en/",
    intro: "Museo interattivo dedicato al suono e ai grandi compositori.",
    storia: "Aperto nel 2000 in un palazzo storico del centro.",
    curiosita: "Orchestra virtuale e installazioni sonore.",
    orari: "Biglietto a pagamento; orari serali estesi."
  },
  // Parchi e svago
  {
    name: "Sch√∂nbrunn (Palazzo e Giardini)",
    lat: 48.18452, lng: 16.31218,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/6/6b/Schloss_Sch%C3%B6nbrunn_Wien_2014_%282%29.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/2/2e/Gloriette_Sch%C3%B6nbrunn.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/3/3c/Sch%C3%B6nbrunn_gardens_2014.jpg"
    ],
    url: "https://it.wikipedia.org/wiki/Palazzo_di_Sch%C3%B6nbrunn",
    intro: "Residenza estiva degli Asburgo e sito UNESCO.",
    storia: "Barocco con oltre mille stanze; giardini storici e zoo del 1752.",
    curiosita: "Gloriette con vista scenografica sulla citt√†.",
    orari: "Museo a pagamento; giardini in gran parte gratuiti."
  },
  {
    name: "Prater e Ruota panoramica",
    lat: 48.21667, lng: 16.39750,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/3/3b/Wiener_Riesenrad_2005.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/7/70/Wurstelprater_entrance.jpg"
    ],
    url: "https://it.wikipedia.org/wiki/Ruota_panoramica_di_Vienna",
    intro: "Grande parco urbano con lunapark storico.",
    storia: "Aperto al pubblico nel XVIII secolo; ruota del 1897.",
    curiosita: "Vista dall‚Äôalto e atmosfera serale vivace.",
    orari: "Parco libero; attrazioni a pagamento."
  },
  {
    name: "Naschmarkt",
    lat: 48.19857, lng: 16.36130,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/5/5f/Naschmarkt_2015.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/f/f6/Naschmarkt_Vienna_food_stalls.jpg"
    ],
    url: "https://de.wikipedia.org/wiki/Naschmarkt",
    intro: "Mercato storico all‚Äôaperto con cibo internazionale e locale.",
    storia: "Attivo dal XVI secolo, si estende lungo la Wienzeile.",
    curiosita: "Il sabato mattina c‚Äô√® anche un mercatino delle pulci.",
    orari: "Aperture dei banchi variabili; vivace a pranzo."
  },
  // Architetture particolari
  {
    name: "Hundertwasserhaus",
    lat: 48.20704, lng: 16.39454,
    images: [
      "https://upload.wikimedia.org/wikipedia/commons/6/6f/Hundertwasserhaus_Vienna.jpg",
      "https://upload.wikimedia.org/wikipedia/commons/d/d8/Hundertwasser_Village.jpg"
    ],
    url: "https://it.wikipedia.org/wiki/Hundertwasserhaus",
    intro: "Residenza variopinta e irregolare di Hundertwasser.",
    storia: "Realizzata negli anni ‚Äô80 con linee ondulate e tetti verdi.",
    curiosita: "Vicino, l‚ÄôHundertwasser Village prosegue lo stesso stile.",
    orari: "Esterni liberi; negozi e museo vicini."
  }
];

/* === MAPPA =============================================================== */
let map, userMarker, routingControl = null;

function initMap(){
  map = L.map('map').setView([hotel.lat, hotel.lng], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

  const hotelIcon = L.icon({
    iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/6/6e/Map_marker_icon_%E2%80%93_Nicolas_Mollet_%E2%80%93_Hotel_%E2%80%93_Tourism_%E2%80%93_Dark.png',
    iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -24]
  });
  L.marker([hotel.lat, hotel.lng], {icon: hotelIcon})
    .addTo(map).bindPopup(`<b>${hotel.name}</b><br>Base della tua visita.`);

  // Markers POI
  POI.forEach((p, idx)=>{
    const m = L.marker([p.lat, p.lng]).addTo(map);
    m.bindPopup(`
      <div style="display:grid;grid-template-columns:72px 1fr;gap:8px;min-width:260px">
        ${imgHTML(p.images[0], p.name, "style='width:72px;height:72px;object-fit:cover;border-radius:10px'")}
        <div>
          <b>${p.name}</b><br>
          <small>${p.intro}</small><br>
          <a href="${p.url}" target="_blank" rel="noopener">Approfondisci</a>
          <div style="margin-top:6px">
            <button onclick="navigateTo(${idx}, true)">üöó Da me</button>
            <button onclick="navigateTo(${idx}, false)">üöó Da hotel</button>
          </div>
        </div>
      </div>
    `);
    m.on('click', ()=> selectPOI(idx, true));
  });

  // Click vuoto mappa = torna allo stato iniziale
  map.on('click', ()=>{
    selectedPOI = null;
    updateDetailsPanel(null);
    buildChaptersFor(null);
  });
}
initMap();

/* === LISTA LATERALE ====================================================== */
const poiListEl = document.getElementById('poiList');
function renderPOIList(){
  poiListEl.innerHTML = '';
  POI.forEach((p, idx)=>{
    const el = document.createElement('div');
    el.className = 'poi';
    el.innerHTML = `
      ${imgHTML(p.images[0], p.name)}
      <div>
        <div class="name">${p.name}</div>
        <div class="small">${p.intro}</div>
      </div>
    `;
    el.addEventListener('click', ()=> selectPOI(idx, true));
    poiListEl.appendChild(el);
  });
}
renderPOIList();

/* === SELEZIONE POI + GALLERIA + DETTAGLI ================================= */
let selectedPOI = null;
let galleryIndex = 0;

const galleryBox = document.getElementById('galleryBox');
const galleryImg = document.getElementById('galleryImage');
const imgCounter = document.getElementById('imgCounter');
const details = document.getElementById('detailsPanel');

function showGallery(poi){
  if(!poi || !poi.images || poi.images.length === 0){ galleryBox.style.display = 'none'; return; }
  galleryBox.style.display = 'grid';
  galleryIndex = 0;
  updateGalleryImage(poi);
}
function updateGalleryImage(poi){
  if(!poi.images || poi.images.length === 0) return;
  const url = poi.images[galleryIndex];
  galleryImg.setAttribute("referrerpolicy","no-referrer");
  galleryImg.src = url || FALLBACK_IMG;
  galleryImg.onerror = ()=> { galleryImg.onerror=null; galleryImg.src = FALLBACK_IMG; };
  imgCounter.textContent = `Immagine ${galleryIndex+1} di ${poi.images.length}`;
}
document.getElementById('prevImg').addEventListener('click', ()=>{
  if(!selectedPOI) return;
  galleryIndex = (galleryIndex - 1 + selectedPOI.images.length) % selectedPOI.images.length;
  updateGalleryImage(selectedPOI);
});
document.getElementById('nextImg').addEventListener('click', ()=>{
  if(!selectedPOI) return;
  galleryIndex = (galleryIndex + 1) % selectedPOI.images.length;
  updateGalleryImage(selectedPOI);
});

function updateDetailsPanel(p){
  if(!p){
    details.innerHTML = `<h2>Dettagli luogo</h2><div class="small">Seleziona un luogo per vedere foto, capitoli e navigazione.</div>`;
    return;
  }
  details.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
      <h2 style="margin:0">${p.name}</h2>
      <button id="backBtn" class="secondary">‚¨ÖÔ∏è Indietro</button>
    </div>
    <div class="gallery" style="margin-top:6px">
      ${imgHTML(p.images[0]||FALLBACK_IMG, p.name, "id='gimg' style='width:100%;height:220px;object-fit:cover;border-radius:12px;border:1px solid #e9e6ff'")}
      <div class="gallery-controls">
        <button class="ghost" id="gprev">‚¨ÖÔ∏è</button>
        <button class="ghost" id="gnext">‚û°Ô∏è</button>
        <span id="gcount" class="small" style="margin-left:8px"></span>
      </div>
    </div>
    <div class="small" style="margin-top:8px">
      <b>Approfondisci:</b> <a href="${p.url}" target="_blank" rel="noopener">${p.url.replace(/^https?:\/\//,'')}</a>
    </div>
    <div class="top-actions" style="margin-top:8px">
      <button id="routeFromMeBtn" class="secondary">üöó Traccia mappa: da me</button>
      <button id="routeFromHotelBtn" class="secondary">üöó Traccia mappa: da hotel</button>
      <a id="gmapsWalkD" class="btn" target="_blank" rel="noopener">üó∫Ô∏è Google Maps a piedi</a>
      <a id="gmapsDriveD" class="btn" target="_blank" rel="noopener">üó∫Ô∏è Google Maps in auto</a>
      <a id="gmapsTransitD" class="btn" target="_blank" rel="noopener">üöá Mezzi pubblici</a>
    </div>
  `;

  // Back
  details.querySelector('#backBtn').addEventListener('click', ()=>{
    selectedPOI = null;
    updateDetailsPanel(null);
    buildChaptersFor(null);
    map.setView([hotel.lat, hotel.lng], 14);
    try{ speechSynthesis.cancel(); }catch(e){}
  });

  // Gallery in dettagli
  const gimg = details.querySelector('#gimg');
  const gprev = details.querySelector('#gprev');
  const gnext = details.querySelector('#gnext');
  const gcount = details.querySelector('#gcount');
  let gidx = 0;
  function refresh(){
    const url = p.images[gidx] || FALLBACK_IMG;
    gimg.setAttribute("referrerpolicy","no-referrer");
    gimg.src = url;
    gimg.onerror = ()=>{ gimg.onerror=null; gimg.src = FALLBACK_IMG; };
    gcount.textContent = `Immagine ${gidx+1} di ${p.images.length}`;
  }
  gprev.addEventListener('click', ()=>{ gidx = (gidx - 1 + p.images.length) % p.images.length; refresh(); });
  gnext.addEventListener('click', ()=>{ gidx = (gidx + 1) % p.images.length; refresh(); });
  refresh();

  // Link Google Maps per dettagli
  updateGmapsLinksForDetails(true);
  details.querySelector('#routeFromMeBtn').addEventListener('click', ()=>{
    navigateTo(POI.indexOf(p), true);
  });
  details.querySelector('#routeFromHotelBtn').addEventListener('click', ()=>{
    navigateTo(POI.indexOf(p), false);
  });
}

function selectPOI(index, pan){
  selectedPOI = POI[index];
  if(pan){ map.setView([selectedPOI.lat, selectedPOI.lng], 16); }
  showGallery(selectedPOI);
  updateAllGmapsLinks();
  updateDetailsPanel(selectedPOI);
  buildChaptersFor(selectedPOI);
}

/* === GEOLOCALIZZAZIONE =================================================== */
let userPos = null;
document.getElementById('locateBtn').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert("Geolocalizzazione non disponibile."); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    userPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    if(userMarker) userMarker.remove();
    userMarker = L.marker([userPos.lat, userPos.lng], {title:"La mia posizione"}).addTo(map);
    map.setView([userPos.lat, userPos.lng], 15);
    updateAllGmapsLinks();
  }, (err)=> alert("Impossibile ottenere la posizione: " + err.message), {enableHighAccuracy:true,timeout:10000});
});
document.getElementById('toHotelBtn').addEventListener('click', ()=>{
  if(!userPos){ alert("Prima attiva la tua posizione con ‚ÄúLa mia posizione‚Äù."); return; }
  routeBetween(userPos, {lat: hotel.lat, lng: hotel.lng});
});

/* === NAVIGAZIONE & ROUTING (mappa = driving) ============================ */
function distanceMeters(a,b){
  const R=6371000, toRad = d=> d*Math.PI/180;
  const dLat = toRad(b.lat-a.lat), dLng = toRad(b.lng-a.lng);
  const s1 = Math.sin(dLat/2)**2;
  const s2 = Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s1+s2));
}
function routeBetween(start, end){
  if(routingControl){ map.removeControl(routingControl); routingControl = null; }
  routingControl = L.Routing.control({
    waypoints: [ L.latLng(start.lat, start.lng), L.latLng(end.lat, end.lng) ],
    router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }), // driving
    lineOptions: {addWaypoints:false},
    show:false
  }).addTo(map);
}
function navigateTo(poiIndex, fromUser){
  const p = POI[poiIndex];
  if(fromUser){
    if(!userPos){ alert("Attiva prima la tua posizione (üìç)."); return; }
    routeBetween(userPos, {lat:p.lat,lng:p.lng});
  }else{
    routeBetween({lat:hotel.lat,lng:hotel.lng}, {lat:p.lat,lng:p.lng});
  }
  selectedPOI = p;
  updateAllGmapsLinks();
  updateDetailsPanel(selectedPOI);
}

/* === LINK GOOGLE MAPS (sidebar) ========================================= */
const gmapsWalk = document.getElementById('gmapsWalk');
const gmapsDrive = document.getElementById('gmapsDrive');
const gmapsTransit = document.getElementById('gmapsTransit');

function currentOriginCoords(){
  return (userPos ? `${userPos.lat},${userPos.lng}` : `${hotel.lat},${hotel.lng}`);
}
function gmapsUrlTo(lat, lng, mode){
  const origin = currentOriginCoords();
  const travelmode = mode === 'walk' ? 'walking' : mode === 'drive' ? 'driving' : 'transit';
  return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${lat},${lng}&travelmode=${travelmode}`;
}
function updateAllGmapsLinks(){
  if(!selectedPOI){ gmapsWalk.href = gmapsDrive.href = gmapsTransit.href = "#"; return; }
  gmapsWalk.href   = gmapsUrlTo(selectedPOI.lat, selectedPOI.lng, 'walk');
  gmapsDrive.href  = gmapsUrlTo(selectedPOI.lat, selectedPOI.lng, 'drive');
  gmapsTransit.href= gmapsUrlTo(selectedPOI.lat, selectedPOI.lng, 'transit');
}

/* Link Google Maps nel pannello dettagli (se presente) */
function updateGmapsLinksForDetails(fromUser=true){
  if(!selectedPOI) return;
  const w = details.querySelector('#gmapsWalkD');
  const d = details.querySelector('#gmapsDriveD');
  const t = details.querySelector('#gmapsTransitD');
  if(!w||!d||!t) return;
  const origin = fromUser && userPos ? `${userPos.lat},${userPos.lng}` : `${hotel.lat},${hotel.lng}`;
  const base = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${selectedPOI.lat},${selectedPOI.lng}`;
  w.href = base + "&travelmode=walking";
  d.href = base + "&travelmode=driving";
  t.href = base + "&travelmode=transit";
}

/* Pulsanti routing sidebar */
document.getElementById('routeFromMeCar').addEventListener('click', ()=>{
  if(!selectedPOI){ alert("Seleziona prima un luogo."); return; }
  if(!userPos){ alert("Attiva prima la tua posizione (üìç)."); return; }
  routeBetween(userPos, {lat:selectedPOI.lat,lng:selectedPOI.lng});
});
document.getElementById('routeFromHotelCar').addEventListener('click', ()=>{
  if(!selectedPOI){ alert("Seleziona prima un luogo."); return; }
  routeBetween({lat:hotel.lat,lng:hotel.lng}, {lat:selectedPOI.lat,lng:selectedPOI.lng});
});

/* === AEROPORTO: tasto rapido + voce ===================================== */
document.getElementById('toAirportBtn').addEventListener('click', ()=>{
  // Traccia su mappa dall‚Äôorigine corrente all‚Äôaeroporto
  const start = userPos ? userPos : {lat:hotel.lat, lng:hotel.lng};
  routeBetween(start, {lat:airport.lat, lng:airport.lng});
  // Aggiorna link GM
  selectedPOI = { name: airport.name, lat: airport.lat, lng: airport.lng,
    intro: "Stai impostando il percorso verso l‚Äôaeroporto internazionale di Vienna.",
    storia: "", curiosita: "", orari: "Per i collegamenti consigliati usa la modalit√† mezzi pubblici su Google Maps: Railjet, CAT o S-Bahn S7."
  };
  updateAllGmapsLinks();
  updateDetailsPanel(selectedPOI);
  buildChaptersFor(selectedPOI);
  // Una breve voce di servizio (premi Play per capitoli completi)
  speakNow("Percorso verso l‚Äôaeroporto pronto. Per i mezzi pubblici apri Google Maps in modalit√† transit.");
});

/* === GUIDA VOCALE A CAPITOLI ============================================ */
let synth = window.speechSynthesis;
let voices = [];
let voicesLoaded = false;
let ttsUnlocked = false;

let chapterQueue = [];
let currentChapterIndex = 0;

const chIntro = document.getElementById('chIntro');
const chStoria = document.getElementById('chStoria');
const chCuriosita = document.getElementById('chCuriosita');
const chOrari = document.getElementById('chOrari');

function markChapter(){
  [chIntro, chStoria, chCuriosita, chOrari].forEach(el=> el.classList.remove('current-chapter'));
  const ref = [chIntro,chStoria,chCuriosita,chOrari][currentChapterIndex] || null;
  if(ref){ ref.classList.add('current-chapter'); }
}

function loadVoices(){
  voices = synth.getVoices().sort((a,b)=> a.lang.localeCompare(b.lang));
  voicesLoaded = voices && voices.length>0;
  const sel = document.getElementById('voiceSelect');
  sel.innerHTML = voicesLoaded ? "" : "<option>Caricamento voci‚Ä¶</option>";
  if(!voicesLoaded) return;
  const preferred = v => /it-IT/i.test(v.lang) || /Italian/i.test(v.name) || /Neural|Premium|Natural/i.test(v.name);
  const sorted = [...voices].sort((a,b)=> (preferred(b)-preferred(a)));
  sorted.forEach((v)=>{
    const opt = document.createElement('option');
    opt.value = voices.indexOf(v);
    opt.textContent = `${v.name} (${v.lang})`;
    sel.appendChild(opt);
  });
}
loadVoices();
if(typeof speechSynthesis!=="undefined"){ speechSynthesis.onvoiceschanged = loadVoices; }

function unlockTTS(){
  if(ttsUnlocked) return;
  ttsUnlocked = true;
  try{
    const u = new SpeechSynthesisUtterance(" ");
    u.volume = 0;
    synth.speak(u);
    setTimeout(()=> synth.cancel(), 0);
  }catch(e){}
}

function buildChaptersFor(p){
  if(!p){
    chapterQueue = ["Benvenuto a Vienna. Base al Boutique Hotel Das Tigra. Seleziona un punto per iniziare la guida."];
    currentChapterIndex = 0; markChapter(); return;
  }
  const parts = [p.intro, p.storia, p.curiosita, (p.orari||"")].filter(t=>t && t.trim().length);
  chapterQueue = parts.length ? parts : ["Non ci sono capitoli disponibili per questo luogo."];
  currentChapterIndex = 0; markChapter();
}

function chunkText(text, maxLen=180){
  const sentences = text.split(/(?<=[\.\!\?])\s+/);
  const chunks = [];
  let buf = "";
  for(const s of sentences){
    if((buf + " " + s).trim().length > maxLen){ if(buf) chunks.push(buf.trim()); buf = s; }
    else { buf = (buf ? buf + " " : "") + s; }
  }
  if(buf) chunks.push(buf.trim());
  return chunks;
}

function getChosenVoice(){
  const sel = document.getElementById('voiceSelect');
  const idx = Number(sel.value);
  let v = voices[idx];
  if(!v){ v = voices.find(v=>/it-IT/i.test(v.lang)) || voices[0]; }
  return v || null;
}

let speaking = false;
function stopAll(){ try{ synth.cancel(); }catch(e){} speaking = false; }

async function speakChapter(index){
  if(index<0 || index>=chapterQueue.length) return;
  const voice = getChosenVoice();
  const parts = chunkText(chapterQueue[index]);
  for(let i=0;i<parts.length;i++){
    if(!speaking) return;
    await new Promise(resolve=>{
      const u = new SpeechSynthesisUtterance(parts[i]);
      if(voice){ u.voice = voice; u.lang = voice.lang; } else { u.lang = "it-IT"; }
      u.rate = 0.95; u.pitch = 1.0;
      u.onend = ()=> resolve();
      synth.speak(u);
    });
  }
}
async function speakChaptersFrom(startIndex){
  speaking = true;
  for(let i=startIndex;i<chapterQueue.length;i++){
    currentChapterIndex = i; markChapter();
    await speakChapter(i);
    if(!speaking) return;
  }
  speaking = false;
}
function speakNow(text){
  stopAll();
  const voice = getChosenVoice();
  const parts = chunkText(text);
  speaking = true;
  (async ()=>{
    for(const t of parts){
      if(!speaking) break;
      await new Promise(res=>{
        const u = new SpeechSynthesisUtterance(t);
        if(voice){ u.voice = voice; u.lang = voice.lang; } else { u.lang = "it-IT"; }
        u.rate = 0.95; u.pitch = 1.0; u.onend = ()=> res(); synth.speak(u);
      });
    }
    speaking = false;
  })();
}

/* Controlli voce */
document.getElementById('playBtn').addEventListener('click', ()=>{
  unlockTTS();
  if(!selectedPOI) buildChaptersFor(null);
  stopAll(); speakChaptersFrom(0);
});
document.getElementById('nextBtn').addEventListener('click', ()=>{
  if(!chapterQueue.length) return;
  stopAll(); const next = Math.min(currentChapterIndex+1, chapterQueue.length-1);
  speakChaptersFrom(next);
});
document.getElementById('pauseBtn').addEventListener('click', ()=>{ if(synth.speaking && !synth.paused) synth.pause(); });
document.getElementById('resumeBtn').addEventListener('click', ()=>{ if(synth.paused) synth.resume(); });
document.getElementById('stopBtn').addEventListener('click', stopAll);

/* Stato iniziale */
buildChaptersFor(null);
markChapter();

/* === SELEZIONE POI dalla sidebar o mappa ================================= */
function selectPOI(index, pan){
  selectedPOI = POI[index];
  if(pan){ map.setView([selectedPOI.lat, selectedPOI.lng], 16); }
  showGallery(selectedPOI);
  updateAllGmapsLinks();
  updateDetailsPanel(selectedPOI);
  buildChaptersFor(selectedPOI);
}
</script>
</body>
</html>
