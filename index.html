<!DOCTYPE html><html lang="it"><head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vienna Trip Navigator ‚Äì Enhanced with Smart Navigation</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .container { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; height: 100vh; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .map-section { background: rgba(255,255,255,0.95); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); overflow: hidden; display: flex; flex-direction: column; min-height: 0; }
    .sidebar { background: rgba(255,255,255,0.95); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); backdrop-filter: blur(10px); padding: 20px; overflow-y: auto; }
    .header { background: linear-gradient(45deg, #4f46e5, #7c3aed); color: white; padding: 20px; text-align: center; }
    .header h1 { margin: 0; font-size: 28px; font-weight: 700; }
    .header p { margin: 8px 0 0; opacity: 0.9; font-size: 14px; }
    .controls { padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    #map { flex: 1; min-height: 0; height: 100%; min-height: 320px; }
    .btn { padding: 8px 16px; border-radius: 10px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all .2s ease; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; border: none; font-size: 14px; text-decoration: none; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: #4f46e5; color: white; } .btn-success { background: #059669; color: white; } .btn-info { background: #0ea5e9; color: white; } .btn-warning { background: #f59e0b; color: white; } .btn-secondary { background: #ffffff; border: 1px solid #e2e8f0; color: #374151; }
    .sidebar h3 { color: #1e293b; font-size: 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    .poi-card { margin-bottom: 12px; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; transition: all .2s ease; }
    .poi-card:hover { border-color: #4f46e5; box-shadow: 0 4px 16px rgba(79, 70, 229, 0.1); transform: translateY(-2px); }
    .poi-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 10px; }
    .poi-title { font-weight: 700; color: #1e293b; font-size: 16px; flex: 1; }
    .poi-meta { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .chip { font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px; border: 1px solid; white-space: nowrap; }
    .chip-distance { border-color: #e2e8f0; background: #f8fafc; color: #64748b; }
    .chip-walking { border-color: #bbf7d0; background: #f0fdf4; color: #166534; }
    .chip-transit { border-color: #bfdbfe; background: #eff6ff; color: #1d4ed8; }
    .chip-free { border-color: #bbf7d0; background: #f0fdf4; color: #166534; }
    .chip-paid { border-color: #fecaca; background: #fff1f2; color: #b91c1c; }
    .poi-description { font-size: 14px; color: #64748b; margin: 8px 0; line-height: 1.4; }
    .poi-price { font-size: 13px; color: #059669; font-weight: 600; margin: 4px 0; }
    .poi-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    .hotel-section { margin-bottom: 25px; padding: 20px; background: linear-gradient(45deg, #10b981, #059669); border-radius: 12px; color: white; }
    .hotel-section h3 { color: white; margin-bottom: 15px; }
    .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
    .status-online { background: #10b981; } .status-offline { background: #ef4444; }
    @media (max-width: 768px) { .container { grid-template-columns: 1fr; grid-template-rows: 1fr auto; gap: 10px; padding: 10px; } .sidebar { max-height: 40vh; } }
  </style>
</head><body>
  <div class="container">
    <div class="map-section">
      <div class="header">
        <h1>üèõÔ∏è Vienna Explorer</h1>
        <p>Navigazione intelligente con geolocalizzazione e percorsi ottimizzati</p>
      </div>
      <div class="controls">
        <button id="locateBtn" class="btn btn-primary">üìç Usa GPS</button>
        <button id="manualBtn" class="btn btn-secondary">üñêÔ∏è Posizione manuale</button>
        <button id="fetchFastFoodBtn" class="btn btn-warning">üçî Carica fast food</button>
        <div style="flex: 1;"></div>
        <label style="display: flex; align-items: center; gap: 5px; font-size: 14px;"><input type="checkbox" id="toggleMonuments" checked> üèõÔ∏è Monumenti</label>
        <label style="display: flex; align-items: center; gap: 5px; font-size: 14px;"><input type="checkbox" id="toggleFastFood" checked> üçî Fast Food</label>
      </div>
      <div id="map"></div>
    </div>
    <div class="sidebar">
      <div class="hotel-section">
        <h3>üè® Il Tuo Hotel</h3>
        <div style="margin-bottom: 15px;">
          <strong>Boutique Hotel Das Tigra</strong><br>
          <small>Tiefer Graben 14-20, 1010 Wien</small>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <a class="btn btn-info" target="_blank" href="https://www.google.com/maps/dir/?api=1&origin=Vienna+International+Airport&destination=Boutique+Hotel+Das+Tigra+Vienna&travelmode=transit">üöá Da VIE</a>
          <button class="btn btn-secondary" onclick="showOnMap(48.2127, 16.3717)">üìç Mostra</button>
        </div>
      </div>
      <h3>üèõÔ∏è Monumenti e Attrazioni</h3>
      <div id="poiList"></div>
      <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; text-align: center;">
        <small style="color: #64748b;">
          <span class="status-indicator status-online"></span>
          Navigazione intelligente attiva<br>
          ‚â§500m = üö∂ A piedi | >500m = üöá Mezzi pubblici
        </small>
      </div>
    </div>
  </div>
  <script>
    // Variabili globali
    let map, layerMonuments, layerFastFood, userLocation, userMarker, radiusCircle, manualMode = false;

    // Avvio sicuro: controlla Leaflet
    window.addEventListener('load', function(){
      function boot(){ if (typeof L === 'undefined') { alert('Errore: libreria mappe non caricata. Verifica la connessione o se l\'hosting blocca i CDN.'); return; } initializeApp(); }
      if (typeof L === 'undefined') {
        // Fallback: prova jsDelivr in caso unpkg sia bloccato
        var alt = document.createElement('script'); alt.src = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'; alt.onload = boot; document.head.appendChild(alt);
        var altCss = document.createElement('link'); altCss.rel='stylesheet'; altCss.href='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css'; document.head.appendChild(altCss);
        // Se entro 2s non carica, mostra avviso
        setTimeout(function(){ if (typeof L === 'undefined') alert('Leaflet non disponibile: controlla la tua rete o la Content-Security-Policy dell\'hosting.'); }, 2000);
      } else { boot(); }
    });
        return;
      }
      initializeApp();
    });

    function initializeApp() {
      // Configurazione icone
      function makeIcon(color, symbol = '‚óè') {
        const svg = encodeURIComponent(`
          <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' width='32' height='32'>
            <circle cx='16' cy='16' r='14' fill='${color}' stroke='white' stroke-width='3'/>
            <text x='16' y='20' text-anchor='middle' font-size='12' fill='white'>${symbol}</text>
          </svg>
        `);
        return L.icon({ iconUrl: `data:image/svg+xml,${svg}`, iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -16] });
      }
      const icons = { monument: makeIcon('#3b82f6', 'üèõ'), fastFood: makeIcon('#f59e0b', 'üçî'), hotel: makeIcon('#10b981', 'üè®'), user: makeIcon('#1f2937', 'üìç') };

      // Inizializzazione mappa
      map = L.map('map').setView([48.2082, 16.3738], 13);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
      setTimeout(() => map.invalidateSize(), 300);
      window.addEventListener('resize', () => { try { map.invalidateSize(); } catch(_){} });

      // Layer groups
      layerMonuments = L.layerGroup().addTo(map);
      layerFastFood  = L.layerGroup().addTo(map);

      // Hotel marker
      L.marker([48.2127, 16.3717], {icon: icons.hotel}).addTo(map).bindPopup('<b>üè® Boutique Hotel Das Tigra</b><br>Il tuo alloggio a Vienna');

      // Database monumenti completo con prezzi
      const MONUMENTS = [
        { name: 'Cattedrale di Santo Stefano (Stephansdom)', lat: 48.2084, lng: 16.3731, desc: 'Il simbolo gotico di Vienna con la sua torre alta 137m. Capolavoro dell\'architettura medievale nel cuore della citt√†.', paid: false, price: 'Ingresso cattedrale: GRATIS | Torre Sud: ‚Ç¨6 | Catacombe: ‚Ç¨7 | Tour completo: ‚Ç¨10', duration: '1-2 ore', wiki: 'https://it.wikipedia.org/wiki/Duomo_di_Santo_Stefano_(Vienna)', type: 'Religioso' },
        { name: 'Palazzo Hofburg', lat: 48.2065, lng: 16.3656, desc: 'Residenza imperiale degli Asburgo per oltre 600 anni. Complesso di palazzi, musei e cappelle nel centro storico.', paid: true, price: 'Biglietto combinato: ‚Ç¨18 | Appartamenti Imperiali: ‚Ç¨16 | Museo Sissi: ‚Ç¨16 | Argenteria: ‚Ç¨16', duration: '2-4 ore', wiki: 'https://it.wikipedia.org/wiki/Hofburg', type: 'Palazzo' },
        { name: 'Castello di Sch√∂nbrunn', lat: 48.1845, lng: 16.3122, desc: 'Residenza estiva imperiale con 1441 stanze e magnifici giardini barocchi. Patrimonio UNESCO dal 1996.', paid: true, price: 'Imperial Tour: ‚Ç¨22 | Grand Tour: ‚Ç¨28 | Giardini: GRATIS | Labirinto: ‚Ç¨7 | Zoo: ‚Ç¨24', duration: '3-5 ore', wiki: 'https://it.wikipedia.org/wiki/Castello_di_Sch%C3%B6nbrunn', type: 'Palazzo' },
        { name: 'Palazzo del Belvedere', lat: 48.1913, lng: 16.3805, desc: 'Capolavoro barocco che ospita "Il Bacio" di Klimt e la pi√π grande collezione di arte austriaca al mondo.', paid: true, price: 'Belvedere Superiore: ‚Ç¨18 | Belvedere Inferiore: ‚Ç¨16 | Biglietto combinato: ‚Ç¨26 | Giardini: GRATIS', duration: '2-3 ore', wiki: 'https://it.wikipedia.org/wiki/Belvedere_(Vienna)', type: 'Museo' },
        { name: 'Ruota Panoramica del Prater (Riesenrad)', lat: 48.2165, lng: 16.3956, desc: 'Iconica ruota panoramica del 1897, alta 65 metri. Simbolo di Vienna e location di famosi film.', paid: true, price: 'Adulti: ‚Ç¨14 | Bambini (3-14): ‚Ç¨6 | Cabina VIP: ‚Ç¨35 | Prater Park: GRATIS', duration: '30-45 minuti', wiki: 'https://it.wikipedia.org/wiki/Riesenrad', type: 'Attrazione' },
        { name: 'MuseumsQuartier', lat: 48.2028, lng: 16.3599, desc: 'Uno dei pi√π grandi quartieri culturali al mondo con musei, caff√®, negozi e spazi per eventi.', paid: false, price: 'Area pubblica: GRATIS | Leopold Museum: ‚Ç¨16 | MUMOK: ‚Ç¨12 | Kunsthalle: ‚Ç¨10', duration: '2-6 ore', wiki: 'https://it.wikipedia.org/wiki/MuseumsQuartier', type: 'Quartiere culturale' },
        { name: 'Rathaus (Municipio)', lat: 48.2100, lng: 16.3579, desc: 'Splendido municipio neogotico con torre di 98m. Sede del governo di Vienna e location di eventi.', paid: false, price: 'Esterni e parco: GRATIS | Tour guidati: ‚Ç¨8 (solo giorni specifici)', duration: '30-60 minuti', wiki: 'https://it.wikipedia.org/wiki/Municipio_di_Vienna', type: 'Architettura' },
        { name: 'Opera di Stato (Staatsoper)', lat: 48.2029, lng: 16.3683, desc: 'Uno dei teatri d\'opera pi√π prestigiosi al mondo. Inaugurata nel 1869, ospita 300 spettacoli all\'anno.', paid: true, price: 'Spettacoli: ‚Ç¨7-‚Ç¨300 | Tour guidati: ‚Ç¨12 | Standing tickets: ‚Ç¨3-‚Ç¨4', duration: '45 min (tour) / 3 ore (spettacolo)', wiki: 'https://it.wikipedia.org/wiki/Opera_di_Stato_di_Vienna', type: 'Teatro' },
        { name: 'Karlskirche (Chiesa di San Carlo)', lat: 48.1989, lng: 16.3692, desc: 'Capolavoro barocco con cupola alta 72 metri e affreschi spettacolari. Ascensore panoramico alla cupola.', paid: true, price: 'Ingresso con ascensore: ‚Ç¨9 | Solo chiesa: ‚Ç¨4 | Concerti: ‚Ç¨25-‚Ç¨45', duration: '45-90 minuti', wiki: 'https://it.wikipedia.org/wiki/Chiesa_di_San_Carlo_Borromeo_(Vienna)', type: 'Religioso' },
        { name: 'Hundertwasserhaus', lat: 48.2074, lng: 16.3968, desc: 'Edificio residenziale dall\'architettura colorata e fantasiosa di Friedensreich Hundertwasser.', paid: false, price: 'Esterni: GRATIS | Hundertwasser Village (centro commerciale): GRATIS | Museo: ‚Ç¨12', duration: '30-60 minuti', wiki: 'https://it.wikipedia.org/wiki/Hundertwasserhaus', type: 'Architettura' },
        { name: 'Naschmarkt', lat: 48.1982, lng: 16.3616, desc: 'Mercato storico pi√π famoso di Vienna dal XVI secolo. Oltre 120 bancarelle e ristoranti.', paid: false, price: 'Accesso: GRATIS | Cibo e prodotti: vari prezzi | Mercato delle pulci (sabato): GRATIS', duration: '1-2 ore', wiki: 'https://it.wikipedia.org/wiki/Naschmarkt', type: 'Mercato' },
        { name: 'Albertina', lat: 48.2047, lng: 16.3687, desc: 'Museo con la pi√π grande collezione di stampe al mondo. Opere di Monet, Picasso, D√ºrer e molto altro.', paid: true, price: 'Collezione principale: ‚Ç¨18 | Mostre temporanee: ‚Ç¨16 | Biglietto combinato: ‚Ç¨20', duration: '2-3 ore', wiki: 'https://it.wikipedia.org/wiki/Albertina_(Vienna)', type: 'Museo' },
        { name: 'Scuola Spagnola di Equitazione', lat: 48.2067, lng: 16.3665, desc: 'Tradizione equestre di 450 anni con cavalli Lipizzani. Spettacoli di dressage di altissimo livello.', paid: true, price: 'Spettacoli: ‚Ç¨29-‚Ç¨175 | Training session: ‚Ç¨16 | Tour delle scuderie: ‚Ç¨18', duration: '1-2 ore', wiki: 'https://it.wikipedia.org/wiki/Scuola_spagnola_di_equita_di_Vienna', type: 'Attrazione' },
        { name: 'Ringstrasse (Passeggiata)', lat: 48.2085, lng: 16.3580, desc: 'Famoso viale ad anello di 5,3 km che circonda il centro storico. Passeggiata tra monumenti storici.', paid: false, price: 'Passeggiata: GRATIS | Tram turistico: ‚Ç¨9 | Fiaker (carrozze): ‚Ç¨55-‚Ç¨110', duration: '2-4 ore a piedi', wiki: 'https://it.wikipedia.org/wiki/Ringstra%C3%9Fe', type: 'Passeggiata' },
        { name: 'Giardini di Sch√∂nbrunn', lat: 48.1856, lng: 16.3129, desc: 'Magnifici giardini barocchi con fontane, statue, labirinto e la Gloriette con vista panoramica.', paid: false, price: 'Giardini: GRATIS | Gloriette: ‚Ç¨6 | Labirinto: ‚Ç¨7 | Casa delle Palme: ‚Ç¨7', duration: '2-3 ore', wiki: 'https://it.wikipedia.org/wiki/Giardini_di_Sch%C3%B6nbrunn', type: 'Parco' },
        { name: 'Danubio e Donauinsel', lat: 48.2322, lng: 16.4102, desc: 'Isola artificiale di 21 km sul Danubio. Paradiso per sport acquatici, ciclismo e relax estivo.', paid: false, price: 'Accesso: GRATIS | Noleggio bici: ‚Ç¨15/giorno | Beach bars: vari prezzi', duration: '2-6 ore', wiki: 'https://it.wikipedia.org/wiki/Donauinsel', type: 'Natura' }
      ];

      // Utilit√†
      function toRad(degrees) { return degrees * Math.PI / 180; }
      function haversineDistance(lat1, lng1, lat2, lng2) { const R = 6371000; const dLat = toRad(lat2 - lat1); const dLng = toRad(lng2 - lng1); const a = Math.sin(dLat/2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2) ** 2; return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
      function formatDistance(meters) { return meters < 1000 ? `${Math.round(meters)}m` : `${(meters/1000).toFixed(1)}km`; }
      function getGoogleMapsUrl(origin, dest, mode) { const url = new URL('https://www.google.com/maps/dir/'); url.searchParams.set('api', '1'); if (origin) url.searchParams.set('origin', `${origin.lat},${origin.lng}`); url.searchParams.set('destination', `${dest.lat},${dest.lng}`); url.searchParams.set('travelmode', mode); return url.toString(); }

      // Posizione utente
      function updateUserLocation(lat, lng) {
        userLocation = {lat, lng};
        if (!userMarker) { userMarker = L.marker([lat, lng], {icon: icons.user}).addTo(map).bindPopup('üìç La tua posizione'); } else { userMarker.setLatLng([lat, lng]); }
        if (!radiusCircle) { radiusCircle = L.circle([lat, lng], { radius: 500, color: '#4f46e5', fillColor: '#6366f1', fillOpacity: 0.1, weight: 2, dashArray: '5, 5' }).addTo(map); } else { radiusCircle.setLatLng([lat, lng]); }
        map.setView([lat, lng], 15);
        updatePoiList();
      }

      // Geolocalizzazione
      document.getElementById('locateBtn').onclick = function() {
        manualMode = false;
        if (!navigator.geolocation) { alert('‚ùå Geolocalizzazione non supportata. Usa "Posizione manuale".'); return; }
        this.innerHTML = '‚è≥ Localizzazione...'; this.disabled = true;
        navigator.geolocation.getCurrentPosition(
          (position) => { updateUserLocation(position.coords.latitude, position.coords.longitude); this.innerHTML = '‚úÖ GPS attivo'; setTimeout(() => { this.innerHTML = 'üìç Usa GPS'; this.disabled = false; }, 2000); },
          (error) => { this.innerHTML = 'üìç Usa GPS'; this.disabled = false; alert(`‚ùå Errore GPS: ${error.message}

Suggerimenti:
‚Ä¢ Attiva il GPS
‚Ä¢ Consenti accesso alla posizione
‚Ä¢ Usa HTTPS`); },
          {enableHighAccuracy: true, timeout: 15000, maximumAge: 60000}
        );
      };
      document.getElementById('manualBtn').onclick = function() { manualMode = !manualMode; this.style.background = manualMode ? '#4f46e5' : '#ffffff'; this.style.color = manualMode ? 'white' : '#374151'; alert(manualMode ? '‚úÖ Modalit√† manuale attiva
Tocca la mappa per impostare la posizione' : '‚ùå Modalit√† manuale disattivata'); };
      map.on('click', (e) => { if (manualMode) { updateUserLocation(e.latlng.lat, e.latlng.lng); } });

      // Monumenti
      function loadMonuments() {
        layerMonuments.clearLayers();
        MONUMENTS.forEach(poi => {
          const marker = L.marker([poi.lat, poi.lng], {icon: icons.monument}).bindPopup(`
            <div style="min-width: 250px; max-width: 300px;">
              <b style="color: #1e293b; font-size: 16px;">${poi.name}</b><br>
              <small style="color: #6366f1; font-weight: 600;">${poi.type} ‚Ä¢ ${poi.duration}</small>
              <p style="margin: 8px 0; color: #64748b; font-size: 14px; line-height: 1.4;">${poi.desc}</p>
              <div style="background: #f8fafc; padding: 8px; border-radius: 6px; margin: 8px 0;">
                <strong style="color: #059669; font-size: 13px;">üí∞ Prezzi:</strong><br>
                <span style="font-size: 12px; color: #374151;">${poi.price}</span>
              </div>
              <span style="display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; ${poi.paid ? 'background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca;' : 'background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0;'}">${poi.paid ? 'üí∞ A pagamento' : 'üÜì Accesso gratuito'}</span>
              <br><br>
              <a href="${poi.wiki}" target="_blank" style="color: #4f46e5; font-size: 13px;">üìñ Leggi su Wikipedia ‚Üí</a>
            </div>
          `);
          layerMonuments.addLayer(marker);
        });
      }

      // Fast food via Overpass
      async function loadFastFood() {
        const btn = document.getElementById('fetchFastFoodBtn');
        btn.innerHTML = '‚è≥ Caricamento...'; btn.disabled = true;
        const bounds = map.getBounds();
        const query = `[out:json][timeout:25];(node["amenity"="fast_food"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}));out;`;
        try {
          const response = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', headers: {'Content-Type': 'text/plain; charset=UTF-8'}, body: query });
          if(!response.ok) throw new Error('HTTP '+response.status);
          const data = await response.json();
          layerFastFood.clearLayers();
          let count = 0;
          (data.elements || []).forEach(el => {
            if (typeof el.lat === 'number' && typeof el.lon === 'number') {
              const name = (el.tags && (el.tags.name || el.tags.brand)) || 'Fast Food';
              const cuisine = el.tags && el.tags.cuisine ? el.tags.cuisine : '';
              const marker = L.marker([el.lat, el.lon], {icon: icons.fastFood}).bindPopup(`<b style="color:#1e293b;">üçî ${name}</b><br>${cuisine ? `<small style=\"color:#64748b;\">Cucina: ${cuisine}</small>` : ''}`);
              layerFastFood.addLayer(marker); count++;
            }
          });
          btn.innerHTML = `‚úÖ ${count} trovati`; setTimeout(()=>{ btn.innerHTML='üçî Carica fast food'; btn.disabled=false; }, 2500);
        } catch (error) {
          console.error('Errore caricamento fast food:', error);
          btn.innerHTML = '‚ùå Errore'; setTimeout(()=>{ btn.innerHTML='üçî Carica fast food'; btn.disabled=false; }, 2500);
        }
      }

      // Toggle layer
      document.getElementById('toggleMonuments').onchange = (e) => { if (e.target.checked) map.addLayer(layerMonuments); else map.removeLayer(layerMonuments); };
      document.getElementById('toggleFastFood').onchange  = (e) => { if (e.target.checked) map.addLayer(layerFastFood);  else map.removeLayer(layerFastFood);  };
      document.getElementById('fetchFastFoodBtn').onclick = loadFastFood;

      // Rendering lista
      function createPoiCard(poi) {
        let distance = '‚Äî'; let travelMode = null; let mapsUrl = null;
        if (userLocation) { const dist = haversineDistance(userLocation.lat, userLocation.lng, poi.lat, poi.lng); distance = formatDistance(dist); travelMode = dist <= 500 ? 'walking' : 'transit'; mapsUrl = getGoogleMapsUrl(userLocation, {lat: poi.lat, lng: poi.lng}, travelMode); }
        const paidChip = poi.paid ? '<span class="chip chip-paid">üí∞ A pagamento</span>' : '<span class="chip chip-free">üÜì Gratis</span>';
        const travelChip = userLocation ? (travelMode === 'walking' ? '<span class="chip chip-walking">üö∂ A piedi ‚â§500m</span>' : '<span class="chip chip-transit">üöá Mezzi >500m</span>') : '';
        return `
          <div class="poi-card">
            <div class="poi-header">
              <div class="poi-title">${poi.name}</div>
              <div class="poi-meta"><span class="chip chip-distance">${distance}</span>${travelChip}</div>
            </div>
            <div style="font-size: 12px; color: #6366f1; font-weight: 600; margin-bottom: 6px;">${poi.type} ‚Ä¢ ‚è±Ô∏è ${poi.duration}</div>
            <div class="poi-description">${poi.desc}</div>
            <div class="poi-price">üí∞ ${poi.price}</div>
            <div style="margin: 8px 0;">${paidChip}</div>
            <div class="poi-actions">
              <button class="btn btn-secondary" onclick="showOnMap(${poi.lat}, ${poi.lng})">üéØ Mostra sulla mappa</button>
              ${mapsUrl ? `<a class="btn btn-primary" href="${mapsUrl}" target="_blank" rel="noopener">${travelMode === 'walking' ? 'üö∂' : 'üöá'} Google Maps</a>` : '<button class="btn" style="opacity: 0.5; pointer-events: none;">üìç Imposta posizione</button>'}
              <a class="btn btn-secondary" href="${poi.wiki}" target="_blank" rel="noopener">üìñ Wikipedia</a>
            </div>
          </div>`;
      }

      function updatePoiList() {
        const list = document.getElementById('poiList'); if (!list) return;
        let sortedPois = [...MONUMENTS];
        if (userLocation) { sortedPois.sort((a, b) => haversineDistance(userLocation.lat, userLocation.lng, a.lat, a.lng) - haversineDistance(userLocation.lat, userLocation.lng, b.lat, b.lng)); }
        list.innerHTML = sortedPois.map(poi => createPoiCard(poi)).join('');
      }

      window.showOnMap = function(lat, lng) { map.setView([lat, lng], 16); };

      // Init
      loadMonuments();
      updatePoiList();
      setTimeout(loadFastFood, 1000);
    }
  // Diagnostica errori runtime ‚Üí mostra nella sidebar
    window.addEventListener('error', function(e){
      try{
        var box=document.getElementById('poiList');
        if(box){ var d=document.createElement('div'); d.style.cssText='margin:8px 0;padding:8px;border:1px solid #fecaca;background:#fff1f2;color:#7f1d1d;border-radius:8px'; d.textContent='Errore script: '+(e.message||'sconosciuto'); box.prepend(d);} 
      }catch(_){ }
      console.error(e);
    });
  </script>
</body></html>
