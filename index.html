<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vienna Tourist Guide</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    h1{text-align:center;color:#764ba2;margin-bottom:30px;font-size:2.3em;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .map-container{height:500px;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2);margin-bottom:30px;position:relative}
    #map{height:100%;width:100%}
    .row{display:grid;grid-template-columns:2fr 1fr;gap:20px}
    @media(max-width:1000px){.row{grid-template-columns:1fr}}
    .section{background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 18px rgba(0,0,0,.08);margin-bottom:20px}
    .section h3{margin-bottom:10px;color:#444}
    .categories{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:20px}
    .category-btn{padding:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:15px;font-weight:600;transition:.25s;box-shadow:0 5px 15px rgba(0,0,0,.15)}
    .category-btn:hover{transform:translateY(-2px)}
    .category-btn.active{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
    .places-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px;margin-top:10px}
    .place-card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,.1);transition:.25s}
    .place-card:hover{transform:translateY(-4px)}
    .place-image{width:100%;height:190px;object-fit:cover}
    .place-info{padding:16px}
    .place-name{font-size:1.15em;font-weight:700;color:#333;margin-bottom:8px}
    .place-description{color:#666;line-height:1.55;margin-bottom:12px;font-size:.95em}
    .detail{display:flex;align-items:center;gap:8px;color:#555;font-size:.9em;margin:6px 0}
    .distance-badge{display:inline-block;padding:4px 9px;background:#4CAF50;color:#fff;border-radius:12px;font-size:.8em;font-weight:700}
    .price-badge{display:inline-block;padding:4px 9px;background:#ff9800;color:#fff;border-radius:12px;font-size:.8em;font-weight:700}
    .free-badge{background:#4CAF50}
    .navigate-btn{width:100%;padding:10px;margin-top:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:.25s}
    .navigate-btn:hover{filter:brightness(1.05)}
    .hotel-info{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;padding:16px;border-radius:14px;margin-bottom:20px;box-shadow:0 10px 25px rgba(0,0,0,.18)}
    .search-bar{width:100%;padding:13px;border:2px solid #ddd;border-radius:10px;font-size:15px;margin-bottom:14px}
    .filter-options{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
    .chip{padding:7px 12px;background:#f0f0f0;border-radius:20px;cursor:pointer;border:2px solid transparent}
    .chip.active{background:#667eea;color:#fff;border-color:#764ba2}
    .sort-options{display:flex;gap:10px;margin-bottom:14px;align-items:center}
    .sort-btn{padding:7px 12px;background:#fff;border:2px solid #667eea;border-radius:20px;cursor:pointer;font-size:14px}
    .sort-btn.active{background:#667eea;color:#fff}
    .location-btn{position:absolute;top:10px;right:10px;z-index:1000;background:#fff;border:2px solid #667eea;border-radius:50%;width:40px;height:40px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .location-status{padding:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:10px;margin:12px 0;display:none;align-items:center;gap:10px}
    .location-status.active{display:flex}
    .modal{display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.7)}
    .modal-content{background:#fff;margin:5% auto;padding:24px;border-radius:18px;width:90%;max-width:600px;position:relative}
    .close{position:absolute;right:16px;top:10px;font-size:28px;cursor:pointer;color:#999}
    .tip{font-size:.9em;color:#666}
    .airtag-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.airtag-grid{grid-template-columns:1fr}}
    .btn{padding:10px 12px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
    .btn-primary{background:#0b73ff;color:#fff}
    .btn-outline{background:#fff;border:2px solid #0b73ff;color:#0b73ff}
    .nav-option{padding:10px;margin:8px 0;background:#f8f9fa;border-radius:8px;cursor:pointer;transition:.2s}
    .nav-option:hover{background:#e9ecef}
    
    /* Guida Interattiva Styles */
    .interactive-guide{display:none}
    .interactive-guide.active{display:block}
    .guide-header{display:flex;gap:20px;margin-bottom:30px;align-items:flex-start}
    .guide-main-image{width:300px;height:200px;object-fit:cover;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .guide-info{flex:1}
    .guide-title{font-size:2em;font-weight:700;color:#333;margin-bottom:10px}
    .guide-subtitle{color:#666;font-size:1.1em;margin-bottom:15px}
    .guide-quick-facts{background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px}
    .guide-quick-facts h4{margin-bottom:10px;color:#444}
    .guide-quick-facts .fact{display:flex;justify-content:space-between;margin:5px 0;padding:5px 0;border-bottom:1px solid #eee}
    .guide-quick-facts .fact:last-child{border-bottom:none}
    .guide-navigation{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .guide-nav-btn{padding:8px 16px;background:#fff;border:2px solid #667eea;border-radius:20px;cursor:pointer;transition:.3s}
    .guide-nav-btn.active{background:#667eea;color:#fff}
    .guide-content{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .guide-section{display:none}
    .guide-section.active{display:block}
    .guide-section h3{color:#333;margin-bottom:15px;font-size:1.4em}
    .guide-section p{line-height:1.7;margin-bottom:15px;color:#444}
    .guide-gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}
    .guide-gallery img{width:100%;height:150px;object-fit:cover;border-radius:8px;cursor:pointer;transition:.3s}
    .guide-gallery img:hover{transform:scale(1.05)}
    .guide-audio-controls{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px;border-radius:10px;margin:15px 0;text-align:center}
    .guide-audio-btn{background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.5);color:#fff;padding:10px 20px;border-radius:25px;cursor:pointer;margin:0 5px;transition:.3s}
    .guide-audio-btn:hover{background:rgba(255,255,255,.3)}
    .guide-audio-btn.playing{background:rgba(255,255,255,.4);animation:pulse 2s infinite}
    .timeline{margin:20px 0;padding:20px;background:#f8f9fa;border-radius:10px}
    .timeline-item{display:flex;gap:15px;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #e0e0e0}
    .timeline-item:last-child{border-bottom:none}
    .timeline-date{font-weight:700;color:#667eea;min-width:80px}
    .timeline-content{flex:1}
    .architecture-details{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0}
    .architecture-item{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    @media(max-width:768px){
      .guide-header{flex-direction:column}
      .guide-main-image{width:100%}
      .architecture-details{grid-template-columns:1fr}
    }
    /* Modal per galleria immagini */
    .image-modal{display:none;position:fixed;z-index:2000;inset:0;background:rgba(0,0,0,.9)}
    .image-modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:90%;max-height:90%;border-radius:10px;overflow:hidden}
    .image-modal img{width:100%;height:100%;object-fit:contain}
    .image-modal-close{position:absolute;top:20px;right:30px;color:#fff;font-size:40px;cursor:pointer;z-index:2001}
    .image-modal-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.3);color:#fff;border:none;font-size:30px;padding:10px 15px;cursor:pointer;border-radius:5px}
    .image-modal-prev{left:20px}
    .image-modal-next{right:20px}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(102,126,234,.7)}70%{box-shadow:0 0 0 10px rgba(102,126,234,0)}100%{box-shadow:0 0 0 0 rgba(102,126,234,0)}}
  </style>
</head>
<body>
  <div class="container">
    <h1>üèõÔ∏è Vienna Tourist Guide üá¶üáπ</h1>

    <div class="hotel-info">
      <h2>üìç Il Tuo Hotel</h2>
      <p><strong>Boutique Hotel Das Tigra</strong></p>
      <p>Tiefer Graben 14-20, 1010 Wien</p>
      <p>‚≠ê‚≠ê‚≠ê‚≠ê Hotel boutique nel centro storico di Vienna</p>
    </div>

    <div class="map-container">
      <div id="map"></div>
      <button class="location-btn" id="locationBtn" title="La mia posizione">üìç</button>
    </div>

    <div class="row">
      <!-- Colonna sinistra -->
      <div class="section">
        <div class="location-status" id="locationStatus">
          <span>üì° Geolocalizzazione attiva ‚Äî posizione aggiornata in tempo reale</span>
        </div>

        <input type="text" class="search-bar" placeholder="üîç Cerca monumenti, ristoranti, attrazioni..." id="searchBar">

        <div class="sort-options">
          <span style="font-weight:bold;">Ordina per:</span>
          <button class="sort-btn active" data-sort="default">Default</button>
          <button class="sort-btn" data-sort="distance">Distanza da me</button>
          <button class="sort-btn" data-sort="name">Nome A-Z</button>
        </div>

        <div class="filter-options">
          <div class="chip" data-filter="free">Gratuito</div>
          <div class="chip" data-filter="paid">A pagamento</div>
          <div class="chip" data-filter="walking">&lt; 500m a piedi</div>
          <div class="chip" data-filter="transport">&gt; 500m trasporti</div>
        </div>

        <div class="categories" id="categoriesBar">
          <button class="category-btn active" data-category="monuments">üèõÔ∏è Monumenti</button>
          <button class="category-btn" data-category="museums">üé® Musei</button>
          <button class="category-btn" data-category="restaurants">üçΩÔ∏è Ristoranti</button>
          <button class="category-btn" data-category="fastfood">üçî Fast Food</button>
          <button class="category-btn" data-category="parks">üå≥ Parchi</button>
          <button class="category-btn" data-category="shopping">üõçÔ∏è Shopping</button>
          <button class="category-btn" data-category="attractions" id="btnAttractions">‚ú® Attrazioni (OSM)</button>
          <button class="category-btn" id="btnLoadAttractions">‚§µÔ∏è Carica altre attrazioni</button>
          <button class="category-btn" id="btnInteractiveGuide">üéß Guida Interattiva</button>
        </div>

        <div class="places-grid" id="placesGrid"></div>
        
        <!-- Guida Interattiva -->
        <div class="interactive-guide" id="interactiveGuide">
          <button onclick="showMainGuide()" style="margin-bottom:20px;padding:10px 20px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;">‚Üê Torna alla lista</button>
          
          <div class="guide-header">
            <img id="guideMainImage" class="guide-main-image" src="" alt="">
            <div class="guide-info">
              <h1 class="guide-title" id="guideMainTitle"></h1>
              <p class="guide-subtitle" id="guideMainSubtitle"></p>
              
              <div class="guide-quick-facts" id="guideQuickFacts">
                <h4>üìã Informazioni Rapide</h4>
              </div>
              
              <div class="guide-audio-controls">
                <div style="margin-bottom:10px;">üéß Audio Guida</div>
                <button class="guide-audio-btn" id="playIntroBtn">‚ñ∂Ô∏è Introduzione</button>
                <button class="guide-audio-btn" id="playCurrentBtn">üîä Sezione Corrente</button>
                <button class="guide-audio-btn" id="stopAudioBtn">‚èπÔ∏è Stop</button>
              </div>
            </div>
          </div>
          
          <div class="guide-navigation" id="guideNavigation"></div>
          
          <div class="guide-content" id="guideContent"></div>
        </div>
      </div>

      <!-- Colonna destra: AirTag + Guida Live -->
      <div>
        <div class="section">
          <h3>üéØ Pannello AirTag / Oggetto</h3>
          <p class="tip">
            Gli AirTag non espongono API web: questo pannello permette di <b>aprire Dov'√®</b> su iOS
            e di <b>navigare</b> verso coordinate note dell'oggetto (se le conosci).
          </p>

          <div style="display:flex;gap:10px;margin:10px 0;">
            <button class="btn btn-primary" id="btnOpenFindMy">Apri Dov'√® (iOS)</button>
            <button class="btn btn-outline" id="btnFindMyHelp">Cos'√® questo?</button>
          </div>

          <hr style="margin:12px 0;">

          <h4>üìå Coordinate note dell'oggetto (facoltative)</h4>
          <div class="airtag-grid" style="margin-top:8px;">
            <input id="tagName" class="search-bar" placeholder="Nome oggetto (es. Zaino, Valigia)">
            <input id="tagLat"  class="search-bar" placeholder="Latitudine (es. 48.20849)">
            <input id="tagLng"  class="search-bar" placeholder="Longitudine (es. 16.37312)">
            <div style="display:flex;gap:10px;">
              <button class="btn btn-primary" id="btnSaveTag">Salva</button>
              <button class="btn" id="btnUseMyPos">Usa mia posizione</button>
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px;">
            <button class="btn" id="btnOpenAppleMaps">Apri in Apple Maps</button>
            <button class="btn" id="btnOpenGoogleMaps">Apri in Google Maps</button>
          </div>

          <p id="tagSavedInfo" class="tip" style="margin-top:8px;"></p>
        </div>

        <div class="section" id="liveGuidePanel">
          <h3>üó∫Ô∏è Guida Live</h3>
          <p class="tip">Spunta la casella per avviare la guida interattiva dei monumenti.</p>
          <div style="display:flex;gap:8px;align-items:center;margin:8px 0;">
            <label><input type="checkbox" id="guideEnable"> Attiva guida live</label>
            <label><input type="checkbox" id="guideVoice" checked> Audio (voce)</label>
          </div>

          <div id="guideNow" style="display:none;">
            <div style="display:flex;gap:12px;align-items:flex-start;">
              <img id="guideImg" src="" alt="" style="width:96px;height:72px;object-fit:cover;border-radius:8px;">
              <div>
                <div style="font-weight:700;" id="guideTitle"></div>
                <div id="guideBlurb" style="color:#555;margin-top:4px;"></div>
                <div id="guideDistance" class="tip" style="margin-top:6px;"></div>
              </div>
            </div>

            <div id="guideSections" style="margin-top:10px;"></div>

            <div style="display:flex;gap:8px;margin-top:10px;">
              <button class="btn btn-primary" id="guideRepeat">üîä Riascolta</button>
              <button class="btn" id="guideNavigate">üìç Vai qui</button>
            </div>

            <div style="margin-top:12px;">
              <div style="height:8px;background:#eee;border-radius:6px;position:relative;">
                <div id="arrowFov" style="position:absolute;top:-6px;left:50%;transform:translateX(-50%) rotate(0deg);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:14px solid #667eea;"></div>
              </div>
              <div class="tip">Freccia = direzione del POI rispetto a dove punti</div>
            </div>
          </div>

          <div id="guideNone" class="tip">Nessun POI davanti a te al momento.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal navigazione -->
  <div id="navigationModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalTitle">Navigazione</h2>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Modal galleria immagini -->
  <div id="imageModal" class="image-modal">
    <span class="image-modal-close">&times;</span>
    <button class="image-modal-nav image-modal-prev">‚ùÆ</button>
    <button class="image-modal-nav image-modal-next">‚ùØ</button>
    <div class="image-modal-content">
      <img id="modalImage" src="" alt="">
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // [Il codice JavaScript completo va qui - √® troppo lungo per includerlo tutto]
    // Includer√≤ solo la struttura principale e le correzioni chiave

    /* =======================
       Configurazione e dati base
    ======================= */
    let autoFollow = true;
    let userCircle = null;
    
    const hotelLocation = {
      lat: 48.216837,
      lng: 16.345621,
      name: "Boutique Hotel Das Tigra",
      address: "Tiefer Graben 14-20, 1010 Wien"
    };

    const places = {
      monuments: [
        { name:"Palazzo di Sch√∂nbrunn", description:"Residenza imperiale barocca con 1.441 stanze, patrimonio UNESCO. Giardini magnifici e zoo.", image:"https://images.unsplash.com/photo-1516550893923-42d28e5677af?w=400", lat:48.184517, lng:16.312148, price:"‚Ç¨16", hours:"8:30-17:30", distance:0 },
        { name:"Cattedrale di Santo Stefano", description:"Simbolo di Vienna, cattedrale gotica del XII secolo con torre alta 136 metri.", image:"https://images.unsplash.com/photo-1609856878074-cf31e21ccb6b?w=400", lat:48.208492, lng:16.373119, price:"Gratuito (Torre ‚Ç¨6)", hours:"6:00-22:00", distance:0 },
        { name:"Hofburg", description:"Complesso imperiale con musei, biblioteca nazionale e scuola di equitazione spagnola.", image:"https://images.unsplash.com/photo-1559128010-7c1ad6e1b6a5?w=400", lat:48.206507, lng:16.365262, price:"‚Ç¨15", hours:"9:00-17:30", distance:0 },
        { name:"Belvedere", description:"Complesso barocco con due palazzi e giardini. Ospita 'Il Bacio' di Klimt.", image:"https://images.unsplash.com/photo-1583225173839-59b4e437f4d4?w=400", lat:48.191567, lng:16.380995, price:"‚Ç¨16", hours:"10:00-18:00", distance:0 },
        { name:"Prater e Ruota Panoramica", description:"Parco divertimenti storico con l'iconica ruota panoramica del 1897.", image:"https://images.unsplash.com/photo-1570168007204-dfb528c6958f?w=400", lat:48.216571, lng:16.395776, price:"‚Ç¨13.50", hours:"10:00-22:00", distance:0 },
        { name:"Opera di Stato di Vienna", description:"Uno dei teatri d'opera pi√π importanti al mondo, inaugurato nel 1869.", image:"https://images.unsplash.com/photo-1544320824-8db57da2fa97?w=400", lat:48.203001, lng:16.369002, price:"Tour ‚Ç¨13", hours:"Tour: 10:00-15:00", distance:0 },
        { name:"Palazzo del Parlamento", description:"Edificio neoclassico sede del Parlamento austriaco con statue greche.", image:"https://images.unsplash.com/photo-1548802673-5abd0ff47c09?w=400", lat:48.207788, lng:16.357613, price:"Tour gratuito", hours:"Lun-Sab con prenotazione", distance:0 },
        { name:"Rathaus (Municipio)", description:"Imponente municipio neogotico con torre di 98 metri e piazza per eventi.", image:"https://images.unsplash.com/photo-1580836507615-96f7f950e3b?w=400", lat:48.210577, lng:16.357420, price:"Gratuito", hours:"Tour Lun, Mer, Ven 13:00", distance:0 }
      ],
      museums: [],
      restaurants: [],
      fastfood: [],
      parks: [],
      shopping: [],
      attractions: []
    };

    const interactiveGuides = {
      stephansdom: {
        id: 'stephansdom',
        title: 'Cattedrale di Santo Stefano (Stephansdom)',
        subtitle: 'Il cuore spirituale e simbolo di Vienna',
        mainImage: 'https://images.unsplash.com/photo-1609856878074-cf31e21ccb6b?w=800',
        quickFacts: {
          'Costruzione': '1137-1160 (parti pi√π antiche)',
          'Stile': 'Romanico e Gotico',
          'Altezza torre': '136,4 metri',
          'Lunghezza': '107 metri',
          'Larghezza': '34 metri',
          'Visitatori annui': '3 milioni',
          'Indirizzo': 'Stephansplatz 3, 1010 Wien'
        },
        audioIntro: "Benvenuto alla Cattedrale di Santo Stefano.",
        sections: {
          storia: {
            title: 'Storia',
            audio: "La cattedrale fu fondata nel 1137.",
            content: '<h3>Le Origini</h3><p>Storia dettagliata...</p>'
          }
        }
      }
    };

    const liveGuides = [
      {
        id: 'stephansdom',
        name: 'Cattedrale di Santo Stefano',
        lat: 48.208492, lng: 16.373119,
        radius: 80,
        fov: 70,
        blurb: "Simbolo di Vienna in stile gotico.",
        tts: "Davanti a te la Cattedrale di Santo Stefano.",
        image: "https://images.unsplash.com/photo-1609856878074-cf31e21ccb6b?w=800",
        sections: []
      }
    ];

    let map, markers = [], currentCategory = 'monuments';
    let userMarker = null, userLocation = null, watchId = null, currentSort = 'default';
    let currentGuideData = null, currentSection = null, speechUtterance = null;
    let deviceHeading = null, lastGuideId = null, guideCooldown = 8000, lastAnnounceTs = 0;
    let currentImageIndex = 0, currentImages = [];

    /* =======================
       Funzioni principali
    ======================= */
    function initMap(){
      map = L.map('map').setView([hotelLocation.lat, hotelLocation.lng], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'¬© OpenStreetMap contributors'
      }).addTo(map);

      const hotelIcon = L.divIcon({
        html:'<div style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;padding:8px;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 3px 10px rgba(0,0,0,.3);">üè®</div>',
        iconSize:[40,40], iconAnchor:[20,20]
      });

      L.marker([hotelLocation.lat, hotelLocation.lng], {icon:hotelIcon})
        .addTo(map)
        .bindPopup(`<strong>${hotelLocation.name}</strong><br>${hotelLocation.address}`)
        .openPopup();

      initGeolocation();
    }

    function
