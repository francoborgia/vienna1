<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vienna Tourist Guide</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    h1{text-align:center;color:#764ba2;margin-bottom:30px;font-size:2.3em;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .map-container{height:500px;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2);margin-bottom:30px;position:relative}
    #map{height:100%;width:100%}
    .row{display:grid;grid-template-columns:2fr 1fr;gap:20px}
    @media(max-width:1000px){.row{grid-template-columns:1fr}}
    .section{background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 18px rgba(0,0,0,.08)}
    .section h3{margin-bottom:10px;color:#444}
    .categories{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:20px}
    .category-btn{padding:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:15px;font-weight:600;transition:.25s;box-shadow:0 5px 15px rgba(0,0,0,.15)}
    .category-btn:hover{transform:translateY(-2px)}
    .category-btn.active{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
    .places-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px;margin-top:10px}
    .place-card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,.1);transition:.25s}
    .place-card:hover{transform:translateY(-4px)}
    .place-image{width:100%;height:190px;object-fit:cover}
    .place-info{padding:16px}
    .place-name{font-size:1.15em;font-weight:700;color:#333;margin-bottom:8px}
    .place-description{color:#666;line-height:1.55;margin-bottom:12px;font-size:.95em}
    .detail{display:flex;align-items:center;gap:8px;color:#555;font-size:.9em;margin:6px 0}
    .distance-badge{display:inline-block;padding:4px 9px;background:#4CAF50;color:#fff;border-radius:12px;font-size:.8em;font-weight:700}
    .price-badge{display:inline-block;padding:4px 9px;background:#ff9800;color:#fff;border-radius:12px;font-size:.8em;font-weight:700}
    .free-badge{background:#4CAF50}
    .navigate-btn{width:100%;padding:10px;margin-top:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:.25s}
    .navigate-btn:hover{filter:brightness(1.05)}
    .hotel-info{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;padding:16px;border-radius:14px;margin-bottom:20px;box-shadow:0 10px 25px rgba(0,0,0,.18)}
    .search-bar{width:100%;padding:13px;border:2px solid #ddd;border-radius:10px;font-size:15px;margin-bottom:14px}
    .filter-options{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
    .chip{padding:7px 12px;background:#f0f0f0;border-radius:20px;cursor:pointer;border:2px solid transparent}
    .chip.active{background:#667eea;color:#fff;border-color:#764ba2}
    .sort-options{display:flex;gap:10px;margin-bottom:14px;align-items:center}
    .sort-btn{padding:7px 12px;background:#fff;border:2px solid #667eea;border-radius:20px;cursor:pointer;font-size:14px}
    .sort-btn.active{background:#667eea;color:#fff}
    .location-btn{position:absolute;top:10px;right:10px;z-index:1000;background:#fff;border:2px solid #667eea;border-radius:50%;width:40px;height:40px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .location-status{padding:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:10px;margin:12px 0;display:none;align-items:center;gap:10px}
    .location-status.active{display:flex}
    .modal{display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.7)}
    .modal-content{background:#fff;margin:5% auto;padding:24px;border-radius:18px;width:90%;max-width:600px;position:relative}
    .close{position:absolute;right:16px;top:10px;font-size:28px;cursor:pointer;color:#999}
    .tip{font-size:.9em;color:#666}
    .airtag-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.airtag-grid{grid-template-columns:1fr}}
    .btn{padding:10px 12px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
    .btn-primary{background:#0b73ff;color:#fff}
    .btn-outline{background:#fff;border:2px solid #0b73ff;color:#0b73ff}
    .nav-option{padding:10px;margin:8px 0;background:#f8f9fa;border-radius:8px;cursor:pointer;transition:.2s}
    .nav-option:hover{background:#e9ecef}
    
    /* Guida Interattiva Styles */
    .interactive-guide{display:none}
    .interactive-guide.active{display:block}
    .guide-header{display:flex;gap:20px;margin-bottom:30px;align-items:flex-start}
    .guide-main-image{width:300px;height:200px;object-fit:cover;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .guide-info{flex:1}
    .guide-title{font-size:2em;font-weight:700;color:#333;margin-bottom:10px}
    .guide-subtitle{color:#666;font-size:1.1em;margin-bottom:15px}
    .guide-quick-facts{background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px}
    .guide-quick-facts h4{margin-bottom:10px;color:#444}
    .guide-quick-facts .fact{display:flex;justify-content:space-between;margin:5px 0;padding:5px 0;border-bottom:1px solid #eee}
    .guide-quick-facts .fact:last-child{border-bottom:none}
    .guide-navigation{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .guide-nav-btn{padding:8px 16px;background:#fff;border:2px solid #667eea;border-radius:20px;cursor:pointer;transition:.3s}
    .guide-nav-btn.active{background:#667eea;color:#fff}
    .guide-content{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .guide-section{display:none}
    .guide-section.active{display:block}
    .guide-section h3{color:#333;margin-bottom:15px;font-size:1.4em}
    .guide-section p{line-height:1.7;margin-bottom:15px;color:#444}
    .guide-gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}
    .guide-gallery img{width:100%;height:150px;object-fit:cover;border-radius:8px;cursor:pointer;transition:.3s}
    .guide-gallery img:hover{transform:scale(1.05)}
    .guide-audio-controls{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:15px;border-radius:10px;margin:15px 0;text-align:center}
    .guide-audio-btn{background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.5);color:#fff;padding:10px 20px;border-radius:25px;cursor:pointer;margin:0 5px;transition:.3s}
    .guide-audio-btn:hover{background:rgba(255,255,255,.3)}
    .guide-audio-btn.playing{background:rgba(255,255,255,.4);animation:pulse 2s infinite}
    .timeline{margin:20px 0;padding:20px;background:#f8f9fa;border-radius:10px}
    .timeline-item{display:flex;gap:15px;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #e0e0e0}
    .timeline-item:last-child{border-bottom:none}
    .timeline-date{font-weight:700;color:#667eea;min-width:80px}
    .timeline-content{flex:1}
    .architecture-details{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0}
    .architecture-item{background:#fff;padding:15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    @media(max-width:768px){
      .guide-header{flex-direction:column}
      .guide-main-image{width:100%}
      .architecture-details{grid-template-columns:1fr}
    }
    /* Modal per galleria immagini */
    .image-modal{display:none;position:fixed;z-index:2000;inset:0;background:rgba(0,0,0,.9)}
    .image-modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:90%;max-height:90%;border-radius:10px;overflow:hidden}
    .image-modal img{width:100%;height:100%;object-fit:contain}
    .image-modal-close{position:absolute;top:20px;right:30px;color:#fff;font-size:40px;cursor:pointer;z-index:2001}
    .image-modal-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.3);color:#fff;border:none;font-size:30px;padding:10px 15px;cursor:pointer;border-radius:5px}
    .image-modal-prev{left:20px}
    .image-modal-next{right:20px}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(102,126,234,.7)}70%{box-shadow:0 0 0 10px rgba(102,126,234,0)}100%{box-shadow:0 0 0 0 rgba(102,126,234,0)}}
  </style>
</head>
<body>
  <div class="container">
    <h1>üèõÔ∏è Vienna Tourist Guide üá¶üáπ</h1>

    <div class="hotel-info">
      <h2>üìç Il Tuo Hotel</h2>
      <p><strong>Boutique Hotel Das Tigra</strong></p>
      <p>Tiefer Graben 14-20, 1010 Wien</p>
      <p>‚≠ê‚≠ê‚≠ê‚≠ê Hotel boutique nel centro storico di Vienna</p>
    </div>

    <div class="map-container">
      <div id="map"></div>
      <button class="location-btn" id="locationBtn" title="La mia posizione">üìç</button>
    </div>

    <div class="row">
      <!-- Colonna sinistra -->
      <div class="section">
        <div class="location-status" id="locationStatus">
          <span>üì° Geolocalizzazione attiva ‚Äî posizione aggiornata in tempo reale</span>
        </div>

        <input type="text" class="search-bar" placeholder="üîç Cerca monumenti, ristoranti, attrazioni..." id="searchBar">

        <div class="sort-options">
          <span style="font-weight:bold;">Ordina per:</span>
          <button class="sort-btn active" data-sort="default">Default</button>
          <button class="sort-btn" data-sort="distance">Distanza da me</button>
          <button class="sort-btn" data-sort="name">Nome A-Z</button>
        </div>

        <div class="filter-options">
          <div class="chip" data-filter="free">Gratuito</div>
          <div class="chip" data-filter="paid">A pagamento</div>
          <div class="chip" data-filter="walking">&lt; 500m a piedi</div>
          <div class="chip" data-filter="transport">&gt; 500m trasporti</div>
        </div>

        <div class="categories" id="categoriesBar">
          <button class="category-btn active" data-category="monuments">üèõÔ∏è Monumenti</button>
          <button class="category-btn" data-category="museums">üé® Musei</button>
          <button class="category-btn" data-category="restaurants">üçΩÔ∏è Ristoranti</button>
          <button class="category-btn" data-category="fastfood">üçî Fast Food</button>
          <button class="category-btn" data-category="parks">üå≥ Parchi</button>
          <button class="category-btn" data-category="shopping">üõçÔ∏è Shopping</button>
          <button class="category-btn" data-category="attractions" id="btnAttractions">‚ú® Attrazioni (OSM)</button>
          <button class="category-btn" id="btnLoadAttractions">‚§µÔ∏è Carica altre attrazioni</button>
          <button class="category-btn" id="btnInteractiveGuide">üéß Guida Interattiva</button>
        </div>

        <div class="places-grid" id="placesGrid"></div>
        
        <!-- Guida Interattiva -->
        <div class="interactive-guide" id="interactiveGuide">
          <button onclick="showMainGuide()" style="margin-bottom:20px;padding:10px 20px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;">‚Üê Torna alla lista</button>
          
          <div class="guide-header">
            <img id="guideMainImage" class="guide-main-image" src="" alt="">
            <div class="guide-info">
              <h1 class="guide-title" id="guideMainTitle"></h1>
              <p class="guide-subtitle" id="guideMainSubtitle"></p>
              
              <div class="guide-quick-facts" id="guideQuickFacts">
                <h4>üìã Informazioni Rapide</h4>
              </div>
              
              <div class="guide-audio-controls">
                <div style="margin-bottom:10px;">üéß Audio Guida</div>
                <button class="guide-audio-btn" id="playIntroBtn">‚ñ∂Ô∏è Introduzione</button>
                <button class="guide-audio-btn" id="playCurrentBtn">üîä Sezione Corrente</button>
                <button class="guide-audio-btn" id="stopAudioBtn">‚èπÔ∏è Stop</button>
              </div>
            </div>
          </div>
          
          <div class="guide-navigation" id="guideNavigation"></div>
          
          <div class="guide-content" id="guideContent"></div>
        </div>
      </div>

      <!-- Colonna destra: AirTag + Guida Live -->
      <div class="section">
        <h3>üéØ Pannello AirTag / Oggetto</h3>
        <p class="tip">
          Gli AirTag non espongono API web: questo pannello permette di <b>aprire Dov'√®</b> su iOS
          e di <b>navigare</b> verso coordinate note dell'oggetto (se le conosci).
        </p>

        <div style="display:flex;gap:10px;margin:10px 0;">
          <button class="btn btn-primary" id="btnOpenFindMy">Apri Dov'√® (iOS)</button>
          <button class="btn btn-outline" id="btnFindMyHelp">Cos'√® questo?</button>
        </div>

        <hr style="margin:12px 0;">

        <h4>üìå Coordinate note dell'oggetto (facoltative)</h4>
        <div class="airtag-grid" style="margin-top:8px;">
          <input id="tagName" class="search-bar" placeholder="Nome oggetto (es. Zaino, Valigia)">
          <input id="tagLat"  class="search-bar" placeholder="Latitudine (es. 48.20849)">
          <input id="tagLng"  class="search-bar" placeholder="Longitudine (es. 16.37312)">
          <div style="display:flex;gap:10px;">
            <button class="btn btn-primary" id="btnSaveTag">Salva</button>
            <button class="btn" id="btnUseMyPos">Usa mia posizione</button>
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px;">
          <button class="btn" id="btnOpenAppleMaps">Apri in Apple Maps</button>
          <button class="btn" id="btnOpenGoogleMaps">Apri in Google Maps</button>
        </div>

        <p id="tagSavedInfo" class="tip" style="margin-top:8px;"></p>
      </div>

      <div class="section" id="liveGuidePanel">
        <h3>üó∫Ô∏è Guida Live</h3>
        <p class="tip">Spunta la casella per avviare la guida interattiva dei monumenti.</p>
        <div style="display:flex;gap:8px;align-items:center;margin:8px 0;">
          <label><input type="checkbox" id="guideEnable"> Attiva guida live</label>
          <label><input type="checkbox" id="guideVoice" checked> Audio (voce)</label>
        </div>

        <div id="guideNow" style="display:none;">
          <div style="display:flex;gap:12px;align-items:flex-start;">
            <img id="guideImg" src="" alt="" style="width:96px;height:72px;object-fit:cover;border-radius:8px;">
            <div>
              <div style="font-weight:700;" id="guideTitle"></div>
              <div id="guideBlurb" style="color:#555;margin-top:4px;"></div>
              <div id="guideDistance" class="tip" style="margin-top:6px;"></div>
            </div>
          </div>

          <div id="guideSections" style="margin-top:10px;"></div>

          <div style="display:flex;gap:8px;margin-top:10px;">
            <button class="btn btn-primary" id="guideRepeat">üîä Riascolta</button>
            <button class="btn" id="guideNavigate">üìç Vai qui</button>
          </div>

          <div style="margin-top:12px;">
            <div style="height:8px;background:#eee;border-radius:6px;position:relative;">
              <div id="arrowFov" style="position:absolute;top:-6px;left:50%;transform:translateX(-50%) rotate(0deg);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:14px solid #667eea;"></div>
            </div>
            <div class="tip">Freccia = direzione del POI rispetto a dove punti</div>
          </div>
        </div>

        <div id="guide    /* =======================
       Guida Interattiva - Database dettagliato
    ======================= */
    const interactiveGuides = {
      stephansdom: {
        id: 'stephansdom',
        title: 'Cattedrale di Santo Stefano (Stephansdom)',
        subtitle: 'Il cuore spirituale e simbolo di Vienna',
        mainImage: 'https://images.unsplash.com/photo-1609856878074-cf31e21ccb6b?w=800',
        quickFacts: {
          'Costruzione': '1137-1160 (parti pi√π antiche)',
          'Stile': 'Romanico e Gotico',
          'Altezza torre': '136,4 metri',
          'Lunghezza': '107 metri',
          'Larghezza': '34 metri',
          'Visitatori annui': '3 milioni',
          'Indirizzo': 'Stephansplatz 3, 1010 Wien'
        },
        audioIntro: "Benvenuto alla Cattedrale di Santo Stefano, il simbolo pi√π famoso di Vienna. Per oltre 850 anni, questa magnifica cattedrale ha dominato il centro storico della citt√†, testimone di eventi storici cruciali e cuore spirituale dell'Austria.",
        sections: {
          storia: {
            title: 'Storia',
            audio: "La cattedrale fu fondata nel 1137 come chiesa romanica. Nel corso dei secoli fu ampliata e ricostruita in stile gotico, diventando sede arcivescovile nel 1469.",
            content: `
              <h3>Le Origini (1137-1160)</h3>
              <p>La Cattedrale di Santo Stefano fu fondata nel 1137 durante il regno del Margravio Leopoldo IV di Babenberg. La struttura originale era una basilica romanica, di cui oggi rimangono ancora le Porte dei Giganti (Riesentor) e le Torri dei Pagani (Heident√ºrme).</p>
              
              <div class="timeline">
                <div class="timeline-item">
                  <div class="timeline-date">1137</div>
                  <div class="timeline-content">Fondazione della prima chiesa romanica da parte del Margravio Leopoldo IV</div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-date">1230</div>
                  <div class="timeline-content">Primo ampliamento della cattedrale</div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-date">1304-1340</div>
                  <div class="timeline-content">Costruzione del coro gotico sotto Alberto I d'Asburgo</div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-date">1359-1433</div>
                  <div class="timeline-content">Costruzione della navata gotica e inizio della torre sud</div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-date">1469</div>
                  <div class="timeline-content">Elevazione a cattedrale arcivescovile</div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-date">1945</div>
                  <div class="timeline-content">Gravi danni durante la Seconda Guerra Mondiale</div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-date">1945-1952</div>
                  <div class="timeline-content">Ricostruzione completa</div>
                </div>
              </div>
              
              <div class="guide-gallery">
                <img src="https://images.unsplash.com/photo-1566139447295-8c4df4b28707?w=400" alt="Porta dei Giganti romanica">
                <img src="https://images.unsplash.com/photo-1517339382936-8e762c0faa97?w=400" alt="Interno gotico">
                <img src="https://images.unsplash.com/photo-1544320824-8db57da2fa97?w=400" alt="Ricostruzione post-guerra">
              </div>
            `
          },
          architettura: {
            title: 'Architettura',
            audio: "L'architettura della cattedrale rappresenta un perfetto esempio della transizione dal romanico al gotico. La torre sud, alta 136 metri, √® considerata un capolavoro del gotico austriaco.",
            content: `
              <h3>Un Capolavoro Architettonico</h3>
              <p>La Cattedrale di Santo Stefano rappresenta una straordinaria sintesi di stili architettonici, dal romanico al gotico, testimoniando l'evoluzione artistica di Vienna attraverso i secoli.</p>
              
              <div class="architecture-details">
                <div class="architecture-item">
                  <h4>üèóÔ∏è Struttura Romanica (XII sec.)</h4>
                  <p><strong>Porta dei Giganti:</strong> L'ingresso principale occidentale, con i suoi archi a tutto sesto e le sculture raffiguranti Cristo in maest√†.</p>
                  <p><strong>Torri dei Pagani:</strong> Le due torri occidentali, chiamate cos√¨ perch√© costruite con pietre di edifici romani.</p>
                </div>
                
                <div class="architecture-item">
                  <h4>‚õ™ Elementi Gotici (XIV-XV sec.)</h4>
                  <p><strong>Navata:</strong> Tre navate con volte a crociera costolonate, tipiche del gotico austriaco.</p>
                  <p><strong>Coro:</strong> Costruito tra il 1304 e il 1340, √® uno dei primi esempi di gotico viennese.</p>
                </div>
                
                <div class="architecture-item">
                  <h4>üóº Torre Sud "Steffl"</h4>
                  <p><strong>Altezza:</strong> 136,4 metri, rendendola la torre campanaria pi√π alta dell'Austria.</p>
                  <p><strong>Struttura:</strong> 343 gradini conducono alla camera di guardia a 72 metri di altezza.</p>
                </div>
                
                <div class="architecture-item">
                  <h4>üîî Torre Nord Incompiuta</h4>
                  <p><strong>Storia:</strong> Iniziata nel 1450, rimase incompiuta a causa di problemi strutturali.</p>
                  <p><strong>Funzione attuale:</strong> Ospita la "Pummerin", la seconda campana pi√π grande d'Europa.</p>
                </div>
              </div>
              
              <div class="guide-gallery">
                <img src="https://images.unsplash.com/photo-1583225173839-59b4e437f4d4?w=400" alt="Torre Sud Steffl">
                <img src="https://images.unsplash.com/photo-1580836507615-96f7f950e3b?w=400" alt="Volte gotiche">
                <img src="https://images.unsplash.com/photo-1541367777708-c1ccbfb0e6d5?w=400" alt="Dettagli architettonici">
              </div>
            `
          },
          interno: {
            title: 'Interno e Tesori',
            audio: "All'interno della cattedrale si trovano capolavori artistici di inestimabile valore, tra cui l'altare di Wiener Neustadt, il pulpito gotico e la tomba dell'imperatore Federico III.",
            content: `
              <h3>Capolavori Artistici e Spirituali</h3>
              <p>L'interno della cattedrale custodisce tesori artistici che spaziano dal medioevo al barocco, testimoniando secoli di devozione e mecenatismo.</p>
              
              <h4>üé® Principali Opere d'Arte</h4>
              <p><strong>Altare di Wiener Neustadt (1447):</strong> Capolavoro del gotico tardivo, raffigura la Passione di Cristo in 72 scene scolpite.</p>
              
              <p><strong>Pulpito di Anton Pilgram (1515):</strong> Straordinario esempio di scultura gotica tardiva, decorato con i quattro Padri della Chiesa e un celebre autoritratto dello scultore.</p>
              
              <p><strong>Tomba dell'Imperatore Federico III:</strong> Realizzata in marmo rosso di Salisburgo, √® considerata uno dei monumenti funebri pi√π belli del gotico austriaco.</p>
              
              <h4>üñºÔ∏è Vetrate e Decorazioni</h4>
              <p>Le vetrate gotiche originali, alcune risalenti al XIV secolo, creano un'atmosfera mistica all'interno della cattedrale. Particolarmente notevoli sono le vetrate del coro, che raffigurano scene della vita di Cristo.</p>
              
              <h4>‚õ™ Cappelle Laterali</h4>
              <p><strong>Cappella di Santa Caterina:</strong> Ospita il miracoloso Crocifisso di Wiener Neustadt.</p>
              <p><strong>Cappella di San Eligio:</strong> Dedicata al patrono degli orefici, conserva preziosi ex-voto.</p>
              
              <div class="guide-gallery">
                <img src="https://images.unsplash.com/photo-1613414969929-491c9c779910?w=400" alt="Altare maggiore">
                <img src="https://images.unsplash.com/photo-1566127444979-b3d2b654e3d7?w=400" alt="Pulpito gotico">
                <img src="https://images.unsplash.com/photo-1583037189850-1921ae7c6c22?w=400" alt="Vetrate colorate">
              </div>
            `
          },
          catacombe: {
            title: 'Catacombe',
            audio: "Sotto la cattedrale si estendono le antiche catacombe, che custodiscono i resti di migliaia di viennesi, compresi membri della famiglia imperiale asburgica.",
            content: `
              <h3>Il Regno dei Morti sotto Vienna</h3>
              <p>Le catacombe di Santo Stefano rappresentano uno dei siti storici pi√π affascinanti e misteriosi di Vienna, estendendosi per circa 30 metri sotto la cattedrale.</p>
              
              <h4>üíÄ Storia delle Catacombe</h4>
              <p>Le catacombe furono scavate nel XVIII secolo quando l'imperatore Giuseppe II viet√≤ le sepolture all'interno del centro citt√† per motivi igienici. I resti di circa 11.000 persone furono trasferiti qui dai cimiteri parrocchiali.</p>
              
              <h4>üëë La Cripta Ducale</h4>
              <p>Nella parte pi√π antica delle catacombe si trova la Cripta Ducale, che custodisce:</p>
              <ul style="margin-left: 20px; line-height: 1.8;">
                <li><strong>Organi interni degli Asburgo:</strong> Urne contenenti cuori e altri organi dei membri della famiglia imperiale</li>
                <li><strong>Sarcofago di Rodolfo IV:</strong> Il fondatore dell'Universit√† di Vienna, morto nel 1365</li>
                <li><strong>Vescovi e arcivescovi:</strong> Sepolture di importanti figure ecclesiastiche</li>
              </ul>
              
              <h4>üèõÔ∏è Architettura Sotterranea</h4>
              <p>Le catacombe sono organizzate in diverse camere:</p>
              <p><strong>Camera principale:</strong> Ospita file ordinate di teschi e ossa disposte artisticamente</p>
              <p><strong>Corridoi laterali:</strong> Collegano le diverse sezioni e ospitano sepolture pi√π antiche</p>
              <p><strong>Cripta moderna:</strong> Utilizzata fino agli anni '60 per sepolture di personalit√† illustri</p>
              
              <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <strong>üìù Informazioni per la Visita:</strong><br>
                ‚Ä¢ Visite guidate ogni 30 minuti<br>
                ‚Ä¢ Temperatura costante di 8¬∞C<br>
                ‚Ä¢ Vietato fotografare<br>
                ‚Ä¢ Durata: circa 30 minuti<br>
                ‚Ä¢ Non adatto a claustrofobici
              </div>
            `
          },
          curiosita: {
            title: 'Curiosit√† e Leggende',
            audio: "La cattedrale √® circondata da numerose leggende e curiosit√†: dal mistero del maestro costruttore che si gett√≤ dalla torre, al patto con il diavolo per completare l'opera.",
            content: `
              <h3>Misteri e Leggende di Santo Stefano</h3>
              <p>Secoli di storia hanno avvolto la cattedrale in un alone di mistero, generando leggende che ancora oggi affascinano visitatori e viennesi.</p>
              
              <h4>üëπ La Leggenda del Diavolo</h4>
              <p>Si narra che il maestro costruttore Hans Puchsbaum, disperato per completare la cattedrale, fece un patto con il diavolo. In cambio dell'aiuto nella costruzione, promise che la prima parola pronunciata nella cattedrale completata non sarebbe stata di preghiera. Quando il diavolo si present√≤ per riscuotere il debito, sent√¨ pronunciare il nome "Maria" e, furioso, tent√≤ di distruggere l'edificio scagliandosi contro un pilastro, dove ancora oggi si pu√≤ vedere un'impronta che i viennesi chiamano "l'impronta del diavolo".</p>
              
              <h4>üîç I Numeri Nascosti</h4>
              <p><strong>Il numero 137:</strong> Ricorre misteriosamente in tutta la cattedrale - l'anno di fondazione, il numero di gradini per raggiungere certe sezioni, e altre misure architettoniche.</p>
              
              <p><strong>Simboli massonici:</strong> Alcuni studiosi sostengono di aver individuato simboli massonici nascosti nella decorazione, testimonianza dell'influenza di questa societ√† segreta nella Vienna del XVIII secolo.</p>
              
              <h4>üéµ La Campana Pummerin</h4>
              <p>La famosa campana "Pummerin" nella torre nord ha una storia drammatica: la campana originale del 1711 fu fusa utilizzando 200 cannoni turchi catturati durante l'assedio di Vienna del 1683. Distrutta nell'incendio del 1945, fu ricostruita nel 1952 utilizzando i frammenti recuperati.</p>
              
              <h4>ü¶Ö L'Aquila Bicefala</h4>
              <p>Sul tetto della cattedrale, 230.000 tegole smaltate formano l'aquila bicefala asburgica e lo stemma dell'Austria. Questo mosaico di tegole, ricostruito dopo la guerra, √® visibile solo dall'alto e rappresenta un capolavoro di artigianato.</p>
              
              <h4>üåü Curiosit√† Moderne</h4>
              <ul style="margin-left: 20px; line-height: 1.8;">
                <li><strong>Punto Zero:</strong> Una placca di bronzo segna il "punto zero" da cui si misurano tutte le distanze in Austria</li>
                <li><strong>Rifugio antiaereo:</strong> Durante la Seconda Guerra Mondiale, le catacombe furono utilizzate come rifugio antiaereo</li>
                <li><strong>Concerto di Mozart:</strong> Mozart si spos√≤ qui nel 1782 e compose la sua "Messa dell'Incoronazione" per la cattedrale</li>
                <li><strong>Webcam storica:</strong> Una delle prime webcam al mondo fu installata qui nel 1996</li>
              </ul>
              
              <div class="guide-gallery">
                <img src="https://images.unsplash.com/photo-1548802673-5abd0ff47c09?w=400" alt="Tetto con aquila asburgica">
                <img src="https://images.unsplash.com/photo-1583225173839-59b4e437f4d4?w=400" alt="Campana Pummerin">
                <img src="https://images.unsplash.com/photo-1609856878074-cf31e21ccb6b?w=400" alt="Vista notturna">
              </div>
            `
          }
        }
      },
      
      schonbrunn: {
        id: 'schonbrunn',
        title: 'Palazzo di Sch√∂nbrunn',
        subtitle: 'La Versailles austriaca e residenza estiva degli Asburgo',
        mainImage: 'https://images.unsplash.com/photo-1516550893923-42d28e5677af?w=800',
        quickFacts: {
          'Costruzione': '1696-1713',
          'Architetto': 'Johann Bernhard Fischer von Erlach',
          'Stanze': '1.441',
          'Patrimonio UNESCO': 'Dal 1996',
          'Giardini': '120 ettari',
          'Visitatori annui': '3,8 milioni',
          'Indirizzo': 'Sch√∂nbrunner Schlo√üstra√üe 47, 1130 Wien'
        },
        audioIntro: "Benvenuto al Palazzo di Sch√∂nbrunn, la magnifica residenza estiva degli imperatori asburgici. Questo gioiello del barocco austriaco, con i suoi 1.441 appartamenti e gli splendidi giardini, racconta tre secoli di storia imperiale.",
        sections: {
          storia: {
            title: 'Storia Imperiale',
            audio: "Sch√∂nbrunn fu costruito su volere dell'imperatore Leopoldo I come residenza estiva. Il palazzo raggiunse il suo massimo splendore durante il regno di Maria Teresa nel XVIII secolo.",
            content: `
              <h3>Dalle Origini al Palazzo Imperiale</h3>
              <p>La storia di Sch√∂nbrunn inizia nel XIV secolo come tenuta di caccia, ma il palazzo che vediamo oggi nacque dalla visione degli Asburgo di creare una residenza che rivaleggiasse con Versailles.</p>
              
              <div class="timeline">
                <div class="timeline-item">
                  <div class="timeline-date">1569</div>
                  <div class="timeline-content">Massimiliano II acquista la tenuta e costruisce un castello di caccia</div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-date">1683</div>
                  <div class="timeline-content">Il castello originale viene distrutto durante l'assedio turco</div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-date">1696</div>
                  <div class="timeline-content">Leopoldo I commissiona il nuovo palazzo a Fischer von Erlach</div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-date">1743-1763</div>
                  <div class="timeline-content">Maria Teresa trasforma Sch√∂nbrunn nella residenza principale</div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-date">1805-1809</div>
                  <div class="timeline-content">Napoleone usa il palazzo come quartier generale</div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-date">1918</div>
                  <div class="timeline-content">Fine dell'impero: il palazzo diventa propriet√† della Repubblica</div>
                </div>
              </div>
            `
          },
          stanze: {
            title: 'Stanze Imperiali',
            audio: "Le 45 stanze aperte al pubblico mostrano la vita di corte asburgica. Dalla Sala degli Specchi dove Mozart suon√≤ bambino, agli appartamenti privati di Francesco Giuseppe e Sissi.",
            content: `
              <h3>Un Viaggio tra Fasto e Intimit√† Imperiale</h3>
              <p>Le stanze di Sch√∂nbrunn offrono uno spaccato unico della vita degli Asburgo, dai grandi ricevimenti di stato ai momenti pi√π intimi della famiglia imperiale.</p>
              
              <h4>üëë Appartamenti di Rappresentanza</h4>
              <p><strong>Sala degli Specchi:</strong> Qui il piccolo Mozart, a soli 6 anni, suon√≤ per l'imperatrice Maria Teresa nel 1762, iniziando la sua carriera di enfant prodige.</p>
              
              <p><strong>Grande Galleria:</strong> Lunga 43 metri, fu teatro di balli imperiali e ricevimenti diplomatici. Le sue pareti dorate e gli specchi riflettevano la potenza asburgica.</p>
              
              <p><strong>Salon Cinese Azzurro:</strong> Maria Teresa teneva qui le sue riunioni di stato segrete, seduta a un tavolino rotondo per eliminare le precedenze diplomatiche.</p>
              
              <h4>üè° Appartamenti Privati</h4>
              <p><strong>Camera da letto di Francesco Giuseppe:</strong> L'ultimo imperatore dormiva su un letto militare spartano, riflettendo la sua natura austera.</p>
              
              <p><strong>Appartamenti di Sissi:</strong> Gli appartamenti dell'imperatrice Elisabetta mostrano il suo amore per la ginnastica e la bellezza, con una palestra privata.</p>
              
              <div class="guide-gallery">
                <img src="https://images.unsplash.com/photo-1566139447295-8c4df4b28707?w=400" alt="Sala degli Specchi">
                <img src="https://images.unsplash.com/photo-1" class="tip">Nessun POI davanti a te al momento.</div>
      </div>
    </div>
  </div>

  <!-- Modal navigazione -->
  <div id="navigationModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalTitle">Navigazione</h2>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Modal galleria immagini -->
  <div id="imageModal" class="image-modal">
    <span class="image-modal-close">&times;</span>
    <button class="image-modal-nav image-modal-prev">‚ùÆ</button>
    <button class="image-modal-nav image-modal-next">‚ùØ</button>
    <div class="image-modal-content">
      <img id="modalImage" src="" alt="">
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* =======================
       Config geolocalizzazione / follow
    ======================= */
    let autoFollow = true;   // la mappa segue sempre la tua posizione
    let userCircle = null;   // cerchio di accuratezza GPS

    /* =======================
       Dati hotel
    ======================= */
    const hotelLocation = {
      lat: 48.216837,
      lng: 16.345621,
      name: "Boutique Hotel Das Tigra",
      address: "Tiefer Graben 14-20, 1010 Wien"
    };

    /* =======================
       POI base + categoria dinamica
    ======================= */
    const places = {
      monuments: [
        { name:"Palazzo di Sch√∂nbrunn", description:"Residenza imperiale barocca con 1.441 stanze, patrimonio UNESCO. Giardini magnifici e zoo.", image:"https://images.unsplash.com/photo-1516550893923-42d28e5677af?w=400", lat:48.184517, lng:16.312148, price:"‚Ç¨16", hours:"8:30-17:30", distance:0 },
        { name:"Cattedrale di Santo Stefano", description:"Simbolo di Vienna, cattedrale gotica del XII secolo con torre alta 136 metri.", image:"https://images.unsplash.com/photo-1609856878074-cf31e21ccb6b?w=400", lat:48.208492, lng:16.373119, price:"Gratuito (Torre ‚Ç¨6)", hours:"6:00-22:00", distance:0 },
        { name:"Hofburg", description:"Complesso imperiale con musei, biblioteca nazionale e scuola di equitazione spagnola.", image:"https://images.unsplash.com/photo-1559128010-7c1ad6e1b6a5?w=400", lat:48.206507, lng:16.365262, price:"‚Ç¨15", hours:"9:00-17:30", distance:0 },
        { name:"Belvedere", description:"Complesso barocco con due palazzi e giardini. Ospita 'Il Bacio' di Klimt.", image:"https://images.unsplash.com/photo-1583225173839-59b4e437f4d4?w=400", lat:48.191567, lng:16.380995, price:"‚Ç¨16", hours:"10:00-18:00", distance:0 },
        { name:"Prater e Ruota Panoramica", description:"Parco divertimenti storico con l'iconica ruota panoramica del 1897.", image:"https://images.unsplash.com/photo-1570168007204-dfb528c6958f?w=400", lat:48.216571, lng:16.395776, price:"‚Ç¨13.50", hours:"10:00-22:00", distance:0 },
        { name:"Opera di Stato di Vienna", description:"Uno dei teatri d'opera pi√π importanti al mondo, inaugurato nel 1869.", image:"https://images.unsplash.com/photo-1544320824-8db57da2fa97?w=400", lat:48.203001, lng:16.369002, price:"Tour ‚Ç¨13", hours:"Tour: 10:00-15:00", distance:0 },
        { name:"Palazzo del Parlamento", description:"Edificio neoclassico sede del Parlamento austriaco con statue greche.", image:"https://images.unsplash.com/photo-1548802673-5abd0ff47c09?w=400", lat:48.207788, lng:16.357613, price:"Tour gratuito", hours:"Lun-Sab con prenotazione", distance:0 },
        { name:"Rathaus (Municipio)", description:"Imponente municipio neogotico con torre di 98 metri e piazza per eventi.", image:"https://images.unsplash.com/photo-1580836507615-96f7f950e3b?w=400", lat:48.210577, lng:16.357420, price:"Gratuito", hours:"Tour Lun, Mer, Ven 13:00", distance:0 }
      ],
      museums: [
        { name:"Kunsthistorisches Museum", description:"Uno dei musei d'arte pi√π importanti al mondo con opere di Raffaello, Vermeer, Vel√°zquez.", image:"https://images.unsplash.com/photo-1566127444979-b3d2b654e3d7?w=400", lat:48.203551, lng:16.361587, price:"‚Ç¨21", hours:"10:00-18:00 (Gio fino 21:00)", distance:0 },
        { name:"Albertina", description:"Collezione grafica pi√π grande al mondo con opere di Monet, Picasso, Klimt.", image:"https://images.unsplash.com/photo-1583037189850-1921ae7c6c22?w=400", lat:48.204731, lng:16.368438, price:"‚Ç¨18.90", hours:"10:00-18:00 (Mer, Ven fino 21:00)", distance:0 },
        { name:"Museo di Storia Naturale", description:"30 milioni di oggetti esposti inclusi dinosauri e la Venere di Willendorf.", image:"https://images.unsplash.com/photo-1613414969929-491c9c779910?w=400", lat:48.205268, lng:16.359989, price:"‚Ç¨16", hours:"9:00-18:00 (Mer fino 20:00)", distance:0 },
        { name:"MAK - Museo Arti Applicate", description:"Design, architettura e arte contemporanea. Collezione unica di Wiener Werkst√§tte.", image:"https://images.unsplash.com/photo-1541367777708-c1ccbfb0e6d5?w=400", lat:48.207395, lng:16.381705, price:"‚Ç¨15", hours:"10:00-18:00 (Mar fino 21:00)", distance:0 }
      ],
      restaurants: [
        { name:"Figlm√ºller", description:"Famoso per la schnitzel pi√π grande di Vienna, tradizione dal 1905.", image:"https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400", lat:48.208765, lng:16.374526, price:"‚Ç¨‚Ç¨‚Ç¨", hours:"11:00-22:30", distance:0 },
        { name:"Caf√© Central", description:"Storico caff√® viennese frequentato da Freud e Trotsky. Torte imperiali.", image:"https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=400", lat:48.210372, lng:16.365063, price:"‚Ç¨‚Ç¨", hours:"7:30-22:00", distance:0 },
        { name:"Plachutta Wollzeile", description:"Specialit√†: Tafelspitz (bollito di manzo), cucina tradizionale austriaca.", image:"https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400", lat:48.208492, lng:16.376798, price:"‚Ç¨‚Ç¨‚Ç¨", hours:"11:30-23:00", distance:0 },
        { name:"Zum Schwarzen Kameel", description:"Dal 1618, ristorante Art Nouveau con specialit√† austriache e wine bar.", image:"https://images.unsplash.com/photo-1550966871-3ed3cdb5ed0c?w=400", lat:48.210833, lng:16.367778, price:"‚Ç¨‚Ç¨‚Ç¨‚Ç¨", hours:"8:00-24:00", distance:0 },
        { name:"Caf√© Sacher", description:"Casa della torta Sachertorte originale, elegante caff√® dal 1876.", image:"https://images.unsplash.com/photo-1550916478-59a58fe5e873?w=400", lat:48.203889, lng:16.369444, price:"‚Ç¨‚Ç¨‚Ç¨", hours:"8:00-24:00", distance:0 }
      ],
      fastfood: [
        { name:"McDonald's Stephansplatz", description:"McDonald's nel cuore di Vienna, vicino alla cattedrale.", image:"https://images.unsplash.com/photo-1552895638-f7fe08d2f7d5?w=400", lat:48.208556, lng:16.373139, price:"‚Ç¨", hours:"6:00-1:00 (Ven-Sab fino 3:00)", distance:0 },
        { name:"McDonald's Hauptbahnhof", description:"Grande McDonald's nella stazione centrale.", image:"https://images.unsplash.com/photo-1552895638-f7fe08d2f7d5?w=400", lat:48.185252, lng:16.377482, price:"‚Ç¨", hours:"24 ore", distance:0 },
        { name:"McDonald's Praterstern", description:"Vicino al Prater e alla ruota panoramica.", image:"https://images.unsplash.com/photo-1552895638-f7fe08d2f7d5?w=400", lat:48.218765, lng:16.391944, price:"‚Ç¨", hours:"24 ore", distance:0 },
        { name:"Burger King Mariahilferstra√üe", description:"Via principale dello shopping.", image:"https://images.unsplash.com/photo-1571091718767-18b5b1457add?w=400", lat:48.196389, lng:16.340556, price:"‚Ç¨", hours:"8:00-24:00", distance:0 },
        { name:"Burger King Wien Mitte", description:"Nel mall Wien Mitte.", image:"https://images.unsplash.com/photo-1571091718767-18b5b1457add?w=400", lat:48.205833, lng:16.384167, price:"‚Ç¨", hours:"9:00-23:00", distance:0 }
      ],
      parks: [
        { name:"Stadtpark", description:"Parco con statua dorata di Johann Strauss.", image:"https://images.unsplash.com/photo-1590682244746-d7b27e6a5c9b?w=400", lat:48.204722, lng:16.378611, price:"Gratuito", hours:"Sempre aperto", distance:0 },
        { name:"Volksgarten", description:"Giardino delle rose con oltre 3000 rosai.", image:"https://images.unsplash.com/photo-1559128019-7c1dd7c9eefd?w=400", lat:48.207778, lng:16.361111, price:"Gratuito", hours:"Sempre aperto", distance:0 },
        { name:"Augarten", description:"Parco barocco con torre antiaerea.", image:"https://images.unsplash.com/photo-1589207821092-9ce3f6132eb9?w=400", lat:48.226111, lng:16.380278, price:"Gratuito", hours:"Sempre aperto", distance:0 }
      ],
      shopping: [
        { name:"Graben & Kohlmarkt", description:"Shopping di lusso.", image:"https://images.unsplash.com/photo-1520176501380-c1d889d43cd5?w=400", lat:48.208889, lng:16.369444, price:"N/D", hours:"10:00-19:00", distance:0 },
        { name:"Mariahilfer Stra√üe", description:"Via commerciale pi√π lunga (1.8 km).", image:"https://images.unsplash.com/photo-1472851294608-062f824d29cc?w=400", lat:48.196944, lng:16.340278, price:"N/D", hours:"10:00-20:00", distance:0 }
      ],
      attractions: [] // dinamico da OSM
    };

              <div class="guide-gallery">
                <img src="https://images.unsplash.com/photo-1566139447295-8c4df4b28707?w=400" alt="Sala degli Specchi">
                <img src="https://images.unsplash.com/photo-1559128010-7c1ad6e1b6a5?w=400" alt="Grande Galleria">
                <img src="https://images.unsplash.com/photo-1583037189850-1921ae7c6c22?w=400" alt="Salon Cinese">
              </div>
            `
          },
          giardini: {
            title: 'Giardini e Parco',
            audio: "I giardini di Sch√∂nbrunn si estendono per 120 ettari, combinando giardino formale francese con elementi inglesi. La Gloriette offre una vista panoramica su Vienna.",
            content: `
              <h3>Un Capolavoro di Arte Paesaggistica</h3>
              <p>I giardini di Sch√∂nbrunn rappresentano uno dei pi√π bei esempi di giardino barocco in Europa, dove natura e architettura si fondono in perfetta armonia.</p>
              
              <h4>Giardino Parterre</h4>
              <p>Il giardino formale davanti al palazzo segue lo stile francese di Andr√© Le N√¥tre. Le aiuole geometriche cambiano colore secondo le stagioni, creando un tappeto vivente di fiori che si estende verso la Gloriette.</p>
              
              <h4>La Gloriette</h4>
              <p>Costruita nel 1775, questa struttura neoclassica corona la collina di Sch√∂nbrunn. Alta 25 metri, offre una vista spettacolare su Vienna e commemora la battaglia di Kol√≠n del 1757.</p>
              
              <h4>Giardino del Principe Ereditario</h4>
              <p>Un giardino privato in stile inglese, pi√π intimo e naturale, dove la famiglia imperiale si rilassava lontano dall'etichetta di corte.</p>
              
              <h4>Fontana di Nettuno</h4>
              <p>Al centro del giardino, questa imponente fontana barocca raffigura Nettuno che domina i mari, simbolo del potere asburgico che si estendeva "dai monti al mare".</p>
              
              <div class="guide-gallery">
                <img src="https://images.unsplash.com/photo-1589207821092-9ce3f6132eb9?w=400" alt="Giardini formali">
                <img src="https://images.unsplash.com/photo-1590682244746-d7b27e6a5c9b?w=400" alt="Gloriette">
                <img src="https://images.unsplash.com/photo-1559128019-7c1dd7c9eefd?w=400" alt="Fontana di Nettuno">
              </div>
            `
          }
        }
      }
    };

    /* =======================
       Logica Guida Interattiva
    ======================= */
    let currentGuideData = null;
    let currentSection = null;
    let speechUtterance = null;

    function showInteractiveGuide() {
      document.getElementById('placesGrid').style.display = 'none';
      document.getElementById('interactiveGuide').classList.add('active');
      
      // Mostra lista di monumenti disponibili
      const grid = document.getElementById('placesGrid');
      grid.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
          <div class="place-card" onclick="loadGuideContent('stephansdom')" style="cursor: pointer;">
            <img src="https://images.unsplash.com/photo-1609856878074-cf31e21ccb6b?w=400" alt="Cattedrale Santo Stefano" class="place-image">
            <div class="place-info">
              <div class="place-name">Cattedrale di Santo Stefano</div>
              <div class="place-description">Guida completa al simbolo di Vienna con audio e contenuti dettagliati</div>
              <button class="navigate-btn">Inizia la guida interattiva</button>
            </div>
          </div>
          <div class="place-card" onclick="loadGuideContent('schonbrunn')" style="cursor: pointer;">
            <img src="https://images.unsplash.com/photo-1516550893923-42d28e5677af?w=400" alt="Palazzo Sch√∂nbrunn" class="place-image">
            <div class="place-info">
              <div class="place-name">Palazzo di Sch√∂nbrunn</div>
              <div class="place-description">Esplora la residenza imperiale con visite guidate audio</div>
              <button class="navigate-btn">Inizia la guida interattiva</button>
            </div>
          </div>
        </div>
      `;
      grid.style.display = 'block';
      document.getElementById('interactiveGuide').style.display = 'none';
    }

    function showMainGuide() {
      document.getElementById('interactiveGuide').classList.remove('active');
      document.getElementById('interactiveGuide').style.display = 'none';
      document.getElementById('placesGrid').style.display = 'grid';
      stopAudio();
    }

    function loadGuideContent(guideId) {
      currentGuideData = interactiveGuides[guideId];
      if (!currentGuideData) return;
      
      document.getElementById('placesGrid').style.display = 'none';
      document.getElementById('interactiveGuide').style.display = 'block';
      document.getElementById('interactiveGuide').classList.add('active');
      
      // Popola header
      document.getElementById('guideMainImage').src = currentGuideData.mainImage;
      document.getElementById('guideMainTitle').textContent = currentGuideData.title;
      document.getElementById('guideMainSubtitle').textContent = currentGuideData.subtitle;
      
      // Popola fatti rapidi
      const quickFacts = document.getElementById('guideQuickFacts');
      let factsHTML = '<h4>Informazioni Rapide</h4>';
      Object.entries(currentGuideData.quickFacts).forEach(([key, value]) => {
        factsHTML += `<div class="fact"><span><strong>${key}:</strong></span><span>${value}</span></div>`;
      });
      quickFacts.innerHTML = factsHTML;
      
      // Crea navigazione
      const navigation = document.getElementById('guideNavigation');
      navigation.innerHTML = Object.entries(currentGuideData.sections).map(([key, section]) => 
        `<button class="guide-nav-btn" onclick="showGuideSection('${key}')">${section.title}</button>`
      ).join('');
      
      // Mostra prima sezione
      const firstSection = Object.keys(currentGuideData.sections)[0];
      showGuideSection(firstSection);
    }

    function showGuideSection(sectionKey) {
      if (!currentGuideData) return;
      
      currentSection = sectionKey;
      const sectionData = currentGuideData.sections[sectionKey];
      
      // Aggiorna navigazione
      document.querySelectorAll('.guide-nav-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Mostra contenuto
      document.getElementById('guideContent').innerHTML = sectionData.content;
      
      // Aggiorna audio
      setupAudioButtons(sectionData.audio);
    }

    function setupAudioButtons(sectionAudio) {
      const playIntroBtn = document.getElementById('playIntroBtn');
      const playCurrentBtn = document.getElementById('playCurrentBtn');
      const stopAudioBtn = document.getElementById('stopAudioBtn');
      
      playIntroBtn.onclick = () => playAudio(currentGuideData.audioIntro);
      playCurrentBtn.onclick = () => playAudio(sectionAudio);
      stopAudioBtn.onclick = stopAudio;
    }

    function playAudio(text) {
      if (!text) return;
      
      stopAudio();
      
      if ('speechSynthesis' in window) {
        speechUtterance = new SpeechSynthesisUtterance(text);
        speechUtterance.lang = 'it-IT';
        speechUtterance.rate = 0.9;
        speechUtterance.pitch = 1.0;
        speechUtterance.volume = 1.0;
        
        speechUtterance.onstart = () => {
          document.querySelectorAll('.guide-audio-btn').forEach(btn => btn.classList.remove('playing'));
          event.target.classList.add('playing');
        };
        
        speechUtterance.onend = () => {
          document.querySelectorAll('.guide-audio-btn').forEach(btn => btn.classList.remove('playing'));
        };
        
        window.speechSynthesis.speak(speechUtterance);
      } else {
        alert('Audio non supportato in questo browser');
      }
    }

    function stopAudio() {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
      document.querySelectorAll('.guide-audio-btn').forEach(btn => btn.classList.remove('playing'));
    }

    /* =======================
       Galleria Immagini
    ======================= */
    let currentImageIndex = 0;
    let currentImages = [];

    function openImageModal(imgElement) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      
      // Trova tutte le immagini nella galleria corrente
      const gallery = imgElement.closest('.guide-gallery');
      if (gallery) {
        currentImages = Array.from(gallery.querySelectorAll('img'));
        currentImageIndex = currentImages.indexOf(imgElement);
      } else {
        currentImages = [imgElement];
        currentImageIndex = 0;
      }
      
      modalImg.src = imgElement.src;
      modalImg.alt = imgElement.alt;
      modal.style.display = 'block';
      
      // Aggiorna visibilit√† pulsanti navigazione
      const prevBtn = document.querySelector('.image-modal-prev');
      const nextBtn = document.querySelector('.image-modal-next');
      prevBtn.style.display = currentImages.length > 1 ? 'block' : 'none';
      nextBtn.style.display = currentImages.length > 1 ? 'block' : 'none';
    }

    function closeImageModal() {
      document.getElementById('imageModal').style.display = 'none';
    }

    function navigateImage(direction) {
      if (currentImages.length <= 1) return;
      
      currentImageIndex += direction;
      if (currentImageIndex < 0) currentImageIndex = currentImages.length - 1;
      if (currentImageIndex >= currentImages.length) currentImageIndex = 0;
      
      const modalImg = document.getElementById('modalImage');
      modalImg.src = currentImages[currentImageIndex].src;
      modalImg.alt = currentImages[currentImageIndex].alt;
    }

    // Funzione per aggiungere click handler alle immagini delle gallerie
    function setupImageGalleries() {
      document.addEventListener('click', (e) => {
        if (e.target.matches('.guide-gallery img')) {
          e.preventDefault();
          openImageModal(e.target);
        }
      });
    }
    const liveGuides = [
      {
        id: 'stephansdom',
        name: 'Cattedrale di Santo Stefano',
        lat: 48.208492, lng: 16.373119,
        radius: 80,
        fov: 70,
        blurb: "Simbolo di Vienna in stile gotico, iniziata nel XII secolo. La torre sud raggiunge i 136 metri.",
        tts: "Davanti a te la Cattedrale di Santo Stefano, simbolo di Vienna. La torre sud raggiunge i 136 metri.",
        image: "https://images.unsplash.com/photo-1609856878074-cf31e21ccb6b?w=800",
        sections: [
          { title: "Facciata", text: "La facciata fu ricostruita dopo i bombardamenti del 1945." },
          { title: "Interno", text: "All'interno, altare barocco e navata gotica si fondono armonicamente." }
        ]
      },
      {
        id: 'hofburg',
        name: 'Hofburg',
        lat: 48.206507, lng: 16.365262,
        radius: 90,
        fov: 70,
        blurb: "Antica residenza degli Asburgo. Ospita la Biblioteca Nazionale e la Scuola di Equitazione Spagnola.",
        tts: "Stai guardando l'Hofburg, antica residenza imperiale degli Asburgo.",
        image: "https://images.unsplash.com/photo-1559128010-7c1ad6e1b6a5?w=800",
        sections: [
          { title: "Biblioteca", text: "La Prunksaal √® una delle biblioteche barocche pi√π belle del mondo." }
        ]
      }
    ];

    /* =======================
       Stato & mappa
    ======================= */
    let map, markers = [], currentCategory = 'monuments';
    let userMarker = null, userLocation = null, watchId = null, currentSort = 'default';

    function initMap(){
      map = L.map('map').setView([hotelLocation.lat, hotelLocation.lng], 14);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'¬© OpenStreetMap contributors'
      }).addTo(map);

      const hotelIcon = L.divIcon({
        html:'<div style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;padding:8px;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 3px 10px rgba(0,0,0,.3);">üè®</div>',
        iconSize:[40,40], iconAnchor:[20,20]
      });

      L.marker([hotelLocation.lat, hotelLocation.lng], {icon:hotelIcon})
        .addTo(map)
        .bindPopup(`<strong>${hotelLocation.name}</strong><br>${hotelLocation.address}`)
        .openPopup();

      initGeolocation();
    }

    function initGeolocation(){
      if("geolocation" in navigator){
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy); startLocationTracking(); },
          (err)=>{ console.log("Geo negata/non disponibile:", err); },
          { enableHighAccuracy:true }
        );
      }
    }

    function startLocationTracking(){
      if("geolocation" in navigator){
        watchId = navigator.geolocation.watchPosition(
          (pos)=>updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy),
          (err)=>console.error("Errore tracking:", err),
          { enableHighAccuracy:true, timeout:5000, maximumAge:0 }
        );
        document.getElementById('locationStatus').classList.add('active');
        const locationBtn = document.getElementById('locationBtn');
        if(locationBtn) locationBtn.classList.add('active');
      }
    }

    // Sempre visibile/centrata + cerchio di accuratezza
    function updateUserLocation(lat, lng, accuracy){
      userLocation = { lat, lng };

      // Marker utente
      if (userMarker) map.removeLayer(userMarker);
      const userIcon = L.divIcon({
        html:`<div style="position:relative;">
                <div style="background:#2196F3;border:3px solid #fff;border-radius:50%;width:20px;height:20px;box-shadow:0 2px 5px rgba(0,0,0,.3);"></div>
                <div style="position:absolute;top:-5px;left:-5px;width:30px;height:30px;border:2px solid #2196F3;border-radius:50%;opacity:.3;animation:pulse 2s infinite;"></div>
              </div>`,
        iconSize:[30,30], iconAnchor:[15,15]
      });
      userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(map).bindPopup("<strong>La tua posizione</strong>");
      if (userMarker && userMarker._icon) userMarker._icon.style.zIndex = 10000;

      // Cerchio di accuratezza
      if (userCircle) map.removeLayer(userCircle);
      if (Number.isFinite(accuracy)) {
        userCircle = L.circle([lat, lng], {
          radius: Math.max(accuracy, 15),
          color: '#2196F3',
          fillColor: '#2196F3',
          fillOpacity: 0.15,
          weight: 1
        }).addTo(map);
      }

      // Segui sempre la posizione
      if (autoFollow) {
        const targetZoom = Math.max(map.getZoom(), 15);
        map.setView([lat, lng], targetZoom, { animate: false });
      }

      // Distanze/lista
      updateDistancesFromUser();
      if (currentSort === 'distance') {
        renderPlaces(currentCategory, document.getElementById('searchBar').value);
      }

      // Tick guida (se attiva)
      liveGuideTick();
    }

    function centerOnUser(){
      if(userLocation){
        map.setView([userLocation.lat, userLocation.lng], Math.max(map.getZoom(), 15));
        if(userMarker) userMarker.openPopup();
      } else if("geolocation" in navigator){
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ updateUserLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy); map.setView([pos.coords.latitude, pos.coords.longitude], 16); startLocationTracking(); },
          ()=>alert("Abilita la geolocalizzazione nel browser")
        );
      }
    }

    function calculateDistance(lat1,lon1,lat2,lon2){
      const R = 6371e3;
      const œÜ1 = lat1*Math.PI/180, œÜ2 = lat2*Math.PI/180;
      const ŒîœÜ = (lat2-lat1)*Math.PI/180, ŒîŒª = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }

    function updateDistances(){
      Object.keys(places).forEach(cat=>{
        places[cat].forEach(p=>{
          p.distance = Math.round(calculateDistance(hotelLocation.lat, hotelLocation.lng, p.lat, p.lng));
        });
      });
    }

    function updateDistancesFromUser(){
      if(!userLocation) return;
      Object.keys(places).forEach(cat=>{
        places[cat].forEach(p=>{
          p.distanceFromUser = Math.round(calculateDistance(userLocation.lat, userLocation.lng, p.lat, p.lng));
        });
      });
    }

    function showPlacesOnMap(category){
      markers.forEach(m=>map.removeLayer(m));
      markers = [];
      const categoryEmojis = { monuments:'üèõÔ∏è', museums:'üé®', restaurants:'üçΩÔ∏è', fastfood:'üçî', parks:'üå≥', shopping:'üõçÔ∏è', attractions:'‚ú®' };

      (places[category]||[]).forEach(place=>{
        let emoji = categoryEmojis[category];
        let bg = 'linear-gradient(135deg,#667eea 0%,#764ba2 100%)';
        if(category==='fastfood'){
          if(place.name.toLowerCase().includes('mcdonald')){ emoji='M'; bg='linear-gradient(135deg,#FFC600 0%,#FF0000 100%)'; }
          else if(place.name.toLowerCase().includes('burger king')){ emoji='BK'; bg='linear-gradient(135deg,#FF6900 0%,#8B4513 100%)'; }
        }
        const icon = L.divIcon({
          html:`<div style="background:${bg};color:#fff;padding:5px;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:${emoji.length>1?'10px':'16px'};font-weight:bold;box-shadow:0 2px 6px rgba(0,0,0,.3);">${emoji}</div>`,
          iconSize:[30,30], iconAnchor:[15,15]
        });

        const marker = L.marker([place.lat, place.lng], {icon})
          .addTo(map)
          .bindPopup(`
            <strong>${place.name}</strong><br>
            ${place.description ? place.description.substring(0,100) : ''}...<br>
            <strong>Distanza:</strong> ${place.distance ?? '-'} m<br>
            <strong>Prezzo:</strong> ${place.price ?? '-'}<br>
            <strong>Orari:</strong> ${place.hours ?? '-'}
          `);
        markers.push(marker);
      });
    }

    function renderPlaces(category, searchTerm='', filters=[]){
      const grid = document.getElementById('placesGrid');
      let list = places[category] || [];

      if(searchTerm){
        const s = searchTerm.toLowerCase();
        list = list.filter(p => (p.name||'').toLowerCase().includes(s) || (p.description||'').toLowerCase().includes(s));
      }

      if(filters.length){
        list = list.filter(p=>{
          let pass = true;
          filters.forEach(f=>{
            if(f==='free' && !(p.price||'').toLowerCase().includes('gratuito')) pass=false;
            if(f==='paid' && (p.price||'').toLowerCase().includes('gratuito')) pass=false;
            if(f==='walking' && (p.distance ?? 999999) > 500) pass=false;
            if(f==='transport' && (p.distance ?? 0) <= 500) pass=false;
          });
          return pass;
        });
      }

      if(currentSort==='distance' && userLocation){
        list.sort((a,b)=> (a.distanceFromUser??999999)-(b.distanceFromUser??999999));
      }else if(currentSort==='name'){
        list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      }

      grid.innerHTML = list.map(place=>{
        const useUserLocation = !!userLocation && currentSort==='distance';
        const currentDistance = useUserLocation ? (place.distanceFromUser ?? place.distance) : place.distance;
        const transportType = (currentDistance<=500) ? 'üö∂ A piedi' : 'üöá Mezzi pubblici';
        const transportColor = (currentDistance<=500) ? '#4CAF50' : '#2196F3';
        const priceClass = (place.price||'').toLowerCase().includes('gratuito') ? 'free-badge' : '';

        let distanceInfo = (place.distance!=null) ? `${place.distance}m dall'hotel` : '-';
        if(userLocation && place.distanceFromUser!==undefined){
          distanceInfo += ` <span class="distance-badge" style="background:#2196F3;">üìç ${place.distanceFromUser}m da te</span>`;
        }

        return `
          <div class="place-card">
            <img src="${place.image||'https://images.unsplash.com/photo-1528909514045-2fa4ac7a08ba?w=400'}" alt="${place.name}" class="place-image">
            <div class="place-info">
              <div class="place-name">${place.name}</div>
              <div class="place-description">${place.description||''}</div>
              <div class="detail">üìç <span>${distanceInfo}</span></div>
              <div class="detail"><span class="distance-badge" style="background:${transportColor};">${transportType}</span></div>
              <div class="detail">üí∞ <span class="price-badge ${priceClass}">${place.price||'‚Äî'}</span></div>
              <div class="detail">üïê <span>${place.hours||'‚Äî'}</span></div>
              <button class="navigate-btn"
                onclick="showNavigationModal('${(place.name||'').replace(/'/g, "\\'")}', ${place.lat}, ${place.lng}, ${currentDistance||999999}, ${useUserLocation})">
                üìç Indicazioni Stradali
              </button>
            </div>
          </div>
        `;
      }).join('');

      if(!list.length){
        grid.innerHTML = '<div class="tip">Nessun risultato con i filtri attuali.</div>';
      }
    }

    // Modal navigazione
    window.showNavigationModal = function(placeName, lat, lng, distance, fromUserLocation=false){
      const modal = document.getElementById('navigationModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      const startLat = (fromUserLocation && userLocation) ? userLocation.lat : hotelLocation.lat;
      const startLng = (fromUserLocation && userLocation) ? userLocation.lng : hotelLocation.lng;
      const startName = (fromUserLocation && userLocation) ? "la tua posizione" : hotelLocation.name;

      modalTitle.textContent = `Navigazione verso ${placeName}`;

      let html = '';
      if(distance <= 500){
        html = `
          <div class="navigation-options">
            <h3>üö∂ Percorso a piedi (${distance}m - ~${Math.round(distance/80)} min)</h3>
            <p class="tip">Partenza da: <strong>${startName}</strong></p>
            <div class="nav-option" onclick="openGoogleMaps(${lat}, ${lng}, 'walking', ${startLat}, ${startLng})"><h4>Google Maps - A piedi</h4></div>
            <div class="nav-option" onclick="openAppleMaps(${lat}, ${lng}, 'walking', ${startLat}, ${startLng})"><h4>Apple Maps - A piedi</h4></div>
          </div>`;
      } else {
        const walkingTime = Math.round(distance/80);
        const transitTime  = Math.round(distance/250);
        html = `
          <div class="navigation-options">
            <h3>üöá Mezzi pubblici consigliati (~${transitTime} min)</h3>
            <p class="tip">Partenza da: <strong>${startName}</strong></p>
            <div class="nav-option" onclick="openGoogleMaps(${lat}, ${lng}, 'transit', ${startLat}, ${startLng})"><h4>Google Maps - Mezzi pubblici</h4></div>
            <div class="nav-option" onclick="openWienerLinien(${lat}, ${lng}, ${startLat}, ${startLng})"><h4>Wiener Linien - Planner</h4></div>
            <div class="nav-option" onclick="openUber(${lat}, ${lng}, ${startLat}, ${startLng})"><h4>Uber / Taxi</h4></div>
            <hr style="margin:14px 0;border:1px solid #eee;">
            <h3>üö∂ Alternativa a piedi (~${walkingTime} min)</h3>
            <div class="nav-option" onclick="openGoogleMaps(${lat}, ${lng}, 'walking', ${startLat}, ${startLng})"><h4>Google Maps - A piedi</h4></div>
          </div>`;
      }

      modalBody.innerHTML = html;
      modal.style.display = 'block';
    };

    // Apertura navigazione
    window.openGoogleMaps = function(lat, lng, mode, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const travelMode = (mode === 'walking') ? '2' : '3';
      const url = `https://www.google.com/maps/dir/${sLat},${sLng}/${lat},${lng}/@${lat},${lng},15z/data=!4m2!4m1!3e${travelMode}`;
      window.open(url, '_blank');
    };
    window.openAppleMaps = function(lat, lng, mode, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const dirflg = (mode === 'walking') ? 'w' : 'r';
      const url = `https://maps.apple.com/?saddr=${sLat},${sLng}&daddr=${lat},${lng}&dirflg=${dirflg}`;
      window.open(url, '_blank');
    };
    window.openWienerLinien = function(lat, lng, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const url = `https://www.wienerlinien.at/web/wl-en/journey-planner?from=${sLat},${sLng}&to=${lat},${lng}`;
      window.open(url, '_blank');
    };
    window.openUber = function(lat, lng, startLat, startLng){
      const sLat = startLat ?? hotelLocation.lat;
      const sLng = startLng ?? hotelLocation.lng;
      const url = `https://m.uber.com/ul/?action=setPickup&pickup[latitude]=${sLat}&pickup[longitude]=${sLng}&dropoff[latitude]=${lat}&dropoff[longitude]=${lng}`;
      window.open(url, '_blank');
    };

    // ATTRAZIONI DINAMICHE (Overpass/OSM)
    async function loadAttractionsFromOverpass(centerLat, centerLng, radiusMeters = 5000) {
      const endpoint = 'https://overpass-api.de/api/interpreter';
      const query = `
        [out:json][timeout:25];
        (
          node(around:${radiusMeters},${centerLat},${centerLng})["tourism"~"attraction|museum|gallery|viewpoint|theme_park"];
          way(around:${radiusMeters},${centerLat},${centerLng})["tourism"~"attraction|museum|gallery|viewpoint|theme_park"];
          relation(around:${radiusMeters},${centerLat},${centerLng})["tourism"~"attraction|museum|gallery|viewpoint|theme_park"];
        );
        out center tags 100;
      `;
      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'},
          body: 'data=' + encodeURIComponent(query)
        });
        const json = await res.json();
        const results = (json.elements||[]).map(el=>{
          const tags = el.tags||{};
          const name = tags.name || 'Attrazione';
          const lat = el.lat || (el.center && el.center.lat);
          const lng = el.lon || (el.center && el.center.lon);
          if (!lat || !lng) return null;

          const descParts = [];
          if (tags['tourism']) descParts.push(`#${tags['tourism']}`);
          if (tags['wikidata']) descParts.push(`Wikidata: ${tags['wikidata']}`);
          if (tags['wikipedia']) descParts.push(`Wikipedia: ${tags['wikipedia']}`);
          const description = tags.description || descParts.join(' ‚Ä¢ ') || 'Attrazione turistica';

          const hours = tags.opening_hours || "Orari non disponibili";
          const price = "‚Äî";
          const image = "https://images.unsplash.com/photo-1528909514045-2fa4ac7a08ba?w=400";

          return {
            name, description, image, lat, lng, price, hours,
            distance: Math.round(calculateDistance(hotelLocation.lat, hotelLocation.lng, lat, lng))
          };
        }).filter(Boolean);

        const key = p => `${(p.name||'').toLowerCase()}@${p.lat.toFixed(5)},${p.lng.toFixed(5)}`;
        const existing = new Set((places.attractions||[]).map(key));
        const fresh = results.filter(p => !existing.has(key(p)));

        places.attractions = [...(places.attractions||[]), ...fresh];

        if (currentCategory === 'attractions') {
          if (userLocation) updateDistancesFromUser();
          renderPlaces('attractions', document.getElementById('searchBar').value);
          showPlacesOnMap('attractions');
        }
        alert(`Caricate ${fresh.length} nuove attrazioni OSM.`);
      } catch (e) {
        console.error('Overpass error:', e);
        alert('Impossibile caricare attrazioni ora. Riprova pi√π tardi.');
      }
    }

    /* =======================
       Guida Live: bussola & logica
    ======================= */
    let deviceHeading = null;    // 0..360 (Nord=0)
    let lastGuideId = null;
    let guideCooldown = 8000;    // ms
    let lastAnnounceTs = 0;

    function degNormalize(a){ return (a % 360 + 360) % 360; }
    function degDiff(a, b){
      let d = Math.abs(degNormalize(a) - degNormalize(b));
      return d > 180 ? 360 - d : d;
    }
    function bearingTo(lat1, lon1, lat2, lon2){
      const œÜ1 = lat1 * Math.PI/180, œÜ2 = lat2 * Math.PI/180;
      const Œª1 = lon1 * Math.PI/180, Œª2 = lon2 * Math.PI/180;
      const y = Math.sin(Œª2-Œª1) * Math.cos(œÜ2);
      const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);
      const Œ∏ = Math.atan2(y, x) * 180/Math.PI;
      return degNormalize(Œ∏);
    }

    function enableCompass(){
      const iOS = typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function';
      const handler = (e)=>{
        if (typeof e.webkitCompassHeading === 'number') {
          deviceHeading = e.webkitCompassHeading;  // iOS
        } else if (typeof e.alpha === 'number') {
          deviceHeading = 360 - e.alpha;           // best-effort
        }
        // aggiorna la UI freccia se serve
        liveGuideTick();
      };

      if (iOS) {
        // chiediamo permesso quando l'utente abilita la guida
        const checkbox = document.getElementById('guideEnable');
        checkbox?.addEventListener('change', ()=>{
          if(checkbox.checked){
            DeviceOrientationEvent.requestPermission()
              .then(state=>{
                if(state === 'granted'){
                  window.addEventListener('deviceorientation', handler, true);
                }
              })
              .catch(()=>{ /* rifiutato */ });
          } else {
            window.removeEventListener('deviceorientation', handler, true);
            deviceHeading = null;
          }
        });
      } else {
        // non iOS: attiva sempre i listener
        window.addEventListener('deviceorientationabsolute', handler, true);
        window.addEventListener('deviceorientation', handler, true);
      }
    }

    function pickFrontPoi(){
      if(!userLocation) return null;
      const nearby = liveGuides
        .map(p => {
          const dist = calculateDistance(userLocation.lat, userLocation.lng, p.lat, p.lng);
          const brg  = bearingTo(userLocation.lat, userLocation.lng, p.lat, p.lng);
          return {...p, _dist: dist, _brg: brg};
        })
        .filter(p => p._dist <= (p.radius || 60));
      if(!nearby.length) return null;

      let front = nearby;
      if (deviceHeading != null) {
        front = nearby.filter(p => degDiff(deviceHeading, p._brg) <= ((p.fov || 60) / 2));
        if(!front.length) front = nearby;
      }
      front.sort((a,b) => a._dist - b._dist);
      return front[0];
    }

    function updateLiveGuideUI(poi){
      const onEl  = document.getElementById('guideNow');
      const offEl = document.getElementById('guideNone');
      const sectionsEl = document.getElementById('guideSections');

      if(!poi){
        onEl.style.display = 'none';
        offEl.style.display = 'block';
        sectionsEl.innerHTML = '';
        return;
      }

      onEl.style.display = 'block';
      offEl.style.display = 'none';

      document.getElementById('guideImg').src = poi.image || '';
      document.getElementById('guideTitle').textContent = poi.name;
      document.getElementById('guideBlurb').textContent = poi.blurb || '';
      document.getElementById('guideDistance').textContent = `Distanza: ${Math.round(poi._dist)} m`;

      sectionsEl.innerHTML = (poi.sections||[]).map(s => `
        <div style="margin-top:8px;">
          <div style="font-weight:600">${s.title}</div>
          <div class="tip">${s.text}</div>
        </div>
      `).join('');

      const arrow = document.getElementById('arrowFov');
      if (deviceHeading != null) {
        const rel = degNormalize(poi._brg - deviceHeading);
        arrow.style.transform = `translateX(-50%) rotate(${rel}deg)`;
      } else {
        arrow.style.transform = `translateX(-50%) rotate(0deg)`;
      }
    }

    function speak(text){
      if(!text) return;
      if (!('speechSynthesis' in window)) return;
      const voiceOn = document.getElementById('guideVoice')?.checked;
      if(!voiceOn) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'it-IT';
      u.rate = 1.0;
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
    }

    function liveGuideTick(){
      const enabled = document.getElementById('guideEnable')?.checked;
      if(!enabled){
        // reset UI minima
        document.getElementById('guideNow').style.display = 'none';
        document.getElementById('guideNone').style.display = 'block';
        return;
      }
      const poi = pickFrontPoi();
      updateLiveGuideUI(poi);

      const now = Date.now();
      if (poi && poi.id !== lastGuideId && now - lastAnnounceTs > guideCooldown) {
        speak(poi.tts || poi.blurb);
        lastGuideId = poi.id;
        lastAnnounceTs = now;
      }
    }

    // Supporto per localStorage con fallback
    function saveToStorage(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
      } catch (e) {
        console.warn('localStorage non disponibile, uso memoria temporanea');
        window._tempStorage = window._tempStorage || {};
        window._tempStorage[key] = value;
        return false;
      }
    }

    function loadFromStorage(key) {
      try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : null;
      } catch (e) {
        return window._tempStorage?.[key] || null;
      }
    }

    /* =======================
       Eventi
    ======================= */
    document.addEventListener('DOMContentLoaded', ()=>{
      initMap();
      updateDistances();
      renderPlaces('monuments');
      showPlacesOnMap('monuments');

      const locationBtn = document.getElementById('locationBtn');
      if(locationBtn) locationBtn.addEventListener('click', centerOnUser);

      document.querySelectorAll('.category-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const cat = this.dataset.category;
          if(!cat) return;
          document.querySelectorAll('.category-btn').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          currentCategory = cat;
          renderPlaces(cat, document.getElementById('searchBar').value);
          showPlacesOnMap(cat);
        });
      });

      document.querySelectorAll('.sort-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          document.querySelectorAll('.sort-btn').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          currentSort = this.dataset.sort;
          if(currentSort==='distance' && !userLocation){ centerOnUser(); }
          renderPlaces(currentCategory, document.getElementById('searchBar').value);
        });
      });

      const activeFilters = [];
      const searchBar = document.getElementById('searchBar');
      if(searchBar) {
        searchBar.addEventListener('input', e=>{
          renderPlaces(currentCategory, e.target.value, activeFilters);
        });
      }
      
      document.querySelectorAll('.chip').forEach(chip=>{
        chip.addEventListener('click', function(){
          const f = this.dataset.filter;
          if(this.classList.contains('active')){
            this.classList.remove('active');
            const i = activeFilters.indexOf(f);
            if(i>-1) activeFilters.splice(i,1);
          }else{
            this.classList.add('active');
            activeFilters.push(f);
          }
          renderPlaces(currentCategory, searchBar?.value || '', activeFilters);
        });
      });

      const btnLoadAttractions = document.getElementById('btnLoadAttractions');
      if(btnOpenFindMy) {
        btnOpenFindMy.addEventListener('click', ()=>{
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          if(isIOS){
            window.location.href = 'findmy://';
            setTimeout(()=>alert('Se Dov\'√® non si √® aperta, aprila manualmente: Apple non offre link/API diretti per un AirTag specifico.'), 800);
          } else {
            alert('Il collegamento "Dov\'√®" √® disponibile solo su iOS. Usa l\'iPhone/iPad per aprire l\'app.');
          }
        });
      }

      if(btnFindMyHelp) {
        btnFindMyHelp.addEventListener('click', ()=>{
          alert('Gli AirTag non hanno API web: questo bottone prova solo ad aprire l\'app Dov\'√® su iOS. Puoi salvare coordinate note e navigare l√¨.');
        });
      }

      if(btnSaveTag && tagName && tagLat && tagLng && tagInfo) {
        btnSaveTag.addEventListener('click', ()=>{
          const n = tagName.value.trim() || 'Oggetto';
          const la = parseFloat(tagLat.value);
          const ln = parseFloat(tagLng.value);
          if(Number.isFinite(la) && Number.isFinite(ln)){
            saveToStorage('savedTag', {name:n, lat:la, lng:ln});
            tagInfo.textContent = `Salvato: ${n} (${la}, ${ln})`;
            alert('Coordinate salvate.');
          } else {
            alert('Inserisci coordinate valide (lat/lng).');
          }
        });
      }

      if(btnUseMyPos && tagLat && tagLng) {
        btnUseMyPos.addEventListener('click', ()=>{
          if(userLocation){
            tagLat.value = userLocation.lat.toFixed(6);
            tagLng.value = userLocation.lng.toFixed(6);
          } else {
            centerOnUser();
            alert('Posizione in acquisizione: riprova tra un attimo.');
          }
        });
      }

      if(btnApple && tagLat && tagLng) {
        btnApple.addEventListener('click', ()=>{
          const la = parseFloat(tagLat.value), ln = parseFloat(tagLng.value);
          if(Number.isFinite(la) && Number.isFinite(ln)){
            const url = `https://maps.apple.com/?daddr=${la},${ln}&dirflg=d`;
            window.open(url, '_blank');
          } else alert('Inserisci coordinate valide.');
        });
      }

      if(btnGoogle && tagLat && tagLng) {
        btnGoogle.addEventListener('click', ()=>{
          const la = parseFloat(tagLat.value), ln = parseFloat(tagLng.value);
          if(Number.isFinite(la) && Number.isFinite(ln)){
            const url = `https://www.google.com/maps/dir//${la},${ln}`;
            window.open(url, '_blank');
          } else alert('Inserisci coordinate valide.');
        });
      }

      // Guida Live - pulsanti
      const guideRepeat = document.getElementById('guideRepeat');
      const guideNavigate = document.getElementById('guideNavigate');
      let currentGuidePoi = null;

      if(guideRepeat) {
        guideRepeat.addEventListener('click', ()=>{
          if(currentGuidePoi) {
            speak(currentGuidePoi.tts || currentGuidePoi.blurb);
          }
        });
      }

      if(guideNavigate) {
        guideNavigate.addEventListener('click', ()=>{
          if(currentGuidePoi) {
            const distance = currentGuidePoi._dist || 0;
            showNavigationModal(currentGuidePoi.name, currentGuidePoi.lat, currentGuidePoi.lng, distance, true);
          }
        });
      }

      // Aggiorna la funzione updateLiveGuideUI per salvare il POI corrente
      const originalUpdateLiveGuideUI = updateLiveGuideUI;
      updateLiveGuideUI = function(poi) {
        currentGuidePoi = poi;
        return originalUpdateLiveGuideUI(poi);
      };

      // Guida Live - setup
      enableCompass();                   // setup bussola (richiede permesso iOS al toggle)
      setInterval(liveGuideTick, 1500);  // controllo periodico (funziona solo se abilitata)
      
      // Setup gallerie immagini
      setupImageGalleries();
      
      // Eventi per modal galleria
      const imageModal = document.getElementById('imageModal');
      const imageModalClose = document.querySelector('.image-modal-close');
      const prevBtn = document.querySelector('.image-modal-prev');
      const nextBtn = document.querySelector('.image-modal-next');
      
      if(imageModalClose) {
        imageModalClose.addEventListener('click', closeImageModal);
      }
      
      if(prevBtn) {
        prevBtn.addEventListener('click', () => navigateImage(-1));
      }
      
      if(nextBtn) {
        nextBtn.addEventListener('click', () => navigateImage(1));
      }
      
      // Chiudi modal con click fuori dall'immagine
      if(imageModal) {
        imageModal.addEventListener('click', (e) => {
          if (e.target === imageModal) closeImageModal();
        });
      }
      
      // Navigazione con tastiera
      document.addEventListener('keydown', (e) => {
        if (imageModal && imageModal.style.display === 'block') {
          if (e.key === 'Escape') closeImageModal();
          if (e.key === 'ArrowLeft') navigateImage(-1);
          if (e.key === 'ArrowRight') navigateImage(1);
        }
      });
    });

    // Gestione resize e cleanup
    window.addEventListener('resize', ()=>{ if(map) map.invalidateSize(); });
    window.addEventListener('beforeunload', ()=>{ 
      if(watchId){ 
        navigator.geolocation.clearWatch(watchId); 
      }
      if('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
    });
  </script>
</body>
</html>LoadAttractions) {
        btnLoadAttractions.addEventListener('click', ()=>{
          const base = userLocation || hotelLocation;
          currentCategory = 'attractions';
          document.querySelectorAll('.category-btn').forEach(b=>{
            if(b.dataset.category) b.classList.toggle('active', b.dataset.category==='attractions');
          });
          loadAttractionsFromOverpass(base.lat, base.lng, 5000);
        });
      }

      // Caricamento automatico iniziale (4km dall'hotel)
      loadAttractionsFromOverpass(hotelLocation.lat, hotelLocation.lng, 4000);

      // Modal chiudi
      const closeBtn = document.querySelector('.close');
      if(closeBtn) {
        closeBtn.addEventListener('click', ()=> {
          document.getElementById('navigationModal').style.display = 'none';
        });
      }
      
      window.addEventListener('click', (e)=>{
        const modal = document.getElementById('navigationModal');
        if(e.target === modal){ modal.style.display = 'none'; }
      });

      // PANNELLO AIRTAG
      const btnOpenFindMy = document.getElementById('btnOpenFindMy');
      const btnFindMyHelp = document.getElementById('btnFindMyHelp');
      const btnSaveTag = document.getElementById('btnSaveTag');
      const btnUseMyPos = document.getElementById('btnUseMyPos');
      const btnApple = document.getElementById('btnOpenAppleMaps');
      const btnGoogle = document.getElementById('btnOpenGoogleMaps');
      const tagName = document.getElementById('tagName');
      const tagLat  = document.getElementById('tagLat');
      const tagLng  = document.getElementById('tagLng');
      const tagInfo = document.getElementById('tagSavedInfo');

      const saved = loadFromStorage('savedTag');
      if(saved && tagName && tagLat && tagLng && tagInfo){
        tagName.value = saved.name || '';
        tagLat.value  = saved.lat  ?? '';
        tagLng.value  = saved.lng  ?? '';
        tagInfo.textContent = `Salvato: ${saved.name||'-'} (${saved.lat}, ${saved.lng})`;
      }

      if(btn
